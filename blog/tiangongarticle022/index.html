<!doctype html>
<html lang="zh-Hans" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">Windows hypervisor&amp;内核调试的几种常见/不常见方法 | 破壳漏洞挖掘平台</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://poc.qianxin.com/img/poc-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://poc.qianxin.com/img/poc-social-card.jpg"><meta data-rh="true" property="og:url" content="https://poc.qianxin.com/blog/tiangongarticle022"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Windows hypervisor&amp;内核调试的几种常见/不常见方法 | 破壳漏洞挖掘平台"><meta data-rh="true" name="description" content="一、前言"><meta data-rh="true" property="og:description" content="一、前言"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2024-03-20T00:00:00.000Z"><meta data-rh="true" property="article:tag" content="Windows,Hypervisor,Kernel,Debug"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://poc.qianxin.com/blog/tiangongarticle022"><link data-rh="true" rel="alternate" href="https://poc.qianxin.com/blog/tiangongarticle022" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://poc.qianxin.com/blog/tiangongarticle022" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://M80RFF4T9F-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="破壳漏洞挖掘平台 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="破壳漏洞挖掘平台 Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="破壳漏洞挖掘平台" href="/opensearch.xml">
<script src="https://www.clarity.ms/tag/k257lj4y58"></script>
<script src="https://hm.baidu.com/hm.js?bd805f6d9db85a795e91b7f0e7038239" async></script><link rel="stylesheet" href="/assets/css/styles.2596aafb.css">
<script src="/assets/js/runtime~main.41ff77e6.js" defer="defer"></script>
<script src="/assets/js/main.2e30026d.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://poc.qianxin.com" target="_blank" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/img/logo.svg" alt="破壳文档" class="nav-logo-class themedComponent_mlkZ themedComponent--light_NVdE" height="20" width="100"><img src="/img/logo.svg" alt="破壳文档" class="nav-logo-class themedComponent_mlkZ themedComponent--dark_xIcU" height="20" width="100"></div><b class="navbar__title text--truncate"></b></a><a class="navbar__item navbar__link tutorialClass" href="/">文档</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">博客</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/blog/tags">标签</a><a class="navbar__item navbar__link" href="/blog/archive">归档</a><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div><a href="https://poc.qianxin.com/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">破壳官网<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">所有文章</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle023">探索 DBus 跨进程消息传递中的安全风险</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/tiangongarticle022">Windows hypervisor&amp;内核调试的几种常见/不常见方法</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle021">FortiGate SSLVPN CVE-2024-21762漏洞利用分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle020">Ghidra脚本编写：从IR到反编译C</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle019">关于Linux内核条件竞争的探讨</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle018">WebAssembly安全研究总结</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle017">Terrapin 攻击分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle016">常见 PHP 源码保护与还原</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle015">Server as Client 漏洞模型</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle014">破壳分析：Linksys设备多个0-day漏洞</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle013">ESXi SLP漏洞复现</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle012">从传统到 AI 探讨 Webshell 检测攻防对抗</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle011">人与代码的桥梁-聊聊SAST</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle010">BMC 漏洞实例分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle009">CodeDom 漏洞模式与 SharePoint RCE</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle008">Datacon 2023 漏洞分析赛道赛题二官方题解</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle007">IoT 设备中的认证绕过漏洞分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle006">Exchange Server(CVE-2023-36439)远程代码执行漏洞分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle005">WAF防护绕过技巧分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle004">伪随机数问题浅析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle003">Windows内核竞态条件漏洞研究</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle002">Microsoft Hyper-V 虚拟 TPM 设备漏洞分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle001">CVE-2023-0179 Linux内核提权</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="https://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="一、前言"><header><h1 class="title_f1Hy" itemprop="headline">Windows hypervisor&amp;内核调试的几种常见/不常见方法</h1><div class="container_mt6G margin-vert--md"><time datetime="2024-03-20T00:00:00.000Z" itemprop="datePublished">2024年3月20日</time> · <!-- -->阅读需 17 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><img class="avatar__photo" src="https://tiangonglab.github.io/img/authors/hongzhenhao.jpg" alt="HongZhenhao" itemprop="image"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">HongZhenhao</span></div><small class="avatar__subtitle" itemprop="description">微软 MSRC 全球最具价值安全精英榜上榜者、BlackHat USA 世界黑帽大会 Speaker</small></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="一前言">一、前言<a href="#一前言" class="hash-link" aria-label="一、前言的直接链接" title="一、前言的直接链接">​</a></h2>
<p>本文主要介绍了使用调试器对Windows操作系统的内核层和hypervisor层进行双机调试的几种常见和不常见的方法。本文中使用的windbg调试器和其附带的实用调试工具都可以在windows sdk安装包中选择安装，windows sdk安装包官方的下载地址是: (<a href="https://developer.microsoft.com/en-us/windows/downloads/windows-sdk/" target="_blank" rel="noopener noreferrer">https://developer.microsoft.com/en-us/windows/downloads/windows-sdk/</a>)。 有  需要的读者可以自行下载并安装。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="二串口调试">二、串口调试<a href="#二串口调试" class="hash-link" aria-label="二、串口调试的直接链接" title="二、串口调试的直接链接">​</a></h2>
<p>首先我们先来介绍使用VMware虚拟机的情况下如何使用串口进行双机调试Windows内核及hypervisor。</p>
<p>在VMware的虚拟机设置中，添加&quot;串行端口&quot;设备后，并设置&quot;串行端口&quot;设备&quot;使用命名的管道&quot;，这里命名管道的名称可以自己设定，并分别选择&quot;该端是服务器&quot;和&quot;另一端是应用程序&quot;。如下图。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/249d116d-7ed1-4d73-8d3f-88944f4f37e0-4e8f5296fcda83d9abcc4190df61ce80.png" width="757" height="536" class="img_ev3q"></p>
<p>然后我们在被调试机中设置bcdedit参数，这里的目的是在系统启动过程中添加debug参数。如下图。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/d5cbd595-b3e3-40d2-9fe6-88a603327d3c-61d57874f2dcc940b4883fa1fe452638.png" width="1187" height="433" class="img_ev3q"></p>
<p>在被调试机中我们分别使用<code>bcdedit /dbgsettings serial debugport:1 baudrate:115200</code>和 <code>bcdedit /hypervisorsettings serial debugport:1 baudrate:115200</code>命令将Windows内核和hypervisor的调试参数设置为串口调试，串口为com1，波特率为115200。然后再使用<code>bcdedit /debug on</code>和<code>bcdedit /set hypervisordebug on</code>命令分别开启windows内核和hypervisor层的调试。最后设置dbgtransport为kdcom.dll，这里是为了保证被调试机在系统启动过程中使用串口进行调试。</p>
<p>现在被调试机已经整装待发做好了被调试的准备，但调试机还需要一些配置。因为我们需要同时调试windows的内核和hypervisor，而且在被调试机的参数中使用了同一个串口(com1)作为调试串  口，所以需要将不同层级的调试数据分发，根据不同层级将调试数据分发到不同的命名管道。我们可以使用<code>&amp; &#x27;C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\vmdemux.exe&#x27; -src pipe:pipename=com2</code>命令实现这一过程。</p>
<p>成功运行如上命令后，vmdemux进程会自动生成两个命名管道<code>\\.\pipe\Vm0</code>和<code>\\.\pipe\Vm1</code>。分别使用<code>&amp; &#x27;C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\windbg.exe&#x27; -k com:port=\\.\pipe\Vm0,pipe,resets=0,reconnect</code>和<code>&amp; &#x27;C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\windbg.exe&#x27; -k com:port=\\.\pipe\Vm1,pipe,resets=0,reconnect</code>命令打开windows hypervisor和内核的调试窗口。如下图。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/6f544518-18c6-4e42-b5a8-2011e7f86b89-1881d90d8218f6c2e05cb5f628690714.png" width="1005" height="616" class="img_ev3q"></p>
<p>下面我们介绍在双实体机的情况下如何使用串口进行双机调试。</p>
<p>双实体机进行串口调试需要被调试机的主板上保留9针串口，在10年前的电脑主板上，串口几乎是标准配置，然而随着主板厂商的革新，主板串口也渐渐退出历史舞台。</p>
<p>除了需要主板中保留串口外，还需要拥有一条串口调试线：Null-modem线，或者准备一条2，3交叉线。关于Null-modem调试线的线序如下图，感兴趣的读者可以自己手动做一条。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/4244fad8-fc4e-4545-ae2a-e81718ad4e1e-deea8a7203fd04c9d8061845c527360c.png" width="737" height="375" class="img_ev3q"></p>
<p>当使用串口调试线连接好调试端和被调试端，就可以使用 <code>&amp; &#x27;C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\vmdemux.exe&#x27; -src com:port=com2</code>命令将不同层级的数据分发到指定的层级，实现windows内核和hypervisor调试。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="三网络调试">三、网络调试<a href="#三网络调试" class="hash-link" aria-label="三、网络调试的直接链接" title="三、网络调试的直接链接">​</a></h2>
<p>Windows内核和hypervisor调试中，可以使用网络进行调试，不需要特殊的调试线连接两台机器，网络调试大大方便了双机调试中的准备过程。</p>
<p>首先，配置被调试机bcdedit配置，这里假设我们的调试机IP地址为192.168.111.1，调试hypervisor的端口为52201，调试windows内核的端口是52202。运行如下图的命令，设置网络调试，最后将dbgtransport设置为kdnet.dll。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/88ed3953-73ed-46a2-9dd9-995c3f3ee16e-73ab23bae5351a0220ca9fff27c33c34.png" width="1081" height="350" class="img_ev3q"></p>
<p>在图中可以看到，如果成功设置了网络调试后，会返回一个key，这个key是用来给调试机中的windbg连接被调试机使用的。这里这两个key要先记下来。</p>
<p>重启被调试机后，在调试机端使用<code>&amp; &quot;C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\windbg.exe&quot; -k net:port=52202,key=rq644uvs2p16.3ked98d1isrrq.hr7oioflkdt2.37b29ko4f79yj</code>和<code>&amp; &quot;C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\windbg.exe&quot; -k net:port=52201,key=2mko67of9fjih.233nl9lfzytc2.13u0ikbj37np1.3im74f7f672zj</code>命令打开windows内核和hypervisor调试窗口。如下图。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/93766d09-7f98-446e-8ae7-6b3296a528b6-dee83d210690c515ac9f7fbb0175491e.png" width="1043" height="623" class="img_ev3q"></p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="四usb-30调试">四、USB 3.0调试<a href="#四usb-30调试" class="hash-link" aria-label="四、USB 3.0调试的直接链接" title="四、USB 3.0调试的直接链接">​</a></h2>
<p>USB3.0接口也可以用作Windows内核调试的解决方案，在例如一些超薄笔记本电脑没有PCIE网卡的情况下，USB3.0便成了唯一的内核调试方案。</p>
<p>首先，需要将windows sdk套件中的usbview.exe这个程序复制到被调试机中，位置在：<code>C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\usbview.exe</code>。</p>
<p>在被调试机中打开usbview.exe，并找到USB3.0主控器，查看主控制器的信息，如下图。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/9bc217c6-7ca9-4de3-bcff-620cab81b8f6-12eccbbc8a3e250ddecdb1d59fef9d07.png" width="1078" height="535" class="img_ev3q"></p>
<p>如图中所示，图中选中的USB3.0主机控制器中的信息显示它的Debug Port Number不为None，这个主控器设备所在的位置在0.20.0这个位置上。Debug Port Number的信息不为None说明当前的USB3.0主控器拥有调试能力。</p>
<p>当确定好了主控制器位置后，还需要准备一条USB3.0调试线，根据USB3.0引脚定义可以得知，USB3.0的引脚1是供电，引脚2、3是USB2.0数据传输所用引脚。</p>
<p>所以根据微软给出的文档：（<a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/setting-up-a-usb-3-0-debug-cable-connection" target="_blank" rel="noopener noreferrer">https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/setting-up-a-usb-3-0-debug-cable-connection</a>），只需要先购买一条USB3.0 A/A公对公线，然后使用透明胶带将买来的线材的1、2、3号引脚绝缘屏蔽后就得到了一条USB3.0调试线。</p>
<p>随后将调试线的一端插入调试机USB3.0接口中，另一端插入到被调试机位置在0.20.0主控制器所在的端口中。如果这里无法确定哪个接口是所在主控制器所在端口的话，可以找一个U盘挨个尝试，在usbview.exe中观察，直到找到正确的端口。</p>
<p>下面我们在被调试机中配置bcdedit参数。使用如下三条命令开启USB3.0内核调试：</p>
<ul>
<li><code>bcdedit /debug on</code></li>
<li><code>bcdedit /dbgsettings usb targetname:ikun</code></li>
<li><code>bcdedit /set &quot;{dbgsettings}&quot; busparams 0.20.0</code></li>
</ul>
<p>这里的targetname可以取一个任意的名字；busparams要填入刚才找到的拥有USB3.0调试能力的USB3.0主控制器设备的位置。</p>
<p>重启被调试机后，使用如下命令打开Windows内核调试窗口：</p>
<p><code>&amp; &quot;C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\windbg.exe&quot; -k usb:targetname=ikun</code></p>
<p>读到这里有人肯定发现了这里的USB3.0调试好像并没有配置hypervisor层的调试，这个原因是因为微软只实现了Windows内核的USB3.0调试，Windows hypervisor层并不支持USB3.0调试。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="五vmware--ida调试">五、VMware + IDA调试<a href="#五vmware--ida调试" class="hash-link" aria-label="五、VMware + IDA调试的直接链接" title="五、VMware + IDA调试的直接链接">​</a></h2>
<p>VMware虚拟化软件也拥有强大的调试能力，我们可以借用VMware和IDA调试任意操作系统。</p>
<p>首先，在配置及安装完虚拟机后，打开虚拟机的配置文件，例如：Windows10_x64_hyperv.vmx。打开vmx文件后，在文件的末尾添加如下配置：</p>
<ul>
<li><code>debugStub.listen.guest64 = &quot;TRUE&quot;</code></li>
<li><code>debugStub.hideBreakpoints = &quot;TRUE&quot;</code></li>
<li><code>debugStub.listen.guest64.remote = &quot;TRUE&quot;</code></li>
<li><code>monitor.debugOnStartGuest64 = &quot;TRUE&quot;</code></li>
</ul>
<p>这四句配置是启用VMware的调试能力。</p>
<p>如果想在虚拟机中安装Hyper-V的话，还需要使用如下配置&quot;欺骗&quot;Windows系统让其觉得在一个可以安装Hyper-V的环境：</p>
<ul>
<li><code>hypervisor.cpuid.v0 = &quot;FALSE&quot;</code></li>
<li><code>mce.enable = &quot;TRUE&quot;</code></li>
<li><code>vhv.enable = &quot;TRUE&quot;</code></li>
</ul>
<p>修改完虚拟机配置后，启动虚拟机，此时的虚拟机会直接黑屏。这时打开IDA，在菜单中选择Debugger-&gt;Attach-&gt;Remote GDB Debugger，连接本地调试器，端口号为8864，如下图。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/6f0f479e-631b-40da-ae20-f92f65bdfea8-d49b6f7c23895d8b70c7c7242284b2d5.png" width="460" height="258" class="img_ev3q"></p>
<p>随后选择attach到目标进程选项后，会弹出IDA的调试窗口，此时IDA调试窗口显示当前RIP所在的位置，如下图。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/ca01fbf9-bfe2-46ce-b594-145f4bd16124-ec6e0c2c6d52deb6ffe33a4561cc9a6d.png" width="834" height="633" class="img_ev3q"></p>
<p>从图中可以看出，当前RIP的显示还是有问题，所以还需要添加内存的地址范围。打开菜单-&gt; Debugger→Manual memory regions，在Manual memory regions窗口中按下insert键，添加一个0~0xffffffffffffff00的地址范围。如下图。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/f9cc4401-bcf9-4415-bc9a-9b820893147f-0ef42c9b29a32ce469ad3568bf3360e5.png" width="540" height="447" class="img_ev3q"></p>
<p>此时按F9可以继续虚拟机的运行，如果需要调试就按下suspend进行调试。</p>
<p>IDA调试的优点是无需操作系统支持调试，而且虚拟机中无法检测调试器的存在，但是缺点是需要手动加载符号，调试时也不如windbg那样方便。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="六usb30-dci调试">六、USB3.0 DCI调试<a href="#六usb30-dci调试" class="hash-link" aria-label="六、USB3.0 DCI调试的直接链接" title="六、USB3.0 DCI调试的直接链接">​</a></h2>
<p>USB3.0 DCI调试听起来相对比较陌生，那么DCI是什么呢？DCI的全称是Direct Connect Interface，是Intel平台中提供的调试方法，这个技术主要实现了可以直接通过使用USB3.0端口来调试目标系统。说白了其实就是这个技术实现了直接通过一根USB3.0调试线调试被调试机，而且这种办法是JTAG调试，调试器会暂停CPU的运 行，是一种硬件级别的调试。</p>
<p>但Intel平台的调试支持并不是一个新技术，在过去Intel平台的硬件调试器是一个被大家叫做蓝盒子的调试器。这个调试器官方叫它Intel ITP(In Target Probe)，ITP要求在被调试机的主板制造时预留并安装ITP/XDP接口，并且如果你使用ITP进行调试必须要购买Intel的硬件调试器，也就是&quot;蓝盒子&quot;，官方购买的话大概要几千美元。所以在过去，Intel平台的硬件调试几乎是给Intel的合作伙伴使用的，用作硬/软件的开发和调试。</p>
<p>不过现在好日子来了，DCI在Intel Skylake系列之后的产品中，硬件上都支持DCI功能。也就是说，从Intel 6代的CPU和100系列芯片组之后的产品都会支持DCI功能。</p>
<p>但是坏消息是市面上大多数的主板都会默认关闭DCI这个功能，当然这是考虑到安全性问题。所以我们如果要启用这个功能，则需要修改主板的BIOS。那目前可以进行BIOS修改的主板有支持AMI BIOS的主板，例如华硕，微星等。</p>
<p>修改BIOS第一个办法可以使用AMIBCP工具修改BIOS镜像。例如这里通过修改BIOS镜像中的Setup →PCH-IO Configuration→DCI Enable(HDCIEN)选项，将其设置为Enabled。如下图。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/31cada81-34e1-4a0b-80ee-60d8528253b2-e7c99d8f55dabe6cb65fb8c56d9bf093.png" width="1048" height="726" class="img_ev3q"></p>
<p>随后保存镜像并刷BIOS。</p>
<p>第二种办法是使用UEFITOOL和IFRExtractor工具将BIOS固件导出IRF（UEFI Internal Form Representation）表。并在IRF表中寻找如下字段：</p>
<ul>
<li><code>Debug Interface</code></li>
<li><code>Debug Interface Lock</code></li>
<li><code>DCI enable(HDCIEN)</code></li>
</ul>
<p>记录下这些字段的<code>VarStoreInfo (VarOffset/VarName)</code>和<code>VarStore</code>的值，例如作者这里的信息如下图。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/b87bb62f-9acc-4679-8c8a-c14675d7ea6f-1b1369fc93006ab430ae052f84ab2aab.png" width="2359" height="639" class="img_ev3q"></p>
<p>可以看到这些字段的<code>VarStore</code>的值都是1，此时我们翻到IRF表的最前头，查找<code>VarStoreId</code>为1的条目。如下图。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/1d1f702c-8d37-477d-b346-63ab21c552f6-6a5f52c1138f937f77b91815477cb813.png" width="1225" height="62" class="img_ev3q"></p>
<p>可以看到这个是BIOS选项里的Setup条目。</p>
<p>下面重启被调试机，使用RU.exe工具修改BIOS，注意这里的RU工具版本可以选择旧一点的，新版的可能会有bug，笔者这里选择的RU版本是5.28.0397。</p>
<p>进入到RU的界面后，按下ALT+=进入BIOS界面，选择Setup条目，然后根据我们找的上文中那三个字段的VarOffset值来修改对应字段的配置。</p>
<p>这里我们需要将字段的配置修改至如下状态：</p>
<ul>
<li><code>Debug Interface</code>  →  1</li>
<li><code>Debug Interface Lock</code>  →  0</li>
<li><code>DCI enable(HDCIEN)</code>  →  1</li>
</ul>
<p>修改Debug Interface字段是为了启用硬件调试功能；Debug Interface Lock如果为enable会影响CPU的频率，如果不修改CPU可能会以0.x Ghz的频率运行；DCI enable是开启DCI功能的设置。</p>
<p>修改完成后，被调试机的准备工作就做完了。除此之外，我们还需要一条USB3.0调试线，具体的制作方法前文已经介绍了。</p>
<p>此时我们需要配置下调试端的环境，首先安装Intel DCI驱动，这个驱动是将被调试机的USB端口识别成<code>Intel USB Native Debug Class</code>设备。运行<code>Setup_x64_Intel_DCI_Driver_1.10.0.0.msi</code>并安装驱动，安装驱动完成并且连接好调试机和被调试机后，启动被调试端，调试端的设备管理器就会显示<code>Intel USB Native Debug Class Devices</code>设备，这说明DCI运行良好。如下图。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/31e70bd1-de17-44a7-9227-92afc0730759-7a69d786a98d52c3be97e6822bfe8f7d.png" width="748" height="522" class="img_ev3q"></p>
<p>配置好调试机环境后，使用我们提供的DCI调试相关的工具包，安装python库ipccli。使用<code>ipccli.baseaccess()</code>连接被调试机，再使用<code>ipc.status()</code>查看被调试机CPU状态。如下图。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/2e07bd4c-28ce-4207-b633-971a49556103-666af7544de3c507edc644564f3b0630.png" width="1011" height="483" class="img_ev3q"></p>
<p>也可以使用另外一种办法进行调试，首先到DCI调试相关的工具包的位置，然后打开<code>%DCI工具包%\windbg-ext\iajtagserver\intel64\</code>路径，以管理员权限运行<code>regsvr32.exe ExdiIpc.dll</code>。这一步骤是为了注册COM组件，可以让后面使用windbg exdi调试时唤起IntelExdiServer。</p>
<p>下面运行工具包中的<code>windbg_iajtag_console.bat</code>批处理连接上被调试机，并在批处理窗口中输入<code>windbg()</code>命令开始进行调试。如下图。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/e8580c77-f92e-4c59-9e60-96a05880bd44-1f1345cf06189cc4a02560c7e57f4162.png" width="1136" height="726" class="img_ev3q"></p>
<p>目前的windbg已经连接上了被调试机，但是还没有加载上NT内核以及其他内核模块的符号。我们可以使用<code>.scriptload reload_manual.js</code>加载查找内核模块地址的脚本，并使用<code>!reloadmod</code>查找并加载符号。如下图。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/71bb8cd0-fc5c-4b96-bf64-21fbb8eca12b-b3e873ad35ae8e818275eed09b930093.png" width="922" height="724" class="img_ev3q"></p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="七总结">七、总结<a href="#七总结" class="hash-link" aria-label="七、总结的直接链接" title="七、总结的直接链接">​</a></h2>
<p>优缺点分析如图所示。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/a54a7d2f-8b13-4eed-b08d-d14c97e6baf8-771f2b55e10cc2bd5889cd5379df8b8c.png" width="2565" height="1171" class="img_ev3q"></p>
<p>与其他的调试方式不同的是，DCI调试可以在ring-2层级上工作，也就是说可以进行SMM的调试，也可以调试比如Intel ME组件。</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/windows">Windows</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/hypervisor">Hypervisor</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/kernel">Kernel</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/debug">Debug</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/TianGongLab/poc_docs/tree/main/blog/2024-03-20-windows-hypervisor/index.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="博文分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/tiangongarticle023"><div class="pagination-nav__sublabel">较新一篇</div><div class="pagination-nav__label">探索 DBus 跨进程消息传递中的安全风险</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/tiangongarticle021"><div class="pagination-nav__sublabel">较旧一篇</div><div class="pagination-nav__label">FortiGate SSLVPN CVE-2024-21762漏洞利用分析</div></a></nav><div style="margin-top:20px"></div></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#一前言" class="table-of-contents__link toc-highlight">一、前言</a></li><li><a href="#二串口调试" class="table-of-contents__link toc-highlight">二、串口调试</a></li><li><a href="#三网络调试" class="table-of-contents__link toc-highlight">三、网络调试</a></li><li><a href="#四usb-30调试" class="table-of-contents__link toc-highlight">四、USB 3.0调试</a></li><li><a href="#五vmware--ida调试" class="table-of-contents__link toc-highlight">五、VMware + IDA调试</a></li><li><a href="#六usb30-dci调试" class="table-of-contents__link toc-highlight">六、USB3.0 DCI调试</a></li><li><a href="#七总结" class="table-of-contents__link toc-highlight">七、总结</a></li></ul></div></div></div></div></div></div>
</body>
</html>