<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>破壳漏洞挖掘平台文档系统 Blog</title>
        <link>https://poc.qianxin.com/blog</link>
        <description>破壳漏洞挖掘平台文档系统 Blog</description>
        <lastBuildDate>Wed, 08 Nov 2023 00:00:00 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>zh-Hans</language>
        <item>
            <title><![CDATA[WAF防护绕过技巧分析]]></title>
            <link>https://poc.qianxin.com/blog/tiangongarticle004</link>
            <guid>https://poc.qianxin.com/blog/tiangongarticle004</guid>
            <pubDate>Wed, 08 Nov 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[一、WAF介绍与分类]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="一waf介绍与分类">一、WAF介绍与分类<a href="#一waf介绍与分类" class="hash-link" aria-label="一、WAF介绍与分类的直接链接" title="一、WAF介绍与分类的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="一waf简介">（一）WAF简介<a href="#一waf简介" class="hash-link" aria-label="（一）WAF简介的直接链接" title="（一）WAF简介的直接链接">​</a></h3><p>Web应用防护系统（Web Application Firewall，网站应用级入侵防御系统），是通过执行一系列针对HTTP/HTTPS的安全策略来专门为Web应用提供保护的产品。</p><p>市场上的WAF产品有很多，像腾讯云，阿里云，长亭等，目前世界上常年排名第一的是以色列的 Imperva。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="二waf分类">（二）WAF分类<a href="#二waf分类" class="hash-link" aria-label="（二）WAF分类的直接链接" title="（二）WAF分类的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="规则实现">规则实现<a href="#规则实现" class="hash-link" aria-label="规则实现的直接链接" title="规则实现的直接链接">​</a></h4><p>语义分析引擎WAF，国内大多数都是正则引擎，此外还有机器学习引擎。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="部署方式">部署方式<a href="#部署方式" class="hash-link" aria-label="部署方式的直接链接" title="部署方式的直接链接">​</a></h4><p>网络层WAF、应用层WAF、云WAF</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="waf部署方式">WAF部署方式<a href="#waf部署方式" class="hash-link" aria-label="WAF部署方式的直接链接" title="WAF部署方式的直接链接">​</a></h4><p> <img loading="lazy" src="/assets/images/afec3247-2aa3-424f-8b89-eff0e861a82f-0f49f57fe4d7a2ad9dd40a8edfb8d4f7.png" width="1187" height="576" class="img_ev3q"></p><p>WAF大多是串联在这个链路中，起到一个阻断作用。就比如在Web Server和CGI之间的WAF，CGI这里特指PHP和ASP，像JSP一般就统一tomcat中间件了，就不需要CGI层了。</p><p>云部署一般先会起一个高防IP，然后用这个IP去连接WAF集群，一般来说都是从四层的流量解除七层的流量，然后再将正常的流量向后端转发，像这些企业A企业B可能在云上也可能不在。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="二网络层waf-bypass">二、网络层WAF Bypass<a href="#二网络层waf-bypass" class="hash-link" aria-label="二、网络层WAF Bypass的直接链接" title="二、网络层WAF Bypass的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="一分包分组">（一）分包分组<a href="#一分包分组" class="hash-link" aria-label="（一）分包分组的直接链接" title="（一）分包分组的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="通过调整mss控制分包">通过调整MSS控制分包<a href="#通过调整mss控制分包" class="hash-link" aria-label="通过调整MSS控制分包的直接链接" title="通过调整MSS控制分包的直接链接">​</a></h4><p>控制MSS去调整TCP分包的大小&nbsp;</p><p>单个TCP会话可能含有多个HTTP会话：比如TCP先建立一个三次握手，建立之后发送多个HTTP请求，并没有断开，一般的设备都会去很好的解析处理，但是有一些古老的设备只会去解析第一个，现在已经很少了。</p><p>单个TCP包发送多组HTTP报文（Pipeline技巧以及HTTP请求走私）：就是在DATA部分写多个http请求，有的设备就会认为第一个正常，那么后面的就类似于body部分，就会出现解析错误。</p><p>HTTP请求走私和Pipeline的区别就是请求走私利用不同的Content-Length引发歧义，比如下面这个，第一个content-length是包括了下面两个，或者content-length写一个1或者2，到底Web Server会取哪一个，需要针对不同的去研究，所以取值的解析差异，就会认为他是一整个或者是三个，利用这种方式就可以去迷惑WAF。</p><p> <img loading="lazy" src="/assets/images/923bdb52-c5db-47cf-805a-eaf649f480a8-2ec03c5091b46b7b031c3f11cc49b18d.png" width="458" height="296" class="img_ev3q"></p><p>在标准的HTTP走私里面，一般content-length和Transfer-Encoding只会采纳一个，大部分优先是 Transfer-Encoding: chunked，当然也有一些两个都支持，就会出现一些问题。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="chunked">chunked<a href="#chunked" class="hash-link" aria-label="chunked的直接链接" title="chunked的直接链接">​</a></h4><p>利用chunked切分，比如下面是个最简单的chunked，对关键字进行一个拆分。</p><p> <img loading="lazy" src="/assets/images/e7afbb3e-3a1f-47b7-a975-0b03679fbca2-42e0493a27449f24840d7a49b9e2656c.png" width="844" height="526" class="img_ev3q"></p><p>这里的5,4,3是以16进制写的，最后以0来结尾，如果是10个字符的话就要写A。</p><p>这种是只针对于网络层，应用层就不会出现这种问题，因为应用层是在完成chunked组包之后，才去解析，所以对应用层无效。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="三应用层waf-bypass">三、应用层WAF Bypass<a href="#三应用层waf-bypass" class="hash-link" aria-label="三、应用层WAF Bypass的直接链接" title="三、应用层WAF Bypass的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="一multipartform-data">（一）multipart/form-data<a href="#一multipartform-data" class="hash-link" aria-label="（一）multipart/form-data的直接链接" title="（一）multipart/form-data的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="理论知识">理论知识<a href="#理论知识" class="hash-link" aria-label="理论知识的直接链接" title="理论知识的直接链接">​</a></h4><p>HTTP协议POST请求，除了常规的application/x-www-form-urlencoded以外，还有multipart/form-data这种形式，主要是为了解决上传文件场景下文件内容较大且内置字符不可控的问题。multipart/form-data格式也是可以传递POST参数的。对于Nginx+PHP的架构，Nginx实际上是不负责</p><p>解析multipart/form-data的body部分的，而是交由PHP来解析，因此WAF所获取的内容就很有可能与后端的PHP发生不一致。</p><p>使用以下脚本来进行测试</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">?</span><span class="token plain">php</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo </span><span class="token function" style="color:#d73a49">file_get_contents</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"php://input"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">var_dump</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">$_POST</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">var_dump</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">$_FILES</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>正常POST请求如下：</p><p> <img loading="lazy" src="/assets/images/0ff64f40-166c-4e4f-9661-d7103bda20bb-b7e2248fd56fb1b87ebdea412bdb72a7.png" width="1390" height="506" class="img_ev3q"></p><p>change body encoding，如下：</p><p> <img loading="lazy" src="/assets/images/13abf27f-5ba5-40f2-80bd-6607cec89d87-6881265cb168b071669aa66a72a9b25a.png" width="1380" height="470" class="img_ev3q"></p><p>只有input不太一样，一个有f=1一个没有，参数并没有进入Files数组，而是进入了_POST数据。那么，何时是上传文件？何时是POST参数呢？这个关键点在于有没有一个完整的filename=。这9个字符是经过反复测试的，缺一个字符不可，替换一个字符也不可，在其中添加一个字符更不可。</p><p>加上filename=之后：</p><p> <img loading="lazy" src="/assets/images/464b3aa6-5de7-466d-9d43-0bf0f992f085-4f883c8b41eeb1c03f80d1947ac39a92.png" width="1474" height="772" class="img_ev3q"></p><p>可以看到这次并没有传给POST数组，而是传给了FILES数组变成了一个文件。</p><p>Bypass WAF的核心思想在于，一些WAF产品处于降低误报考虑，对用户上传文件的内容不做匹配，直接放行，比如一些压缩包图片之类的，在二进制流下面任意字符是不可控的，所以里面出现一些危险函数是很正常的。事实上，这些内容在绝大多数场景也无法引起攻击。所以让POST过去的数据去过那些规则，让FILES的只要符合白名单即可。</p><p>但关键问题在于，WAF能否准确有效识别出哪些内容是传给POST数组的，哪些传给_FILES数组？如果不能，那我们是否就可以想办法让WAF以为我们是在上传文件，而实际上却是在POST一个参数，这个参数可以是命令注入、SQL注入、SSRF等任意的一种攻击，这样就实现了通用WAF Bypass。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="基础案例">基础案例<a href="#基础案例" class="hash-link" aria-label="基础案例的直接链接" title="基础案例的直接链接">​</a></h4><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="0x00截断filename">0x00截断filename<a href="#0x00截断filename" class="hash-link" aria-label="0x00截断filename的直接链接" title="0x00截断filename的直接链接">​</a></h5><p> <img loading="lazy" src="/assets/images/91de88d7-b5a5-48c5-9895-8fe64f9b7773-cfbbaf263bd01169dc57e2f795f9903b.png" width="1416" height="520" class="img_ev3q">截断之后发现传给了POST数组</p><p>有的WAF在处理包之前会将00删掉，再去解析会产生差异，所以有的地方00是不能删的，所以会产生bypass</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="双写上传描述行">双写上传描述行<a href="#双写上传描述行" class="hash-link" aria-label="双写上传描述行的直接链接" title="双写上传描述行的直接链接">​</a></h5><p> <img loading="lazy" src="/assets/images/347cc9aa-3a0f-42dc-8b86-6292e93f1625-447811112057136561c09f7be1b73ade.png" width="1430" height="532" class="img_ev3q">双写后，一些WAF会取第二行，而实际PHP会获取第一行</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="双写整个part开头部分">双写整个part开头部分<a href="#双写整个part开头部分" class="hash-link" aria-label="双写整个part开头部分的直接链接" title="双写整个part开头部分的直接链接">​</a></h5><p> <img loading="lazy" src="/assets/images/7b67dc36-477b-4e81-86fd-02e8c9cf758c-e8915ee38e2ef9ad3b20e1b744bbfa05.png" width="1418" height="548" class="img_ev3q">可以看到取的还是第一行，只不过会将第二部分全部当成f的值，这里做SQL注入比较麻烦，需要将前面全都闭合掉，但是命令注入就很简单，直接将1给改成payload即可优先执行。</p><p>这里可以延伸出构造一个假的part</p><p> <img loading="lazy" src="/assets/images/7a946a53-2a90-4765-bcc6-47db092d2f92-62ca30491687edab20b82b97f87b291f.png" width="1420" height="460" class="img_ev3q"></p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="构造假的part">构造假的part<a href="#构造假的part" class="hash-link" aria-label="构造假的part的直接链接" title="构造假的part的直接链接">​</a></h5><p> <img loading="lazy" src="/assets/images/dfd5f278-a367-45e0-b4f0-73ffbc6f6cdc-19759d63b1832e8ece511406f45c2bd5.png" width="1404" height="456" class="img_ev3q">和上一个类似，少了一个换行，这样原本干扰的部分就不会取了</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="双写boundary">双写boundary<a href="#双写boundary" class="hash-link" aria-label="双写boundary的直接链接" title="双写boundary的直接链接">​</a></h5><p> <img loading="lazy" src="/assets/images/9bbf5693-9c08-44e9-8b62-cf728ab8625a-b361a54b922bd3c040f107be41cbbf77.png" width="1408" height="575" class="img_ev3q"></p><p>可以看到是以a为主</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="双写content-type">双写Content-Type<a href="#双写content-type" class="hash-link" aria-label="双写Content-Type的直接链接" title="双写Content-Type的直接链接">​</a></h5><p> <img loading="lazy" src="/assets/images/03ac2393-b053-4fcf-9ebd-26d3202a10bc-28aae62d58034d25f715665a17ac9a41.png" width="1396" height="578" class="img_ev3q"></p><p>还是以a为主</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="空boundary">空boundary<a href="#空boundary" class="hash-link" aria-label="空boundary的直接链接" title="空boundary的直接链接">​</a></h5><p> <img loading="lazy" src="/assets/images/28361d93-cd48-4e8e-9bc2-db0a5ddac9ba-dddea1d6ce12c1b0cdffaca8e767aaae.png" width="1398" height="566" class="img_ev3q"></p><p>有些WAF可能会认为boundary是；但是实际上boundary是空的</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="空格boundary">空格boundary<a href="#空格boundary" class="hash-link" aria-label="空格boundary的直接链接" title="空格boundary的直接链接">​</a></h5><p> <img loading="lazy" src="/assets/images/81633a33-e191-48ab-bd76-dbcd4d4029b9-076bc31df477df34a43e756e601e9954.png" width="1408" height="548" class="img_ev3q"></p><p>有些WAF会把空格给去掉</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="boundary中的逗号">boundary中的逗号<a href="#boundary中的逗号" class="hash-link" aria-label="boundary中的逗号的直接链接" title="boundary中的逗号的直接链接">​</a></h5><p> <img loading="lazy" src="/assets/images/69566fca-f2b8-4f8c-b02e-aa397f5c1d31-1752aa4331e8c7f9a2452f20690fb124.png" width="1404" height="560" class="img_ev3q">boundary遇到逗号就结束了，所以取到的是a</p><p>同理，如果是 <strong>==,; ==</strong>，如下：</p><p> <img loading="lazy" src="/assets/images/c426ea3e-afab-43a2-a111-98fc8a1bd03c-2bf25d8f0bd10e2b7ddfc4d745270b4a.png" width="1400" height="558" class="img_ev3q"></p><p>此时boundary还是空</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="进阶案例">进阶案例<a href="#进阶案例" class="hash-link" aria-label="进阶案例的直接链接" title="进阶案例的直接链接">​</a></h4><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="0x00进阶">0x00进阶<a href="#0x00进阶" class="hash-link" aria-label="0x00进阶的直接链接" title="0x00进阶的直接链接">​</a></h5><p> <img loading="lazy" src="/assets/images/213c19e5-9305-4358-9b98-118904401e74-8c158fed8bf92ea5fdbc43ce4818666c.png" width="1408" height="766" class="img_ev3q"></p><p>如果是这样双写，其实是以第一行为主的，这样就是上传文件。但如果我们在适当的地方加入0x00、空格和 <!-- -->\<!-- -->t ， 就会破坏第一行，让PHP反以第二行为主：</p><p> <img loading="lazy" src="/assets/images/ce29712c-f8d9-4016-8df7-a217c210d2ac-251453f1365d99308f5102090107efdb.png" width="1396" height="452" class="img_ev3q"></p><p>如上图，随便在这三个地方加上空格，都会以第二行为主，这样防御是比较困难的，将其替换为0x00和0x20与之同理， 可自行测试</p><p>此外，在filename前面，和参数名f后面，加上0x00也是可以绕过的</p><p> <img loading="lazy" src="/assets/images/795dc3e3-2abf-47a4-92fb-9c2e537617e2-14a3f0315a5ccbcbad1896f8e5122a7e.png" width="1404" height="442" class="img_ev3q"></p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="boundary进阶">boundary进阶<a href="#boundary进阶" class="hash-link" aria-label="boundary进阶的直接链接" title="boundary进阶的直接链接">​</a></h5><p>boundary的名称是可以前后加入任意内容的，WAF如果严格按boundary去取，就可以绕过</p><p> <img loading="lazy" src="/assets/images/71481c18-21e4-47cb-b5eb-458722cd4a7e-cca1255205472792c978bfac99927dd8.png" width="1396" height="560" class="img_ev3q"></p><p>如何取boundary也是一个问题，如下：</p><p> <img loading="lazy" src="/assets/images/76435c2b-f86f-4547-a34b-a73460c64499-fcfdf0767d298ee35d2d76d09b59d2e3.png" width="1400" height="526" class="img_ev3q"></p><p>这里取boundary=b为boundary</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="单双引号混合进阶">单双引号混合进阶<a href="#单双引号混合进阶" class="hash-link" aria-label="单双引号混合进阶的直接链接" title="单双引号混合进阶的直接链接">​</a></h5><p>需要考虑的问题是，Content-Disposition中的字段使用单引号还是双引号</p><p> <img loading="lazy" src="/assets/images/42991e56-19ae-4e5b-89bc-642e023077d3-9dca53023f3f38173b4a43eee7571b3a.png" width="1398" height="536" class="img_ev3q"></p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="urlencoded伪装成为multipart">urlencoded伪装成为multipart<a href="#urlencoded伪装成为multipart" class="hash-link" aria-label="urlencoded伪装成为multipart的直接链接" title="urlencoded伪装成为multipart的直接链接">​</a></h5><p>实际上是urlencoded，但是伪装成了multipart，通过&amp;来截取前后装饰部分，保留id参数的完整性。理论上multipart/form-data 下的内容不进行urldecoded，一些WAF也正是这样设计的，这样做本没有问题，但是如果是urlencoded格式的内容，不进行url解码就会引入%0a这样字符，而这样的字符不解码是可以直接绕过防护规则的，从而导致了绕过。</p><p> <img loading="lazy" src="/assets/images/425f3c95-67ee-4e0c-80b6-e173042efd9d-170c006a4440e2868bb6d1ce5173eca9.png" width="1400" height="676" class="img_ev3q"> <img loading="lazy" src="D:%5C%E5%AD%A6%E4%B9%A0%5C%E5%B8%B8%E5%A4%87%5C%E5%9B%BE%5Cimage-20230611171427846.png" class="img_ev3q"></p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="skip_upload">skip_upload<a href="#skip_upload" class="hash-link" aria-label="skip_upload的直接链接" title="skip_upload的直接链接">​</a></h5><p>在php源码 rfc1867.c line 909</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/* If file_uploads=off, skip the file part */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!PG(file_uploads)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                skip_upload = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (upload_cnt &lt;= 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                skip_upload = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                sapi_module.sapi_error(E_WARNING, "Maximum number of allowable file uploads has been exceeded");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Maximum number of allowable file uploads has been exceeded ，如何达到Maximum？ 发现在php 5.2.12和以上的版本，有一个隐藏的文件上传限制是在php.ini里没有的，就是这个max_file_uploads的设定，该默认值是20, 在php 5.2.17的版本中该值已不再隐藏。文件上传限制最大默认设为20，所以一次上传最大就是20个文档，所以超出20个就会出错了。</p><p>如下：</p><p> <img loading="lazy" src="/assets/images/29f41f21-6fbc-40ba-9efd-7b699fac9828-95d82360b2564ff4d805bb3d2dbd248b.png" width="1394" height="790" class="img_ev3q"></p><p>拼接了从a-t这20个part，实际上就填满了Maximum，导致最后一个upload无法生效，就只能从FILES转化为POST了</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="二其他技巧">（二）其他技巧<a href="#二其他技巧" class="hash-link" aria-label="（二）其他技巧的直接链接" title="（二）其他技巧的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="host替换">Host替换<a href="#host替换" class="hash-link" aria-label="Host替换的直接链接" title="Host替换的直接链接">​</a></h4><p>host如果是一个域名，可以在最后面加一个点 ==.== ，大多数情况下表示的还是当前域名，比如之前阿里云，防护的话是用过域名控制的，传过来一个域名会先看一下有没有受到保护，假如原来的域名受到了保护，但是加了一个点，就不在名单内了，就会被认为没有开WAF</p><p> <img loading="lazy" src="/assets/images/6ec1b459-5ec9-4418-8800-6fe12111677e-30f0e6ed3e484507a5b9787a8c632b9b.png" width="1208" height="726" class="img_ev3q"></p><p>还可以把Host的IP转为16进制</p><p> <img loading="lazy" src="/assets/images/0317a668-73cf-4061-aad9-f8b28a61480f-fb4126a60ade24eebec6c80e90ac6e27.png" width="1394" height="702" class="img_ev3q"></p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="url与替换">URL#与../替换<a href="#url与替换" class="hash-link" aria-label="URL#与../替换的直接链接" title="URL#与../替换的直接链接">​</a></h4><p>如果有时候加上#引发歧义的话，可以使用../跳出</p><p>如果#不可以的话，可以尝试?#</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="http参数污染">HTTP参数污染<a href="#http参数污染" class="hash-link" aria-label="HTTP参数污染的直接链接" title="HTTP参数污染的直接链接">​</a></h4><p>比如双参数</p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">?id = 1 &amp; id = and 1=1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>有些架构会将两个拼接在一起，单独任何一个都没有问题，拼在一起就有问题了，这种的话要看后端的业务逻辑</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="http09">HTTP/0.9<a href="#http09" class="hash-link" aria-label="HTTP/0.9的直接链接" title="HTTP/0.9的直接链接">​</a></h4><p>在HTTP/0.9中是没有响应头的</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="利用chuncked构造content-length为0">利用chuncked构造content-length为0<a href="#利用chuncked构造content-length为0" class="hash-link" aria-label="利用chuncked构造content-length为0的直接链接" title="利用chuncked构造content-length为0的直接链接">​</a></h4><div class="language-HTTP codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-HTTP codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Content-Length:0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Transfer-Encoding: chuncked</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>两个同时出现一般会报错，如果像上面这样的话，body部分可以随便写，不会被过滤</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="加入中文字符">加入中文字符<a href="#加入中文字符" class="hash-link" aria-label="加入中文字符的直接链接" title="加入中文字符的直接链接">​</a></h4><p>针对于特殊框架，会被替换为空</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="http方法构造">HTTP方法构造<a href="#http方法构造" class="hash-link" aria-label="HTTP方法构造的直接链接" title="HTTP方法构造的直接链接">​</a></h4><p>使用一些存在的，常用HEAD</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="添加xff头">添加XFF头<a href="#添加xff头" class="hash-link" aria-label="添加XFF头的直接链接" title="添加XFF头的直接链接">​</a></h4><p>127<!-- -->.<!-- -->0.0.1或者localhost</p><p>理论可行，需要看网络架构</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="四总结">四、总结<a href="#四总结" class="hash-link" aria-label="四、总结的直接链接" title="四、总结的直接链接">​</a></h2><p>以上这些技巧是根据原理、实践所得，参考了网上部分文章总结所得，WAF绕过并没有固定的模式，在黑盒情况下甚至你可以将所有技巧同时运用以达到目的，总之，要在不断的尝试中去绕过，然后再通过“控制变量”法去探测到底是哪一种方法奏效，以达到“通杀”的目标。</p>]]></content:encoded>
            <category>WAF</category>
        </item>
        <item>
            <title><![CDATA[伪随机数问题浅析]]></title>
            <link>https://poc.qianxin.com/blog/tiangongarticle004</link>
            <guid>https://poc.qianxin.com/blog/tiangongarticle004</guid>
            <pubDate>Fri, 03 Nov 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[0x01 前言]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="一waf介绍与分类">一、WAF介绍与分类<a href="#一waf介绍与分类" class="hash-link" aria-label="一、WAF介绍与分类的直接链接" title="一、WAF介绍与分类的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="一waf简介">（一）WAF简介<a href="#一waf简介" class="hash-link" aria-label="（一）WAF简介的直接链接" title="（一）WAF简介的直接链接">​</a></h3><p>Web应用防护系统（Web Application Firewall，网站应用级入侵防御系统），是通过执行一系列针对HTTP/HTTPS的安全策略来专门为Web应用提供保护的产品。</p><p>市场上的WAF产品有很多，像腾讯云，阿里云，长亭等，目前世界上常年排名第一的是以色列的 Imperva。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="二waf分类">（二）WAF分类<a href="#二waf分类" class="hash-link" aria-label="（二）WAF分类的直接链接" title="（二）WAF分类的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="规则实现">规则实现<a href="#规则实现" class="hash-link" aria-label="规则实现的直接链接" title="规则实现的直接链接">​</a></h4><p>语义分析引擎WAF，国内大多数都是正则引擎，此外还有机器学习引擎。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="部署方式">部署方式<a href="#部署方式" class="hash-link" aria-label="部署方式的直接链接" title="部署方式的直接链接">​</a></h4><p>网络层WAF、应用层WAF、云WAF</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="waf部署方式">WAF部署方式<a href="#waf部署方式" class="hash-link" aria-label="WAF部署方式的直接链接" title="WAF部署方式的直接链接">​</a></h4><p> <img loading="lazy" src="/assets/images/afec3247-2aa3-424f-8b89-eff0e861a82f-0f49f57fe4d7a2ad9dd40a8edfb8d4f7.png" width="1187" height="576" class="img_ev3q"></p><p>WAF大多是串联在这个链路中，起到一个阻断作用。就比如在Web Server和CGI之间的WAF，CGI这里特指PHP和ASP，像JSP一般就统一tomcat中间件了，就不需要CGI层了。</p><p>云部署一般先会起一个高防IP，然后用这个IP去连接WAF集群，一般来说都是从四层的流量解除七层的流量，然后再将正常的流量向后端转发，像这些企业A企业B可能在云上也可能不在。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="二网络层waf-bypass">二、网络层WAF Bypass<a href="#二网络层waf-bypass" class="hash-link" aria-label="二、网络层WAF Bypass的直接链接" title="二、网络层WAF Bypass的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="一分包分组">（一）分包分组<a href="#一分包分组" class="hash-link" aria-label="（一）分包分组的直接链接" title="（一）分包分组的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="通过调整mss控制分包">通过调整MSS控制分包<a href="#通过调整mss控制分包" class="hash-link" aria-label="通过调整MSS控制分包的直接链接" title="通过调整MSS控制分包的直接链接">​</a></h4><p>控制MSS去调整TCP分包的大小&nbsp;</p><p>单个TCP会话可能含有多个HTTP会话：比如TCP先建立一个三次握手，建立之后发送多个HTTP请求，并没有断开，一般的设备都会去很好的解析处理，但是有一些古老的设备只会去解析第一个，现在已经很少了。</p><p>单个TCP包发送多组HTTP报文（Pipeline技巧以及HTTP请求走私）：就是在DATA部分写多个http请求，有的设备就会认为第一个正常，那么后面的就类似于body部分，就会出现解析错误。</p><p>HTTP请求走私和Pipeline的区别就是请求走私利用不同的Content-Length引发歧义，比如下面这个，第一个content-length是包括了下面两个，或者content-length写一个1或者2，到底Web Server会取哪一个，需要针对不同的去研究，所以取值的解析差异，就会认为他是一整个或者是三个，利用这种方式就可以去迷惑WAF。</p><p> <img loading="lazy" src="/assets/images/923bdb52-c5db-47cf-805a-eaf649f480a8-2ec03c5091b46b7b031c3f11cc49b18d.png" width="458" height="296" class="img_ev3q"></p><p>在标准的HTTP走私里面，一般content-length和Transfer-Encoding只会采纳一个，大部分优先是 Transfer-Encoding: chunked，当然也有一些两个都支持，就会出现一些问题。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="chunked">chunked<a href="#chunked" class="hash-link" aria-label="chunked的直接链接" title="chunked的直接链接">​</a></h4><p>利用chunked切分，比如下面是个最简单的chunked，对关键字进行一个拆分。</p><p> <img loading="lazy" src="/assets/images/e7afbb3e-3a1f-47b7-a975-0b03679fbca2-42e0493a27449f24840d7a49b9e2656c.png" width="844" height="526" class="img_ev3q"></p><p>这里的5,4,3是以16进制写的，最后以0来结尾，如果是10个字符的话就要写A。</p><p>这种是只针对于网络层，应用层就不会出现这种问题，因为应用层是在完成chunked组包之后，才去解析，所以对应用层无效。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="三应用层waf-bypass">三、应用层WAF Bypass<a href="#三应用层waf-bypass" class="hash-link" aria-label="三、应用层WAF Bypass的直接链接" title="三、应用层WAF Bypass的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="一multipartform-data">（一）multipart/form-data<a href="#一multipartform-data" class="hash-link" aria-label="（一）multipart/form-data的直接链接" title="（一）multipart/form-data的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="理论知识">理论知识<a href="#理论知识" class="hash-link" aria-label="理论知识的直接链接" title="理论知识的直接链接">​</a></h4><p>HTTP协议POST请求，除了常规的application/x-www-form-urlencoded以外，还有multipart/form-data这种形式，主要是为了解决上传文件场景下文件内容较大且内置字符不可控的问题。multipart/form-data格式也是可以传递POST参数的。对于Nginx+PHP的架构，Nginx实际上是不负责</p><p>解析multipart/form-data的body部分的，而是交由PHP来解析，因此WAF所获取的内容就很有可能与后端的PHP发生不一致。</p><p>使用以下脚本来进行测试</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">?</span><span class="token plain">php</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo </span><span class="token function" style="color:#d73a49">file_get_contents</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"php://input"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">var_dump</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">$_POST</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">var_dump</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">$_FILES</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">?</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>正常POST请求如下：</p><p> <img loading="lazy" src="/assets/images/0ff64f40-166c-4e4f-9661-d7103bda20bb-b7e2248fd56fb1b87ebdea412bdb72a7.png" width="1390" height="506" class="img_ev3q"></p><p>change body encoding，如下：</p><p> <img loading="lazy" src="/assets/images/13abf27f-5ba5-40f2-80bd-6607cec89d87-6881265cb168b071669aa66a72a9b25a.png" width="1380" height="470" class="img_ev3q"></p><p>只有input不太一样，一个有f=1一个没有，参数并没有进入Files数组，而是进入了_POST数据。那么，何时是上传文件？何时是POST参数呢？这个关键点在于有没有一个完整的filename=。这9个字符是经过反复测试的，缺一个字符不可，替换一个字符也不可，在其中添加一个字符更不可。</p><p>加上filename=之后：</p><p> <img loading="lazy" src="/assets/images/464b3aa6-5de7-466d-9d43-0bf0f992f085-4f883c8b41eeb1c03f80d1947ac39a92.png" width="1474" height="772" class="img_ev3q"></p><p>可以看到这次并没有传给POST数组，而是传给了FILES数组变成了一个文件。</p><p>Bypass WAF的核心思想在于，一些WAF产品处于降低误报考虑，对用户上传文件的内容不做匹配，直接放行，比如一些压缩包图片之类的，在二进制流下面任意字符是不可控的，所以里面出现一些危险函数是很正常的。事实上，这些内容在绝大多数场景也无法引起攻击。所以让POST过去的数据去过那些规则，让FILES的只要符合白名单即可。</p><p>但关键问题在于，WAF能否准确有效识别出哪些内容是传给POST数组的，哪些传给_FILES数组？如果不能，那我们是否就可以想办法让WAF以为我们是在上传文件，而实际上却是在POST一个参数，这个参数可以是命令注入、SQL注入、SSRF等任意的一种攻击，这样就实现了通用WAF Bypass。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="基础案例">基础案例<a href="#基础案例" class="hash-link" aria-label="基础案例的直接链接" title="基础案例的直接链接">​</a></h4><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="0x00截断filename">0x00截断filename<a href="#0x00截断filename" class="hash-link" aria-label="0x00截断filename的直接链接" title="0x00截断filename的直接链接">​</a></h5><p> <img loading="lazy" src="/assets/images/91de88d7-b5a5-48c5-9895-8fe64f9b7773-cfbbaf263bd01169dc57e2f795f9903b.png" width="1416" height="520" class="img_ev3q">截断之后发现传给了POST数组</p><p>有的WAF在处理包之前会将00删掉，再去解析会产生差异，所以有的地方00是不能删的，所以会产生bypass</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="双写上传描述行">双写上传描述行<a href="#双写上传描述行" class="hash-link" aria-label="双写上传描述行的直接链接" title="双写上传描述行的直接链接">​</a></h5><p> <img loading="lazy" src="/assets/images/347cc9aa-3a0f-42dc-8b86-6292e93f1625-447811112057136561c09f7be1b73ade.png" width="1430" height="532" class="img_ev3q">双写后，一些WAF会取第二行，而实际PHP会获取第一行</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="双写整个part开头部分">双写整个part开头部分<a href="#双写整个part开头部分" class="hash-link" aria-label="双写整个part开头部分的直接链接" title="双写整个part开头部分的直接链接">​</a></h5><p> <img loading="lazy" src="/assets/images/7b67dc36-477b-4e81-86fd-02e8c9cf758c-e8915ee38e2ef9ad3b20e1b744bbfa05.png" width="1418" height="548" class="img_ev3q">可以看到取的还是第一行，只不过会将第二部分全部当成f的值，这里做SQL注入比较麻烦，需要将前面全都闭合掉，但是命令注入就很简单，直接将1给改成payload即可优先执行。</p><p>这里可以延伸出构造一个假的part</p><p> <img loading="lazy" src="/assets/images/7a946a53-2a90-4765-bcc6-47db092d2f92-62ca30491687edab20b82b97f87b291f.png" width="1420" height="460" class="img_ev3q"></p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="构造假的part">构造假的part<a href="#构造假的part" class="hash-link" aria-label="构造假的part的直接链接" title="构造假的part的直接链接">​</a></h5><p> <img loading="lazy" src="/assets/images/dfd5f278-a367-45e0-b4f0-73ffbc6f6cdc-19759d63b1832e8ece511406f45c2bd5.png" width="1404" height="456" class="img_ev3q">和上一个类似，少了一个换行，这样原本干扰的部分就不会取了</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="双写boundary">双写boundary<a href="#双写boundary" class="hash-link" aria-label="双写boundary的直接链接" title="双写boundary的直接链接">​</a></h5><p> <img loading="lazy" src="/assets/images/9bbf5693-9c08-44e9-8b62-cf728ab8625a-b361a54b922bd3c040f107be41cbbf77.png" width="1408" height="575" class="img_ev3q"></p><p>可以看到是以a为主</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="双写content-type">双写Content-Type<a href="#双写content-type" class="hash-link" aria-label="双写Content-Type的直接链接" title="双写Content-Type的直接链接">​</a></h5><p> <img loading="lazy" src="/assets/images/03ac2393-b053-4fcf-9ebd-26d3202a10bc-28aae62d58034d25f715665a17ac9a41.png" width="1396" height="578" class="img_ev3q"></p><p>还是以a为主</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="空boundary">空boundary<a href="#空boundary" class="hash-link" aria-label="空boundary的直接链接" title="空boundary的直接链接">​</a></h5><p> <img loading="lazy" src="/assets/images/28361d93-cd48-4e8e-9bc2-db0a5ddac9ba-dddea1d6ce12c1b0cdffaca8e767aaae.png" width="1398" height="566" class="img_ev3q"></p><p>有些WAF可能会认为boundary是；但是实际上boundary是空的</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="空格boundary">空格boundary<a href="#空格boundary" class="hash-link" aria-label="空格boundary的直接链接" title="空格boundary的直接链接">​</a></h5><p> <img loading="lazy" src="/assets/images/81633a33-e191-48ab-bd76-dbcd4d4029b9-076bc31df477df34a43e756e601e9954.png" width="1408" height="548" class="img_ev3q"></p><p>有些WAF会把空格给去掉</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="boundary中的逗号">boundary中的逗号<a href="#boundary中的逗号" class="hash-link" aria-label="boundary中的逗号的直接链接" title="boundary中的逗号的直接链接">​</a></h5><p> <img loading="lazy" src="/assets/images/69566fca-f2b8-4f8c-b02e-aa397f5c1d31-1752aa4331e8c7f9a2452f20690fb124.png" width="1404" height="560" class="img_ev3q">boundary遇到逗号就结束了，所以取到的是a</p><p>同理，如果是 <strong>==,; ==</strong>，如下：</p><p> <img loading="lazy" src="/assets/images/c426ea3e-afab-43a2-a111-98fc8a1bd03c-2bf25d8f0bd10e2b7ddfc4d745270b4a.png" width="1400" height="558" class="img_ev3q"></p><p>此时boundary还是空</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="进阶案例">进阶案例<a href="#进阶案例" class="hash-link" aria-label="进阶案例的直接链接" title="进阶案例的直接链接">​</a></h4><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="0x00进阶">0x00进阶<a href="#0x00进阶" class="hash-link" aria-label="0x00进阶的直接链接" title="0x00进阶的直接链接">​</a></h5><p> <img loading="lazy" src="/assets/images/213c19e5-9305-4358-9b98-118904401e74-8c158fed8bf92ea5fdbc43ce4818666c.png" width="1408" height="766" class="img_ev3q"></p><p>如果是这样双写，其实是以第一行为主的，这样就是上传文件。但如果我们在适当的地方加入0x00、空格和 <!-- -->\<!-- -->t ， 就会破坏第一行，让PHP反以第二行为主：</p><p> <img loading="lazy" src="/assets/images/ce29712c-f8d9-4016-8df7-a217c210d2ac-251453f1365d99308f5102090107efdb.png" width="1396" height="452" class="img_ev3q"></p><p>如上图，随便在这三个地方加上空格，都会以第二行为主，这样防御是比较困难的，将其替换为0x00和0x20与之同理， 可自行测试</p><p>此外，在filename前面，和参数名f后面，加上0x00也是可以绕过的</p><p> <img loading="lazy" src="/assets/images/795dc3e3-2abf-47a4-92fb-9c2e537617e2-14a3f0315a5ccbcbad1896f8e5122a7e.png" width="1404" height="442" class="img_ev3q"></p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="boundary进阶">boundary进阶<a href="#boundary进阶" class="hash-link" aria-label="boundary进阶的直接链接" title="boundary进阶的直接链接">​</a></h5><p>boundary的名称是可以前后加入任意内容的，WAF如果严格按boundary去取，就可以绕过</p><p> <img loading="lazy" src="/assets/images/71481c18-21e4-47cb-b5eb-458722cd4a7e-cca1255205472792c978bfac99927dd8.png" width="1396" height="560" class="img_ev3q"></p><p>如何取boundary也是一个问题，如下：</p><p> <img loading="lazy" src="/assets/images/76435c2b-f86f-4547-a34b-a73460c64499-fcfdf0767d298ee35d2d76d09b59d2e3.png" width="1400" height="526" class="img_ev3q"></p><p>这里取boundary=b为boundary</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="单双引号混合进阶">单双引号混合进阶<a href="#单双引号混合进阶" class="hash-link" aria-label="单双引号混合进阶的直接链接" title="单双引号混合进阶的直接链接">​</a></h5><p>需要考虑的问题是，Content-Disposition中的字段使用单引号还是双引号</p><p> <img loading="lazy" src="/assets/images/42991e56-19ae-4e5b-89bc-642e023077d3-9dca53023f3f38173b4a43eee7571b3a.png" width="1398" height="536" class="img_ev3q"></p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="urlencoded伪装成为multipart">urlencoded伪装成为multipart<a href="#urlencoded伪装成为multipart" class="hash-link" aria-label="urlencoded伪装成为multipart的直接链接" title="urlencoded伪装成为multipart的直接链接">​</a></h5><p>实际上是urlencoded，但是伪装成了multipart，通过&amp;来截取前后装饰部分，保留id参数的完整性。理论上multipart/form-data 下的内容不进行urldecoded，一些WAF也正是这样设计的，这样做本没有问题，但是如果是urlencoded格式的内容，不进行url解码就会引入%0a这样字符，而这样的字符不解码是可以直接绕过防护规则的，从而导致了绕过。</p><p> <img loading="lazy" src="/assets/images/425f3c95-67ee-4e0c-80b6-e173042efd9d-170c006a4440e2868bb6d1ce5173eca9.png" width="1400" height="676" class="img_ev3q"> <img loading="lazy" src="D:%5C%E5%AD%A6%E4%B9%A0%5C%E5%B8%B8%E5%A4%87%5C%E5%9B%BE%5Cimage-20230611171427846.png" class="img_ev3q"></p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="skip_upload">skip_upload<a href="#skip_upload" class="hash-link" aria-label="skip_upload的直接链接" title="skip_upload的直接链接">​</a></h5><p>在php源码 rfc1867.c line 909</p><div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/* If file_uploads=off, skip the file part */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!PG(file_uploads)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                skip_upload = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (upload_cnt &lt;= 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                skip_upload = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                sapi_module.sapi_error(E_WARNING, "Maximum number of allowable file uploads has been exceeded");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Maximum number of allowable file uploads has been exceeded ，如何达到Maximum？ 发现在php 5.2.12和以上的版本，有一个隐藏的文件上传限制是在php.ini里没有的，就是这个max_file_uploads的设定，该默认值是20, 在php 5.2.17的版本中该值已不再隐藏。文件上传限制最大默认设为20，所以一次上传最大就是20个文档，所以超出20个就会出错了。</p><p>如下：</p><p> <img loading="lazy" src="/assets/images/29f41f21-6fbc-40ba-9efd-7b699fac9828-95d82360b2564ff4d805bb3d2dbd248b.png" width="1394" height="790" class="img_ev3q"></p><p>拼接了从a-t这20个part，实际上就填满了Maximum，导致最后一个upload无法生效，就只能从FILES转化为POST了</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="二其他技巧">（二）其他技巧<a href="#二其他技巧" class="hash-link" aria-label="（二）其他技巧的直接链接" title="（二）其他技巧的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="host替换">Host替换<a href="#host替换" class="hash-link" aria-label="Host替换的直接链接" title="Host替换的直接链接">​</a></h4><p>host如果是一个域名，可以在最后面加一个点 ==.== ，大多数情况下表示的还是当前域名，比如之前阿里云，防护的话是用过域名控制的，传过来一个域名会先看一下有没有受到保护，假如原来的域名受到了保护，但是加了一个点，就不在名单内了，就会被认为没有开WAF</p><p> <img loading="lazy" src="/assets/images/6ec1b459-5ec9-4418-8800-6fe12111677e-30f0e6ed3e484507a5b9787a8c632b9b.png" width="1208" height="726" class="img_ev3q"></p><p>还可以把Host的IP转为16进制</p><p> <img loading="lazy" src="/assets/images/0317a668-73cf-4061-aad9-f8b28a61480f-fb4126a60ade24eebec6c80e90ac6e27.png" width="1394" height="702" class="img_ev3q"></p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="url与替换">URL#与../替换<a href="#url与替换" class="hash-link" aria-label="URL#与../替换的直接链接" title="URL#与../替换的直接链接">​</a></h4><p>如果有时候加上#引发歧义的话，可以使用../跳出</p><p>如果#不可以的话，可以尝试?#</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="http参数污染">HTTP参数污染<a href="#http参数污染" class="hash-link" aria-label="HTTP参数污染的直接链接" title="HTTP参数污染的直接链接">​</a></h4><p>比如双参数</p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">?id = 1 &amp; id = and 1=1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>有些架构会将两个拼接在一起，单独任何一个都没有问题，拼在一起就有问题了，这种的话要看后端的业务逻辑</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="http09">HTTP/0.9<a href="#http09" class="hash-link" aria-label="HTTP/0.9的直接链接" title="HTTP/0.9的直接链接">​</a></h4><p>在HTTP/0.9中是没有响应头的</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="利用chuncked构造content-length为0">利用chuncked构造content-length为0<a href="#利用chuncked构造content-length为0" class="hash-link" aria-label="利用chuncked构造content-length为0的直接链接" title="利用chuncked构造content-length为0的直接链接">​</a></h4><div class="language-HTTP codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-HTTP codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Content-Length:0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Transfer-Encoding: chuncked</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>两个同时出现一般会报错，如果像上面这样的话，body部分可以随便写，不会被过滤</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="加入中文字符">加入中文字符<a href="#加入中文字符" class="hash-link" aria-label="加入中文字符的直接链接" title="加入中文字符的直接链接">​</a></h4><p>针对于特殊框架，会被替换为空</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="http方法构造">HTTP方法构造<a href="#http方法构造" class="hash-link" aria-label="HTTP方法构造的直接链接" title="HTTP方法构造的直接链接">​</a></h4><p>使用一些存在的，常用HEAD</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="添加xff头">添加XFF头<a href="#添加xff头" class="hash-link" aria-label="添加XFF头的直接链接" title="添加XFF头的直接链接">​</a></h4><p>127<!-- -->.<!-- -->0.0.1或者localhost</p><p>理论可行，需要看网络架构</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="四总结">四、总结<a href="#四总结" class="hash-link" aria-label="四、总结的直接链接" title="四、总结的直接链接">​</a></h2><p>以上这些技巧是根据原理、实践所得，参考了网上部分文章总结所得，WAF绕过并没有固定的模式，在黑盒情况下甚至你可以将所有技巧同时运用以达到目的，总之，要在不断的尝试中去绕过，然后再通过“控制变量”法去探测到底是哪一种方法奏效，以达到“通杀”的目标。</p>]]></content:encoded>
            <category>Cryptography</category>
        </item>
        <item>
            <title><![CDATA[Windows内核竞态条件漏洞研究]]></title>
            <link>https://poc.qianxin.com/blog/tiangongarticle003</link>
            <guid>https://poc.qianxin.com/blog/tiangongarticle003</guid>
            <pubDate>Wed, 01 Nov 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[一、研究背景]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="一研究背景">一、研究背景<a href="#一研究背景" class="hash-link" aria-label="一、研究背景的直接链接" title="一、研究背景的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="一操作系统内核漏洞">（一）操作系统内核漏洞<a href="#一操作系统内核漏洞" class="hash-link" aria-label="（一）操作系统内核漏洞的直接链接" title="（一）操作系统内核漏洞的直接链接">​</a></h3><p>操作系统是计算机系统的核心软件，其主要功能在于管理计算机系统中的各种软硬件资源，并为计算机用户和用户程序提供访问这些资源的统一抽象。为达到这一设计目标，操作系统内核通常运行在称为内核态的高特权级执行环境中。一旦操作系统内核被恶意攻击者非法侵入，攻击者便可立即拥有对整个计算机系统的控制权，造成极大危害。因此，针对操作系统内核的漏洞挖掘一直是学术界和工业界的研究重点。</p><p>Windows操作系统是桌面计算机领域最广泛应用的操作系统之一，在网络空间中扮演着至关重要的角色。与之对应的，Windows操作系统中存在的安全漏洞也往往具有广泛的影响和严重的潜在危害。攻击者可以利用这些漏洞来进行大规模的网络攻击，给网络安全带来严重的威胁。例如，在2017年流行的WannaCry勒索病毒攻击，就是利用了MS17-010“永恒之蓝”漏洞，其受害者遍布全球多国，造成了巨大的损失。</p><p>在Linux操作系统上，以Syzkaller为代表的模糊测试工具可以7x24小时不间断地对内核进行漏洞挖掘，并自动化地生成漏洞报告供维护者查阅。然而，在Windows操作系统上，还没有出现影响力和测试效果能够比拟Syzkaller的开源工具。造成这一差异的原因是多方面的，例如，研究人员可以通过对Linux源码进行静态分析得到供Syzkaller使用的Syzlang模版，其中包含对系统调用接口的完整描述，由此可以驱动模糊测试。但在Windows上，由于内核是闭源的，对其系统调用接口的分析过程更为复杂和困难。</p><p>通过分析近年来披露的Windows内核态漏洞，我们发现，这些漏洞大多是由独立的研究人员或安全研究团队发现，并且极大地依赖于专家知识，只在特定的情况下使用了模糊测试等自动化方法来辅助漏洞挖掘。奇安信天工实验室近年来在Hyper-V中发现的漏洞，也同样离不开安全研究员对Hyper-V整体架构和漏洞模式的深入理解。</p><p>有鉴于此，笔者也针对近年来披露的Windows内核态漏洞进行了人工的分析和研究，并主要聚焦于竞态条件这一漏洞类型。本文便是对相关研究发现的总结。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="二竞态条件漏洞">（二）竞态条件漏洞<a href="#二竞态条件漏洞" class="hash-link" aria-label="（二）竞态条件漏洞的直接链接" title="（二）竞态条件漏洞的直接链接">​</a></h3><p>竞态条件是计算机科学中的一个重要概念，它指的是在多线程或多进程环境中，由于不恰当的同步操作或竞争资源的访问而导致的不确定性行为。在现代操作系统中，多线程的程序调度是至关重要的一项任务，它直接影响了计算机系统的性能和资源利用效率。多线程编程允许程序同时执行多个任务，从而提高了系统的响应速度和并发处理能力。然而，为了有效地管理这些线程，操作系统必须具备高效的调度机制，决定哪个线程获得CPU时间片，以确保各个线程能够合理地分享计算资源。这一调度决策是基于一系列算法和策略进行的，涉及到线程的优先级、状态管理、抢占机制以及资源争用解决等多个方面。</p><p>这一调度机制也导致多个线程或进程在争夺资源的同时，执行顺序并不确定，因此可能会产生意想不到的结果。为了避免问题，多线程场景下对关键资源的访问需要利用加锁、同步等机制来保证安全。倘若多个线程同时访问共享变量或资源，而没有适当的同步机制来保护这些资源，这可能导致数据损坏、程序崩溃或不一致的结果，从而带来严重的安全和可靠性问题。</p><p> <img loading="lazy" src="/assets/images/8f35fffb-2a4c-4308-b51c-272595afbdcb-8c8372529b11e89980f93cf3cd0ea77e.png" width="1182" height="926" class="img_ev3q"></p><p><em>图1：典型的竞态条件成因，两个线程无保护地访问同一个内核对象</em></p><p>如图1所示，漏洞CVE-2022-29142的原因正是两个线程可以同时访问同一个内核对象，如果其中一个线程试图关闭该对象的句柄，另一个线程便可能访问已被释放的指针。</p><p>本文将会具体介绍竞态条件漏洞带来的潜在风险，并描述复现真实存在于Windows内核中的竞态条件漏洞时的发现。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="二漏洞分析采用的关键技术">二、漏洞分析采用的关键技术<a href="#二漏洞分析采用的关键技术" class="hash-link" aria-label="二、漏洞分析采用的关键技术的直接链接" title="二、漏洞分析采用的关键技术的直接链接">​</a></h2><p>在进行针对Windows内核的漏洞分析和研究时，主要采用的关键技术包括：补丁对比分析、二进制逆向分析、竞态条件构建和调试等。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="一补丁对比及二进制逆向分析">（一）补丁对比及二进制逆向分析<a href="#一补丁对比及二进制逆向分析" class="hash-link" aria-label="（一）补丁对比及二进制逆向分析的直接链接" title="（一）补丁对比及二进制逆向分析的直接链接">​</a></h3><p>通过在CVE数据库中的检索，发现近年来披露的Windows内核漏洞中不乏用户提权和任意代码执行等高危漏洞。然而，由于微软积极控制漏洞的影响，相关漏洞的公开PoC程序数量相对较少。对于那些没有公开PoC的漏洞，往往只能获得漏洞发现者通过博客或社交媒体透露的少量信息，难以由此开展系统性的漏洞研究。考虑到这些漏洞的修复补丁存在于Windows安全更新中，通过对补丁进行分析，包括进行补丁的解包和二进制对比等，能够有效地从中提取出更新内容，识别受影响的模块，并可以进一步地从中提取关键的补丁点，由此分析补丁所修复的漏洞。</p><p>为了能够解析微软的Windows安全补丁，首先需要了解补丁的格式以及获取方法。打包补丁的文件格式包括：.MSU（Microsoft Standalone Update）和.CAB（Cabinet）格式。补丁一般会作为 Windows 更新的一部分自动分发到用户设备上，但也可以直接从微软的更新目录中下载独立的补丁。此前，微软主要提供顺序的更新包，它们必须依次安装到用户的系统中。如今，更新以累积的方式提供，这意味着基本系统版本中的所有必需更新都包含在补丁包中，这也允许用户平滑地升级系统版本。此外，出于节省带宽等考虑，许多更新以增量的方式分发，即：更新包中只包含对特定二进制目标的修补方式，而不包含全部的文件。这也进一步增加了补丁分析的难度。</p><p>对于每次安全更新，具体的补丁文件可以从Microsoft Update Catalog上获取。.MSU格式的补丁在使用expand.exe程序解包后，将能够获得.CAB格式的补丁文件，且这些文件按照指令集和二进制差异类型进行命名。对于补丁内容的进一步提取，将依赖于微软提供的msdelta.dll库。该库中提供了ApplyDelta系列函数用于执行Windows系统更新。通过C或Python语言调用相关库函数，即可实现打补丁的过程，获得补丁之后的二进制文件。</p><p> <img loading="lazy" src="/assets/images/a27f91a3-347a-464e-a3ba-da2e949a07d9-e4e81c81cb311cb22df19b1dc1c0d474.jpeg" width="1270" height="688" class="img_ev3q"></p><p><em>图2：漏洞CVE-2023-21537补丁对比</em></p><p>最后，通过BinDiff或Diaphora等二进制对比工具，即可完成对补丁内容的分析，并由此定位到漏洞点。如图2所示，以漏洞CVE-2023-21537为例，通过对比分析补丁前后的函数控制流图，可以发现补丁新增了参数检查的分支（见红色框）。在确定可能的漏洞点后，即可开展人工的逆向分析。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="二windows内核调试">（二）Windows内核调试<a href="#二windows内核调试" class="hash-link" aria-label="（二）Windows内核调试的直接链接" title="（二）Windows内核调试的直接链接">​</a></h3><p>在成功确定漏洞点后，下一步是构造PoC程序，并触发漏洞行为，例如使内核出现崩溃，造成蓝屏死机（Blue Screen of Death）。再此基础上，可以进一步构造漏洞利用的方式，例如，利用释放后使用（Use after free）漏洞来覆盖关键的内核数据结构，实现进程提权的效果。</p><p>为了触发内核中的漏洞代码的执行，需要构造用户态程序执行系统调用或驱动程序的IoControl调用。这些函数调用往往需要大量的参数，并且，参数需要满足一定的约束条件。在实际的测试中，发现通过人工构造的参数难以一次性通过检查，必须不断进行调试并修改PoC程序。</p><p>微软提供了WinDbg程序用于支持Windows内核调试，但由于在内核函数中触发断点等操作会中断整个系统的执行，因而必须在另一台计算机上运行WinDbg，并通过TCP连接至待调试的计算机。在实际的实验中，相关的内核调试借助Hyper-V虚拟机完成。经笔者测试，运行在Hyper-V虚拟机中的Windows系统开启内核调试模式并设置端口和密钥参数后，即可在Host上通过WinDbg程序开启TCP连接进行内核调试。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="三典型漏洞分析">三、典型漏洞分析<a href="#三典型漏洞分析" class="hash-link" aria-label="三、典型漏洞分析的直接链接" title="三、典型漏洞分析的直接链接">​</a></h2><p>笔者总共分析和研究了10个近年来被披露并分配了CVE编号的Windows内核竞态条件安全漏洞，具体的漏洞编号、内核模块和漏洞类型情况如表1所示。下面将通过案例分析介绍其中的典型漏洞，以及对未来针对此类漏洞进行自动化挖掘的启发。</p><table><thead><tr><th><strong>CVE ID</strong></th><th><strong>内核模块</strong></th><th><strong>漏洞类型</strong></th></tr></thead><tbody><tr><td>CVE-2018-7249</td><td>secdrv.sys</td><td>UAF</td></tr><tr><td>CVE-2018-8410</td><td>ntoskrnl</td><td>Double dereference</td></tr><tr><td>CVE-2018-8611</td><td>ntoskrnl</td><td>UAF</td></tr><tr><td>CVE-2020-1015</td><td>UMPS</td><td>UAF</td></tr><tr><td>CVE-2021-26868</td><td>win32k</td><td>UAF</td></tr><tr><td>CVE-2021-40449</td><td>win32k</td><td>UAF</td></tr><tr><td>CVE-2021-41335</td><td>ntoskrnl</td><td>OOB</td></tr><tr><td>CVE-2022-29142</td><td>ntoskrnl</td><td>UAF</td></tr><tr><td>CVE-2023-21536</td><td>ETW</td><td>UAF</td></tr><tr><td>CVE-2023-21537</td><td>mqac.sys</td><td>Double fetch</td></tr></tbody></table><p><em>表1：分析研究的Windows内核竞态条件安全漏洞</em></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="一cve-2018-7249漏洞分析">（一）CVE-2018-7249漏洞分析<a href="#一cve-2018-7249漏洞分析" class="hash-link" aria-label="（一）CVE-2018-7249漏洞分析的直接链接" title="（一）CVE-2018-7249漏洞分析的直接链接">​</a></h3><p>该漏洞存在于Windows的secdrv.sys驱动程序中，是一个UAF类型的漏洞。该漏洞的复现版本为Windows 7 7600。</p><p>secdrv.sys驱动程序提供了IoControl调用号为0x0CA002813的接口，其处理函数sub_11A88接收三种不同的输入参数：0x96、0x97和0x98，并根据参数调用不同的派发函数。其中：0x96从分页内存池中分配内存块，进行初始化操作，并将其中一部分复制到用户提供的缓冲区中（此处还存在一个未初始化访问的问题，导致内核态的16比特内存泄漏到用户态）。0x97读取先前由0x96分配的块，并对用户输入缓冲区进行加密。0x98则用于释放由0x96分配的块。</p><p> <img loading="lazy" src="/assets/images/056ed014-f8db-4676-83ed-bb31e609f25c-f11ad28b8a89ede0ec4e4ce3fe6cb540.png" width="982" height="980" class="img_ev3q"></p><p><em>图3：处理函数根据输入参数a2执行不同操作</em></p><p>当调用IoControl类型0x97时，它通过标签找到之前由类型0x96分配的内存块。这里的漏洞在于，0x97使用内存的过程缺少加锁和同步机制。在其操作内存期间，这段内存可能被释放，因此如果恶意攻击者成功赢得竞态条件，将触发释放后使用的问题。进一步地，如果攻击者在IoControl类型0x97的操作期间，使用类型0x98成功释放了块，并重新分配了一个由攻击者控制的新块到完全相同的内存位置，那么这将有可能最终劫持驱动程序的执行控制流，并在内核态执行任意代码。由于0x97中的加密函数在用户提供的缓冲区上执行，这个缓冲区可以非常大，因此加密可能需要很长时间才能执行，从而为IoControl类型0x98提供了完美的时间窗口来达成竞态条件。</p><p>该漏洞存在公开的Exp程序，经过简单调试后即可稳定实现漏洞利用，获得SYSTEM权限。</p><p> <img loading="lazy" src="/assets/images/73734e47-cf9a-4702-b521-4979d61a1286-27908a5844a46b36699f2bb658d8578c.png" width="1220" height="922" class="img_ev3q"></p><p><em>图4：复现漏洞CVE-2018-7249实现提权</em></p><p>该漏洞的触发方式较为简单，且输入参数也没有较为苛刻的约束条件，因而通过自动化漏洞挖掘工具发现该漏洞是可能的。现有的竞态条件漏洞挖掘方案可以自动由顺序执行的IoControl调用序列生成多线程的序列，并探索不同线程交错的情况下其执行过程是否出现异常。不过，这仍需要先通过对驱动程序的分析，推断出相关的IoControl调用号，并指导模糊测试器通过启动多个线程来分别执行0x97和0x98对应的IoControl操作。有关问题仍需进一步研究。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="二cve-2021-41335漏洞分析">（二）CVE-2021-41335漏洞分析<a href="#二cve-2021-41335漏洞分析" class="hash-link" aria-label="（二）CVE-2021-41335漏洞分析的直接链接" title="（二）CVE-2021-41335漏洞分析的直接链接">​</a></h3><p>该漏洞存在于Windows的内核ntoskrnl.exe中。漏洞的原因是两个内核函数：ObpCreateSymbolicLinkName与ObpDeleteSymbolicLinkName可能操作同一个_OBJECT_SYMBOLIC_LINK内核对象，但它们并未正确进行加锁操作，因而存在竞态条件安全漏洞。该漏洞将导致越界访问，并可以被进一步利用，导致内核任意地址写，造成严重的破坏。该漏洞的复现版本为Windows 10 21H1 19043.928。</p><p>触发漏洞的调用链是：NtCreateSymbolicLinkObject系统调用会执行ObInsertObjectEx来创建符号链接对象，该函数先调用ObpCreateHandle来为新的符号链接对象创建一个新的句柄，再调用ObpCreateSymbolicLinkName创建符号链接。然而，在ObpCreateHandle执行结束后，用户态程序就已经拥有了指向内核对象的有效句柄。这意味着，在随后ObInsertObjectEx调用ObpCreateSymbolicLinkName时，用户态进程可以开启另一个线程并尝试通过该句柄操作仍在被内核函数使用的新符号链接对象。例如，可以在另一个线程中通过NtClose函数调用关闭该句柄，这显然会导致问题。</p><p>为了进一步明确漏洞的成因，通过人工逆向分析比较ObpCreateSymbolicLinkName和ObpDeleteSymbolicLinkName的代码，可以注意到：ObpDeleteSymbolicLinkName将符号链接对象的DosDeviceDriveIndex成员设置为0；而ObpCreateSymbolicLinkName读取符号链接对象的该成员并将其减小1。此外，ObpCreateSymbolicLinkName使用减小后的DosDeviceDriveIndex值作为_DEVICE_MAP结构中的DriveType数组的索引。</p><p> <img loading="lazy" src="/assets/images/6bdd1ff7-570c-45a9-8d71-4e9d73d46c2d-e43cb7e5bc65b84549b82e925778d30e.png" width="1274" height="1180" class="img_ev3q"></p><p><em>图5：符号链接对象的DosDeviceDriveIndex成员被置零</em></p><p>由于加锁操作存在问题，恶意攻击者可以试图使DosDeviceDriveIndex成员已经被置零后，又进行自减操作，由此产生整数下溢。又由于该数值被用于数组索引，这将导致越界访问。</p><p>为了复现此漏洞，需要创建两个线程，第一个线程通过NtCreateSymbolicLinkObject不断创建新的符号链接对象，而第二个线程则通过NtClose不断关闭新创建的符号链接对象句柄。通过这样做，很可能出现ObpDeleteSymbolicLinkName在ObpCreateSymbolicLinkName之前被调用的线程交错情况。因此，ObpCreateSymbolicLinkName将以值0xFFFFFFFF作为索引访问DriveType数组，导致在数组边界之外写入任意值，最终引发内核崩溃。具体的漏洞复现情况和调试器读出的寄存器参数如图6、图7所示，可以看到，执行NtClose的线程进行了多于35万次尝试，才触发了导致漏洞的线程交错方式。</p><p> <img loading="lazy" src="/assets/images/d8149816-c428-416a-b8f3-fe5a5ee93574-64209c21135234a19298873b28eff60b.png" width="1269" height="790" class="img_ev3q"></p><p><em>图6：运行PoC程序，两个线程分别创建和销毁内核对象</em></p><p> <img loading="lazy" src="/assets/images/d72340f0-03f2-441d-8c4f-c134330f15fe-605795e57db2a13dd7d4bb50149fa171.png" width="1270" height="730" class="img_ev3q"></p><p><em>图7：WinDbg捕获蓝屏死机的情况，可见rcx寄存器值存在整数下溢</em></p><p>通过补丁对比分析可以发现，该漏洞的修复方式是由ObpCreateHandle来调用ObpCreateSymbolicLinkName创建符号链接，避免用户态进程提前对句柄进行操作。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="三cve-2023-21537漏洞分析">（三）CVE-2023-21537漏洞分析<a href="#三cve-2023-21537漏洞分析" class="hash-link" aria-label="（三）CVE-2023-21537漏洞分析的直接链接" title="（三）CVE-2023-21537漏洞分析的直接链接">​</a></h3><p>该漏洞于2023年1月披露，并已被微软修复。漏洞并没有公开的PoC程序，漏洞发现者只通过博客文章透露了部分信息。该漏洞的复现版本为Windows 10 21H1 19043.928。</p><p>该漏洞存在于消息队列（MSMQ）驱动程序mqac.sys中。消息队列是Windows的可选功能，需要在控制面板中手动启用，并在计算机管理中创建消息队列。微软为消息队列的开发提供了头文件mq.h以及运行时库mqrt.dll，其中包含MQOpenQueue和MQSendMessage等函数。这些函数其实是封装了对驱动程序mqac.sys发起的IoControl调用，通过构造合法的参数，用户态程序也可以直接使用NtDeviceIoControlFile发送IoControl调用，触发此驱动程序的功能。</p><p>该漏洞的成因是mqac.sys中的ACSendMessage函数会两次读取一个来自用户的输入参数，第一次该参数用于控制数组长度，第二次则是在释放堆内存时，根据该长度进行释放。然而，这段逻辑并未考虑参数会被用户修改的可能，因而构成一个Double fetch漏洞，可能导致错误的内存被释放。</p><p>mqac.sys中负责处理IoControl调用的函数名称为ACDeviceControl，该函数将会解析用户传入的参数，并调用不同的派发函数。通过逆向分析ACDeviceControl函数，发现当IoControl调用号为0x19658107且输出缓冲区的总长度为0x2C0时，它会进一步调用ACSendMessage这一派发函数。ACSendMessage函数首先将用户态缓冲区复制到内核态栈上的缓冲区，之后，将执行核心的业务逻辑，调用 CQueue::PutNewPacket来发送用户请求的数据，完成后再调用 ACFreeDeepCopyQueueFormat进行堆内存的释放。此处便存在漏洞：进行内存释放操作传入的第二个参数直接读取自用户态缓冲区中。如图8所示，参数a4就是指向缓冲区的指针。</p><p> <img loading="lazy" src="/assets/images/b485e0c2-cb7a-4903-91ba-6af3bc701754-20ce7ffc82824bb81171d9b80bca7d3a.png" width="1562" height="840" class="img_ev3q"></p><p><em>图8：漏洞函数重复读取了用户输入</em></p><p>这意味着，如果恶意攻击者设法赢得竞态条件，在ACSendMessage函数进行内存释放前成功地修改了此处的参数值，将其设置为较大的值，那么将导致超出范围地释放任意指针。</p><p>经过进一步分析，触发漏洞时消息队列虚拟设备需要处于特定的状态，这需要PoC程序预先执行其它的IoControl调用。同时，用户缓冲区中偏移量584个字节处应当是一个合法的指针，才能通过消息队列驱动程序的参数检查。在满足这些约束条件的情形下，PoC程序启动两个线程，一个用于发送IoControl调用，另一个则修改用户缓冲区中偏移量592个字节处的值为较大值。通过人工构造参数并编写PoC程序发起IoControl请求，可以成功地使内核崩溃，如图9、图10所示。</p><p> <img loading="lazy" src="/assets/images/4d97120f-d70c-474a-a987-f154eb51be9c-bff66130906a7c5e77a28c3c6dbe7329.png" width="1269" height="1081" class="img_ev3q"></p><p><em>图9：漏洞导致蓝屏，原因为BAD_POOL_CALLER</em></p><p> <img loading="lazy" src="/assets/images/6b6ab504-db0a-42e8-bbf3-3748c5c706b5-61a2db8cd1011a251a731f0839276522.png" width="1270" height="759" class="img_ev3q"></p><p><em>图10：WinDbg观察触发漏洞的调用栈，与预期的相同</em></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="四漏洞总结">四、漏洞总结<a href="#四漏洞总结" class="hash-link" aria-label="四、漏洞总结的直接链接" title="四、漏洞总结的直接链接">​</a></h2><p>在本章中，笔者将概括Windows内核竞态条件漏洞的一些模式，并说明对漏洞的分析如何指导模糊测试方法或者开展相关的研究工作。</p><p>在研究中观察到，这些竞态条件漏洞的发现的时间范围从2018年至2023年，系统版本跨越Windows 7至Windows 11。其中，消息队列驱动程序中的漏洞，已经存在超过10年的时间才被发现。该驱动程序是Windows的可选功能，默认并未开启，可以推测此前的很长时间内也没有被安全研究人员所注意。事实上，Windows系统中存在大量的老旧代码，它们可能并未经过充分的测试，因此包含潜在的安全漏洞。</p><p>发现漏洞所处的模块也具有多样性。除去Windows内核ntoskrnl.exe外，还有相当部分的漏洞存在于Windows的图形子系统和内核驱动程序中。触发这些漏洞的方法也各不相同，包括ntoskrnl系统调用、win32系统调用和IoControl调用等。</p><p>根据对驱动程序中所存在的竞态条件漏洞的观察，它们往往可以通过多线程同时发起IoControl调用来触发，但IoControl的参数必须通过严格的检查才能使驱动程序的控制流到达漏洞点。特别地，对CVE-2023-21537漏洞的研究体现出，通过人工方法来触发漏洞需要大量的专家知识，并且构造参数、调试PoC程序的效率较低。这意味着，如果要开展自动化模糊测试，必须通过静态分析或符号执行等方式从驱动程序中提取信息，才能对巨大的输入参数空间进行划分，提高测试的效率。否则，模糊测试可能无法到达更深层的代码逻辑中，效果上也将无法达到人工漏洞挖掘的效果。</p><p>此外，研究中还发现，具体漏洞类型主要包括UAF、OOB和Double fetch这三类。其中，UAF漏洞数量较多。对于竞态条件导致的UAF漏洞，往往需要在特定的时间窗口内触发，因此即使执行了漏洞代码，也不一定能够直接产生崩溃。在实际的测试中，PoC程序也往往需要运行约数秒到数十秒的时间才能赢得竞态条件。因此，要自动化地挖掘此类漏洞，必须对内核态的内存访问违例行为进行监测，也即为模糊测试器部署对应的Sanitizer。</p><p>由于竞态条件漏洞的出现伴随着线程交错的随机性，其相比于通过顺序的系统调用序列来测试内核更为复杂。目前学术界对内核竞态条件漏洞挖掘的研究往往针对Linux等开源操作系统，而在Windows这一闭源目标上，还没有诞生成熟的竞态条件漏洞挖掘工具。</p><p>总而言之，对Windows内核竞态条件漏洞的挖掘仍有很多值得探索的方向，期待未来能在学术界和工业界看到更多的创新成果，希望本文能起到抛砖引玉的效果。</p>]]></content:encoded>
            <category>Microsoft</category>
            <category>Windows</category>
            <category>Race Condition</category>
        </item>
        <item>
            <title><![CDATA[Microsoft Hyper-V 虚拟 TPM 设备漏洞分析]]></title>
            <link>https://poc.qianxin.com/blog/tiangongarticle002</link>
            <guid>https://poc.qianxin.com/blog/tiangongarticle002</guid>
            <pubDate>Wed, 25 Oct 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[一、漏洞描述]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="一漏洞描述">一、漏洞描述<a href="#一漏洞描述" class="hash-link" aria-label="一、漏洞描述的直接链接" title="一、漏洞描述的直接链接">​</a></h2><p>2023年10月微软发布的安全更新中，修复了2个由笔者报送的Hyper-V虚拟TPM设备漏洞。本次修复的Hyper-V虚拟TPM组件的漏洞可以通过远程访问虚拟机的方式触发漏洞，造成宿主机拒绝服务或者远程代码执行，对宿主机上的其他虚拟机或业务造成损失。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="二背景介绍">二、背景介绍<a href="#二背景介绍" class="hash-link" aria-label="二、背景介绍的直接链接" title="二、背景介绍的直接链接">​</a></h2><p>Hyper-V的虚拟TPM组件旨在为虚拟机提供模拟的TPM设备，虚拟TPM设备可以为依赖TPM设备的服务或者操作系统（例如Windows 11）提供支持。</p><p>漏洞位于<code>vmsp.exe</code>进程中的<code>TpmEngUM.dll</code>二进制文件中，本次介绍的两个虚拟TPM组件的漏洞就是位于<code>TpmEngUM.dll</code>这个二进制文件中。</p><p><code>vmsp.exe</code>进程与<code>vmwp.exe</code>进程相似，都是一个虚拟机实例启动一个进程。但是不同的是<code>vmsp.exe</code>进程是隔离用户模式(IUM)进程，也就是说<code>vmsp.exe</code>进程无法在windows用户态下被正常attach。所以在调试上，针对<code>vmsp.exe</code>进程的调试就需要额外的“手脚”，这里我们引用Quarkslab博客的文章（<a href="https://blog.quarkslab.com/debugging-windows-isolated-user-mode-ium-processes.html%EF%BC%89%EF%BC%8C%E6%84%9F%E5%85%B4%E8%B6%A3%E7%9A%84%E8%AF%BB%E8%80%85%E5%8F%AF%E4%BB%A5%E5%8E%BB%E4%BA%86%E8%A7%A3%E5%B9%B6%E5%AE%9E%E8%B7%B5%E4%B8%8B%EF%BC%8C%E8%BF%99%E9%87%8C%E4%B8%8D%E5%81%9A%E8%AE%A8%E8%AE%BA%E3%80%82" target="_blank" rel="noopener noreferrer">https://blog.quarkslab.com/debugging-windows-isolated-user-mode-ium-processes.html），感兴趣的读者可以去了解并实践下，这里不做讨论。</a></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="三环境搭建">三、环境搭建<a href="#三环境搭建" class="hash-link" aria-label="三、环境搭建的直接链接" title="三、环境搭建的直接链接">​</a></h2><p>虚拟TPM组件漏洞的触发需要在Hyper-V虚拟机设置中的“安全”设置中，勾选“启用受信任的平台模块”。</p><p> <img loading="lazy" src="/assets/images/0c7d620e-97ff-45cc-a12f-b4c66a317e2a-73d520780556ca0a4fe552ce77213993.png" width="1214" height="869" class="img_ev3q"></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="四漏洞分析cve-2023-36717">四、漏洞分析CVE-2023-36717<a href="#四漏洞分析cve-2023-36717" class="hash-link" aria-label="四、漏洞分析CVE-2023-36717的直接链接" title="四、漏洞分析CVE-2023-36717的直接链接">​</a></h2><p>该漏洞是一个拒绝服务漏洞，当这个漏洞被触发时会导致宿主机<code>vmsp.exe</code>进程进入死循环，并占用大量CPU计算资源。由于<code>vmsp.exe</code>进程是IUM进程，所以当漏洞被触发后，管理员无法从用户态结束掉这个进程，这种情况下除非重启宿主机操作系统否则计算资源一直无法被释放。</p><p>这个漏洞位于<code>TpmEngUM!TPM2_ECDH_KeyGen</code>函数中。</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">__int64 __fastcall </span><span class="token function maybe-class-name" style="color:#d73a49">TPM2_ECDH_KeyGen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">unsigned int </span><span class="token parameter operator" style="color:#393A34">*</span><span class="token parameter">a1</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> __int64 a2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token constant" style="color:#36acaa">OBJECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v3</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// rax</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token constant" style="color:#36acaa">OBJECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v4</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// rsi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  unsigned int v5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// eax</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  unsigned int v6</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// ebx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  unsigned __int16 v8</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">28</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+20h] [rbp-58h] BYREF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v3 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#d73a49">ObjectGet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">a1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v4 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> v3</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> v3</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_type </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x23</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v3</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_objectAttributes </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x10000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v3</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_objectAttributes </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x20000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> 0x19Ci64</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unsigned __int16</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#d73a49">cpri__GetEphemeralEcc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                               </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unsigned __int16 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a2 </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">104</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                               v8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                               v4</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_parameters_Detail_keyBits</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_WORD </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a2 </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x66</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#d73a49">TPMS_ECC_POINT_Marshal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_BYTE </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a2 </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">104</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> 0i64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> 0i64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    v5 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#d73a49">CryptEccPointMultiply</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_WORD </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a2 </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           v4</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_parameters_Detail_keyBits</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           v8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__int64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">v4</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_unique_ecc_x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    v6 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> v5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> v5 </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xA7</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> v5 </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x154</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      goto </span><span class="token constant" style="color:#36acaa">LABEL_9</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v6 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">156</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">LABEL_9</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">v6 </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_WORD </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">a2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#d73a49">TPMS_ECC_POINT_Marshal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_BYTE </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a2 </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> 0i64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> 0i64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> v6</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在<code>TpmEngUM!TPM2_ECDH_KeyGen</code>函数中，<code>v4-&gt;public_unique_ecc_x</code>成员可以从Guest中被控制，如果<code>v4-&gt;public_unique_ecc_x</code>成员是一个NULL ECC Point的情况下（<code>TPM2B_ECC_PARAMETER.size</code>为0x00,并且<code>TPM2B_ECC_PARAMETER.buffer</code>数组被0填充），<code>TpmEngUM!CryptEccPointMultiply</code>会一直返回错误码0x154，并不停的循环调用<code>TpmEngUM!CryptEccPointMultiply</code>函数，最终造成vmsp.exe进程死循环，导致宿主机拒绝服务。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="五漏洞分析cve-2023-36718">五、漏洞分析CVE-2023-36718<a href="#五漏洞分析cve-2023-36718" class="hash-link" aria-label="五、漏洞分析CVE-2023-36718的直接链接" title="五、漏洞分析CVE-2023-36718的直接链接">​</a></h2><p>该漏洞是远程代码执行漏洞，当这个漏洞被触发时会使用未初始化的栈空间变量。这个漏洞位于<code>TpmEngUM!CryptSecretEncrypt</code>函数中。</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">__int64 __fastcall </span><span class="token function maybe-class-name" style="color:#d73a49">CryptSecretEncrypt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">unsigned int a1</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> _BYTE </span><span class="token parameter operator" style="color:#393A34">*</span><span class="token parameter">a2_plabel</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> __int64 a3</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> __int16 </span><span class="token parameter operator" style="color:#393A34">*</span><span class="token parameter">a4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  unsigned int v7</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// ebx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token constant" style="color:#36acaa">OBJECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v8_obj</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// rax</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token constant" style="color:#36acaa">OBJECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v9_obj</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// rdi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  unsigned __int16 </span><span class="token maybe-class-name">DigestSize</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// ax</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  unsigned __int16 public_parameters_Detail_keyBits</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// cx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  __int16 public_nameAlg</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// cx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v14</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+40h] [rbp-C0h] BYREF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  __int16 v15</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">28</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+48h] [rbp-B8h] BYREF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  __int16 v16</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">56</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+80h] [rbp-80h] BYREF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  __int16 v17_Z_eccpointaftermul</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">56</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+F0h] [rbp-10h] BYREF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v7 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v8_obj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#d73a49">ObjectGet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v9_obj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> v8_obj</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">DigestSize</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">cpri__GetDigestSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v8_obj</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_nameAlg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_WORD </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">a3 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token maybe-class-name">DigestSize</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> v9_obj</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_type </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> v9_obj</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_type </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x23</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public_parameters_Detail_keyBits </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> v9_obj</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_parameters_Detail_keyBits</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    v14 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> a4 </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unsigned int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#d73a49">cpri__EccIsPointOnCurve</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         public_parameters_Detail_keyBits</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__int64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">v9_obj</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_unique_ecc_x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">cpri__GetEphemeralEcc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unsigned __int16 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">v16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unsigned __int16 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">v15</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v9_obj</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_parameters_Detail_keyBits</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">a4 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#d73a49">TPMS_ECC_POINT_Marshal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">v14</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> 0i64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unsigned int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function maybe-class-name" style="color:#d73a49">CryptEccPointMultiply</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           v17_Z_eccpointaftermul</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           v9_obj</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_parameters_Detail_keyBits</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unsigned __int16 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">v15</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__int64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">v9_obj</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_unique_ecc_x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        v7 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x9C</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#d73a49">BitIsSet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unsigned __int16</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">v9_obj</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_nameAlg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__int64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">g_toTest</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> 9u</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public_nameAlg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> v9_obj</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_nameAlg</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> public_nameAlg </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x10</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token function maybe-class-name" style="color:#d73a49">TestAlgorithm</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">public_nameAlg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> 0i64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">cpri__KDFe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        v9_obj</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_nameAlg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unsigned __int16 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">v17_Z_eccpointaftermul</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        a2_plabel</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unsigned __int16 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">v16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unsigned __int16 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">v9_obj</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_unique_ecc_x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unsigned __int16 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">a3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_BYTE </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a3 </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x9C</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> v7</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面代码中的<code>v17_Z_eccpointaftermul</code>是一个栈上的数组（也可能是个结构体），<code>v17_Z_eccpointaftermul</code>的大小是0x70字节。代码中的<code>v9_obj-&gt;public_unique_ecc_x</code>成员可以从Guest中被控制，当<code>v9_obj-&gt;public_unique_ecc_x</code>成员是一个NULL ECC Point的情况下<code>（TPM2B_ECC_PARAMETER.size</code>为0x00,并且<code>TPM2B_ECC_PARAMETER.buffer</code>数组被0填充），<code>TpmEngUM!CryptEccPointMultiply</code>函数会返回一个错误码并将v7设置为0x9C。</p><p>设置完v7的值之后，程序继续走到要调用<code>TpmEngUM!cpri__KDFe</code>函数这里，此时<code>v17_Z_eccpointaftermul</code>是一个栈上未初始化的数组，并作为<code>TpmEngUM!cpri__KDFe</code>函数的第二参数进入到之后的<code>TpmEngUM!cpri__KDFe</code>函数的代码流程里。</p><p>在<code>TpmEngUM!cpri__KDFe</code>函数后续的代码流程中，使用了未初始化的栈上的数据，导致越界读或者内存损坏。下面是崩溃时的现场：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">4afc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">2f4c</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Access</span><span class="token plain"> violation </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> code </span><span class="token function" style="color:#d73a49">c0000005</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">first chance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">First</span><span class="token plain"> chance exceptions are reported before any exception handling</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property-access maybe-class-name">This</span><span class="token plain"> exception may be expected and handled</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property-access maybe-class-name">TpmEngUM</span><span class="token operator" style="color:#393A34">!</span><span class="token maybe-class-name">SymCryptSha512AppendBlocks_ull</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0xa7</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00007ffb</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">38d9a42f 4d8b41f0        mov     r8,qword ptr [r9-10h] ds:00000000</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">00153ffe</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">??</span><span class="token operator" style="color:#393A34">??</span><span class="token operator" style="color:#393A34">??</span><span class="token operator" style="color:#393A34">??</span><span class="token operator" style="color:#393A34">??</span><span class="token operator" style="color:#393A34">??</span><span class="token operator" style="color:#393A34">??</span><span class="token operator" style="color:#393A34">??</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">000</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> k</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> # </span><span class="token maybe-class-name">Child</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">SP</span><span class="token plain">          </span><span class="token maybe-class-name">RetAddr</span><span class="token plain">           </span><span class="token maybe-class-name">Call</span><span class="token plain"> </span><span class="token maybe-class-name">Site</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">00</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00000000</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">0014ec80 00007ffb</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">38d99e01 </span><span class="token maybe-class-name">TpmEngUM</span><span class="token operator" style="color:#393A34">!</span><span class="token maybe-class-name">SymCryptSha512AppendBlocks_ull</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0xa7</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">01</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00000000</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">0014eed0 00007ffb</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">38d99e59 </span><span class="token maybe-class-name">TpmEngUM</span><span class="token operator" style="color:#393A34">!</span><span class="token maybe-class-name">SymCryptSha512Append</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x95</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">02</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00000000</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">0014ef10 00007ffb</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">38d87724 </span><span class="token maybe-class-name">TpmEngUM</span><span class="token operator" style="color:#393A34">!</span><span class="token maybe-class-name">SymCryptSha384Append</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x9</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">03</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00000000</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">0014ef40 00007ffb</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">38d66cd7 </span><span class="token maybe-class-name">TpmEngUM</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">cpri__KDFe</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x1a4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">04</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00000000</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">0014f110 00007ffb</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">38d7c7cd </span><span class="token maybe-class-name">TpmEngUM</span><span class="token operator" style="color:#393A34">!</span><span class="token maybe-class-name">CryptSecretEncrypt</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x143</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">05</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00000000</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">0014f2c0 00007ffb</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">38d70a54 </span><span class="token maybe-class-name">TpmEngUM</span><span class="token operator" style="color:#393A34">!</span><span class="token maybe-class-name">TPM2_MakeCredential</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x7d</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">06</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00000000</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">0014f340 00007ffb</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">38d61c54 </span><span class="token maybe-class-name">TpmEngUM</span><span class="token operator" style="color:#393A34">!</span><span class="token maybe-class-name">CommandDispatcher</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0xa78</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">07</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00000000</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">0014f420 00007ffb</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">38d61313 </span><span class="token maybe-class-name">TpmEngUM</span><span class="token operator" style="color:#393A34">!</span><span class="token maybe-class-name">ExecuteCommand</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x460</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">08</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00000000</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">0014f530 00000001</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">400c3862 </span><span class="token maybe-class-name">TpmEngUM</span><span class="token operator" style="color:#393A34">!</span><span class="token maybe-class-name">VTpmExecuteCommand</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x73</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="六总结">六、总结<a href="#六总结" class="hash-link" aria-label="六、总结的直接链接" title="六、总结的直接链接">​</a></h2><p>借助此文简单的介绍了下Hyper-V虚拟TPM组件的两个漏洞，可以发现这两个漏洞都是Hyper-V虚拟TPM组件在处理Guest数据时发生了错误导致宿主机进程受到了影响。通过本文帮助读者更好地理解虚拟TPM组件漏洞的成因，以及希望能够在TPM组件的漏洞挖掘工作中帮到大家。</p>]]></content:encoded>
            <category>Microsoft</category>
            <category>Hyper-V</category>
            <category>TPM</category>
        </item>
        <item>
            <title><![CDATA[CVE-2023-0179 Linux内核提权]]></title>
            <link>https://poc.qianxin.com/blog/tiangongarticle001</link>
            <guid>https://poc.qianxin.com/blog/tiangongarticle001</guid>
            <pubDate>Wed, 18 Oct 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[0x00 前言]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="0x00-前言">0x00 前言<a href="#0x00-前言" class="hash-link" aria-label="0x00 前言的直接链接" title="0x00 前言的直接链接">​</a></h2><p>2022年7月为天府杯准备的Linux提权漏洞，但是22年天府杯没办，23年1月被外国人报了。</p><p>思路来源于这篇文章，在看到这篇文章后决定去好好过一下netfilter相关模块。</p><p>文章链接：<a href="https://mp.weixin.qq.com/s?__biz=Mzk0OTU2ODQ4Mw==&amp;mid=2247483772&amp;idx=1&amp;sn=d1a48ae8f391d42e9d8981b67747ccc5&amp;chksm=c35717f0f4209ee67e547252ef5ad6a75654aa19708987f849c1748fc370755562879d39ae48&amp;token=665487310&amp;lang=zh_CN" target="_blank" rel="noopener noreferrer">How The Tables Have Turned: An analysis of two new Linux vulnerabilities in nf_tables</a></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="0x01-背景">0x01 背景<a href="#0x01-背景" class="hash-link" aria-label="0x01 背景的直接链接" title="0x01 背景的直接链接">​</a></h2><p>该漏洞位于Linux内核中netfilter模块对vlan进行处理的相关代码中，由于整型溢出导致的栈溢出，最后是ROP修改modprobe_path路径完成提权，在Ubuntu下测试可以稳定触发，提权成功率百分之百。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="0x02-漏洞成因加还是减">0x02 漏洞成因，加还是减<a href="#0x02-漏洞成因加还是减" class="hash-link" aria-label="0x02 漏洞成因，加还是减的直接链接" title="0x02 漏洞成因，加还是减的直接链接">​</a></h2><p>下面是漏洞代码，处理vlan相关的部分代码。</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/* add vlan header into the user buffer for if tag was removed by offloads */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> bool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">nft_payload_copy_vlan</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">u32 </span><span class="token parameter operator" style="color:#393A34">*</span><span class="token parameter">d</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#00009f">const</span><span class="token parameter"> struct sk_buff </span><span class="token parameter operator" style="color:#393A34">*</span><span class="token parameter">skb</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> u8 offset</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> u8 len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  int mac_off </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">skb_mac_header</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">skb</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> skb</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  u8 </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">vlanh</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">dst_u8 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u8 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> d</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  struct vlan_ethhdr veth</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  u8 vlan_hlen </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">skb</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">protocol </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">htons</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">ETH_P_8021AD</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       skb</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">protocol </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">htons</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">ETH_P_8021Q</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      offset </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">VLAN_ETH_HLEN</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> offset </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">VLAN_ETH_HLEN</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">VLAN_HLEN</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vlan_hlen </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">VLAN_HLEN</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  vlanh </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u8 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">veth</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">offset </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">VLAN_ETH_HLEN</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> vlan_hlen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    u8 ethlen </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> len</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">vlan_hlen </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">skb_copy_bits</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">skb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mac_off</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">veth</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">VLAN_ETH_HLEN</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token function" style="color:#d73a49">nft_payload_rebuild_vlan_hdr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">skb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mac_off</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">veth</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">offset </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> len </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">VLAN_ETH_HLEN</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> vlan_hlen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ethlen </span><span class="token operator" style="color:#393A34">-=</span><span class="token plain"> offset </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> len </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">VLAN_ETH_HLEN</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> vlan_hlen</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">memcpy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dst_u8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> vlanh </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> offset </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> vlan_hlen</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ethlen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    len </span><span class="token operator" style="color:#393A34">-=</span><span class="token plain"> ethlen</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">len </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dst_u8 </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> ethlen</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    offset </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">ETH_HLEN</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> vlan_hlen</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    offset </span><span class="token operator" style="color:#393A34">-=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">VLAN_HLEN</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> vlan_hlen</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">skb_copy_bits</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">skb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> offset </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> mac_off</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dst_u8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这一段代码好像有点问题？<strong>整数溢出！！！</strong></p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">offset </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> len </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">VLAN_ETH_HLEN</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> vlan_hlen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ethlen </span><span class="token operator" style="color:#393A34">-=</span><span class="token plain"> offset </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> len </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">VLAN_ETH_HLEN</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> vlan_hlen</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在判断if (offset + len &gt; VLAN_ETH_HLEN + vlan_hlen)后，应该用offset + len减去VLAN_ETH_HLEN + vlan_hlen，很明显代码中少了括号运算，修复补丁也是简单的将+改为-。</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">offset </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> len </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter constant" style="color:#36acaa">VLAN_ETH_HLEN</span><span class="token parameter"> </span><span class="token parameter operator" style="color:#393A34">+</span><span class="token parameter"> vlan_hlen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">offset </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> len </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">VLAN_ETH_HLEN</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> vlan_hlen</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>栈溢出！！！</strong></p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">memcpy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dst_u8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> vlanh </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> offset </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> vlan_hlen</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ethlen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>dst_u8(rdi)指向上层调用函数的regs栈上变量，vlanh(rsi)指向veth栈上变量，ethlen(rcx &lt;&lt; 3)在整数溢出后会变为一个较大值。</p><p> <img loading="lazy" src="/assets/images/7848c444-c556-44ba-a298-91e2573502d7-0976ec7020384aea8cf1ff39ebb82f27.png" width="1720" height="1036" class="img_ev3q"></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="0x03-漏洞利用">0x03 漏洞利用<a href="#0x03-漏洞利用" class="hash-link" aria-label="0x03 漏洞利用的直接链接" title="0x03 漏洞利用的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="条件一需要cap_net_admin权限">条件一：需要CAP_NET_ADMIN权限<a href="#条件一需要cap_net_admin权限" class="hash-link" aria-label="条件一：需要CAP_NET_ADMIN权限的直接链接" title="条件一：需要CAP_NET_ADMIN权限的直接链接">​</a></h3><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">nfnetlink_rcv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">struct sk_buff </span><span class="token parameter operator" style="color:#393A34">*</span><span class="token parameter">skb</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        struct nlmsghdr </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">nlh </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">nlmsg_hdr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">skb</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">skb</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">len </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NLMSG_HDRLEN</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nlh</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">nlmsg_len </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NLMSG_HDRLEN</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            skb</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">len </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> nlh</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">nlmsg_len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token function" style="color:#d73a49">netlink_net_capable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">skb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">CAP_NET_ADMIN</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token function" style="color:#d73a49">netlink_ack</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">skb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nlh</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">EPERM</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nlh</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">nlmsg_type </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NFNL_MSG_BATCH_BEGIN</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token function" style="color:#d73a49">nfnetlink_rcv_skb_batch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">skb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nlh</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token function" style="color:#d73a49">netlink_rcv_skb</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">skb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nfnetlink_rcv_msg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bool </span><span class="token function" style="color:#d73a49">netlink_net_capable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter keyword" style="color:#00009f">const</span><span class="token parameter"> struct sk_buff </span><span class="token parameter operator" style="color:#393A34">*</span><span class="token parameter">skb</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> int cap</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">netlink_ns_capable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">skb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sock_net</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">skb</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">sk</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">user_ns</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cap</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>命令空间</strong></p><p>Linux下默认的根命令空间是init_user_ns，如果CONFIG_USER_NS和CONFIG_NET_NS配置选项开启，用户便可以创建自己的命令空间，并且在该用户命令空间中获得所有权限。所以可以通过创建新的命令空间以满足上述CAP_NET_ADMIN权限检查。</p><p> <img loading="lazy" src="/assets/images/81f59f3f-098d-4671-8167-b943b5629a35-6a41d15113b0649127129dfeb8a10b90.png" width="1127" height="181" class="img_ev3q"></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="条件二溢出的长度不足">条件二：溢出的长度不足<a href="#条件二溢出的长度不足" class="hash-link" aria-label="条件二：溢出的长度不足的直接链接" title="条件二：溢出的长度不足的直接链接">​</a></h3><p>ethlen的类型是u8，那么最大值为0xff，很明显不足以覆盖返回地址，regs变量后跟着nft_jumpstack结构体数组，长度为16，大小为256字节。</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#define </span><span class="token constant" style="color:#36acaa">NFT_JUMP_STACK_SIZE</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">16</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">struct nft_jumpstack </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> struct nft_chain  </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">chain</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  struct nft_rule  </span><span class="token operator" style="color:#393A34">*</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">rules</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unsigned int</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">nft_do_chain</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">struct nft_pktinfo </span><span class="token parameter operator" style="color:#393A34">*</span><span class="token parameter">pkt</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#00009f">void</span><span class="token parameter"> </span><span class="token parameter operator" style="color:#393A34">*</span><span class="token parameter">priv</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> struct nft_chain </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">chain </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> priv</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">basechain </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> chain</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> struct net </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">net </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">nft_net</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pkt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  struct nft_rule </span><span class="token operator" style="color:#393A34">*</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">rules</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> struct nft_rule </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">rule</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> struct nft_expr </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">expr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">last</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  struct nft_regs regs</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  unsigned int stackptr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  struct nft_jumpstack jumpstack</span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">NFT_JUMP_STACK_SIZE</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  bool genbit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">READ_ONCE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">net</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">nft</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">gencursor</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  struct nft_traceinfo info</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ida反汇编结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">__int64 __fastcall </span><span class="token function" style="color:#d73a49">nft_do_chain</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token parameter">__int64 </span><span class="token parameter operator" style="color:#393A34">*</span><span class="token parameter">a1</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"></span><br></span><span class="token-line" style="color:#393A34"><span class="token parameter">        struct nft_regs </span><span class="token parameter operator" style="color:#393A34">*</span><span class="token parameter">a2</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"></span><br></span><span class="token-line" style="color:#393A34"><span class="token parameter">        __int64 a3</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"></span><br></span><span class="token-line" style="color:#393A34"><span class="token parameter">        __int64 a4</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"></span><br></span><span class="token-line" style="color:#393A34"><span class="token parameter">        __int64 a5</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"></span><br></span><span class="token-line" style="color:#393A34"><span class="token parameter">        __int64 a6</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"></span><br></span><span class="token-line" style="color:#393A34"><span class="token parameter">        char a7</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"></span><br></span><span class="token-line" style="color:#393A34"><span class="token parameter">        int a8</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"></span><br></span><span class="token-line" style="color:#393A34"><span class="token parameter">        __int16 a9</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  struct nft_regs regs</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+60h] [rbp-190h] BYREF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  struct nft_jumpstack v51</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+B0h] [rbp-140h] BYREF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  unsigned __int64 canary</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+1B8h] [rbp-38h]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  __int64 v53</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+1C0h] [rbp-30h]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  __int64 v54</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+1C8h] [rbp-28h]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  __int64 v55</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+1D0h] [rbp-20h]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  __int64 v56</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+1D8h] [rbp-18h]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  __int64 v57</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+1E0h] [rbp-10h]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  __int64 v58</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+1E8h] [rbp-8h]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>通过利用改写nft_jumpstack结构体，扩大越界读写范围。</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">unsigned int</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">nft_do_chain</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">struct nft_pktinfo </span><span class="token parameter operator" style="color:#393A34">*</span><span class="token parameter">pkt</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#00009f">void</span><span class="token parameter"> </span><span class="token parameter operator" style="color:#393A34">*</span><span class="token parameter">priv</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> struct nft_chain </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">chain </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> priv</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">basechain </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> chain</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> struct net </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">net </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">nft_net</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pkt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  struct nft_rule </span><span class="token operator" style="color:#393A34">*</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">rules</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> struct nft_rule </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">rule</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> struct nft_expr </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">expr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">last</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  struct nft_regs regs</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  unsigned int stackptr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  struct nft_jumpstack jumpstack</span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">NFT_JUMP_STACK_SIZE</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  bool genbit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">READ_ONCE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">net</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">nft</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">gencursor</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  struct nft_traceinfo info</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  info</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">trace</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">static_branch_unlikely</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">nft_trace_enabled</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">nft_trace_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pkt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">regs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">verdict</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> basechain</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">do_chain</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">genbit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rules </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rcu_dereference</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">chain</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">rules_gen_1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rules </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rcu_dereference</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">chain</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">rules_gen_0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">next_rule</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rule </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">rules</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  regs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">verdict</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">code</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NFT_CONTINUE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">rules </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> rules</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rule </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">rules</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">nft_rule_for_each_expr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">expr</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> last</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> rule</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">expr</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">ops </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">nft_cmp_fast_ops</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">nft_cmp_fast_eval</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">expr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">regs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">expr</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">ops </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">nft_bitwise_fast_ops</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">nft_bitwise_fast_eval</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">expr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">regs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">expr</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">ops </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">nft_payload_fast_ops </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token operator" style="color:#393A34">!</span><span class="token function" style="color:#d73a49">nft_payload_fast_eval</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">expr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">regs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pkt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">expr_call_ops_eval</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">expr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">regs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pkt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">regs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">verdict</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">code</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NFT_CONTINUE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">regs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">verdict</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">code</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NFT_BREAK</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      regs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">verdict</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">code</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NFT_CONTINUE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">continue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NFT_CONTINUE</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">nft_trace_packet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> chain</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rule</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token constant" style="color:#36acaa">NFT_TRACETYPE_RULE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">continue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">regs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">verdict</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">code</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NF_VERDICT_MASK</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NF_ACCEPT</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NF_DROP</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NF_QUEUE</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NF_STOLEN</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">nft_trace_packet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> chain</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rule</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token constant" style="color:#36acaa">NFT_TRACETYPE_RULE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> regs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">verdict</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">code</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">regs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">verdict</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">code</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NFT_JUMP</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">WARN_ON_ONCE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stackptr </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NFT_JUMP_STACK_SIZE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NF_DROP</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jumpstack</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">stackptr</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">chain</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> chain</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jumpstack</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">stackptr</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">rules</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rules </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stackptr</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fallthrough</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NFT_GOTO</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">nft_trace_packet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> chain</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rule</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token constant" style="color:#36acaa">NFT_TRACETYPE_RULE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chain </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> regs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">verdict</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">chain</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    goto do_chain</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NFT_CONTINUE</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NFT_RETURN</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">nft_trace_packet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> chain</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rule</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token constant" style="color:#36acaa">NFT_TRACETYPE_RETURN</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword module" style="color:#00009f">default</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token constant" style="color:#36acaa">WARN_ON</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stackptr </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stackptr</span><span class="token operator" style="color:#393A34">--</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chain </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> jumpstack</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">stackptr</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">chain</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rules </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> jumpstack</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">stackptr</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">rules</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    goto next_rule</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p> <img loading="lazy" src="/assets/images/065b65c4-aa16-41fc-92f1-ed336e8ba155-3c5cf086591cf206bd6a39e95d1efbf5.jpeg" width="2000" height="1333" class="img_ev3q"></p><p> <img loading="lazy" src="/assets/images/0c63e908-6b17-4832-a95a-e2e1fb9913e4-22b849ff21dc5315798ff33fcd1c4c6e.png" width="831" height="475" class="img_ev3q"></p><p>通过增加多个verdict.code为NFT_JUMP的规则，在规则执行后就会填充jumpstack数组，并在最后一个规则触发越界写，修改jumpstack数组，控制其中的rules指针，后续覆盖返回地址，做ROP即可。</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">struct unft_base_chain_param bp</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">hook_num</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NF_INET_PRE_ROUTING</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">prio</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">int i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> exp_chain_num</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">sprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exp_chain_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"%s%d"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"exp_chain"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">p </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             p </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">bp</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">create_chain</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nl</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> table_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exp_chain_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NFPROTO_BRIDGE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">seq</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">perror</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Failed creating exp chain"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">exit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">EXIT_FAILURE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">int i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> exp_chain_num</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">sprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exp_chain_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"%s%d"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"exp_chain"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">sprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exp_chain_name_next</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"%s%d"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"exp_chain"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        struct nftnl_rule</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> r </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">build_rule</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">table_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exp_chain_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NFPROTO_BRIDGE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">rule_add_payload</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">r</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NFT_PAYLOAD_LL_HEADER</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x40</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            char </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">cmp_str </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">MAGIC</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">rule_add_cmp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">r</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NFT_CMP_EQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cmp_str</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            uint64_t stack_value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stack </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xffff</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">rule_add_payload</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">r</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NFT_PAYLOAD_LL_HEADER</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x40</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">rule_add_cmp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">r</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NFT_CMP_EQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">stack_value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> exp_chain_num </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">rule_add_payload</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">r</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NFT_PAYLOAD_LL_HEADER</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x40</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// trigger</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">rule_add_immediate_verdict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">r</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NFT_JUMP</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exp_chain_name_next</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">send_batch_request</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nl</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token constant" style="color:#36acaa">NFT_MSG_NEWRULE</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">NFT_TYPE_RULE</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token constant" style="color:#36acaa">NLM_F_CREATE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NFPROTO_BRIDGE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">**</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">r</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">seq</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">puts</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">CLR_RED</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"[-] Set exp chain rule failed"</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">CLR_RESET</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">perror</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">""</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">exit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">EXIT_FAILURE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="条件三触发漏洞时内核上下文不确定">条件三：触发漏洞时内核上下文不确定<a href="#条件三触发漏洞时内核上下文不确定" class="hash-link" aria-label="条件三：触发漏洞时内核上下文不确定的直接链接" title="条件三：触发漏洞时内核上下文不确定的直接链接">​</a></h3><p>在recv接收数据时触发漏洞，所以不确定是在哪一个内核上下文中，栈溢出后也不能直接返回用户态。</p><p>不过多破坏栈上数据，在有限的栈空间内修改modprobe_path（在运行非ELF格式的二进制时，会以root权限调用该脚本）指向我们可控的脚本，最后调整rsp为上一层未破坏的栈帧，正常返回。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="0x04-总结">0x04 总结<a href="#0x04-总结" class="hash-link" aria-label="0x04 总结的直接链接" title="0x04 总结的直接链接">​</a></h2><p>netfilter子系统是一个相当复杂的系统，借助此文介绍了CVE-2023-0179的漏洞成因和漏洞利用过程中的一些注意点，希望能起到抛砖引玉的效果。</p>]]></content:encoded>
            <category>Linux</category>
            <category>Privilege Escalation</category>
        </item>
    </channel>
</rss>