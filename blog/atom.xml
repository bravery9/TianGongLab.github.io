<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://poc.qianxin.com/blog</id>
    <title>破壳漏洞挖掘平台文档系统 Blog</title>
    <updated>2023-10-25T00:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://poc.qianxin.com/blog"/>
    <subtitle>破壳漏洞挖掘平台文档系统 Blog</subtitle>
    <icon>https://poc.qianxin.com/img/favicon.ico</icon>
    <entry>
        <title type="html"><![CDATA[Microsoft Hyper-V 虚拟 TPM 设备漏洞分析]]></title>
        <id>https://poc.qianxin.com/blog/microsoft-hyper-vtpm</id>
        <link href="https://poc.qianxin.com/blog/microsoft-hyper-vtpm"/>
        <updated>2023-10-25T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[一、漏洞描述]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="一漏洞描述">一、漏洞描述<a href="#一漏洞描述" class="hash-link" aria-label="一、漏洞描述的直接链接" title="一、漏洞描述的直接链接">​</a></h2><p>2023年10月微软发布的安全更新中，修复了2个由笔者报送的Hyper-V虚拟TPM设备漏洞。本次修复的Hyper-V虚拟TPM组件的漏洞可以通过远程访问虚拟机的方式触发漏洞，造成宿主机拒绝服务或者远程代码执行，对宿主机上的其他虚拟机或业务造成损失。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="二背景介绍">二、背景介绍<a href="#二背景介绍" class="hash-link" aria-label="二、背景介绍的直接链接" title="二、背景介绍的直接链接">​</a></h2><p>Hyper-V的虚拟TPM组件旨在为虚拟机提供模拟的TPM设备，虚拟TPM设备可以为依赖TPM设备的服务或者操作系统（例如Windows 11）提供支持。</p><p>漏洞位于<code>vmsp.exe</code>进程中的<code>TpmEngUM.dll</code>二进制文件中，本次介绍的两个虚拟TPM组件的漏洞就是位于<code>TpmEngUM.dll</code>这个二进制文件中。</p><p><code>vmsp.exe</code>进程与<code>vmwp.exe</code>进程相似，都是一个虚拟机实例启动一个进程。但是不同的是<code>vmsp.exe</code>进程是隔离用户模式(IUM)进程，也就是说<code>vmsp.exe</code>进程无法在windows用户态下被正常attach。所以在调试上，针对<code>vmsp.exe</code>进程的调试就需要额外的“手脚”，这里我们引用Quarkslab博客的文章（<a href="https://blog.quarkslab.com/debugging-windows-isolated-user-mode-ium-processes.html%EF%BC%89%EF%BC%8C%E6%84%9F%E5%85%B4%E8%B6%A3%E7%9A%84%E8%AF%BB%E8%80%85%E5%8F%AF%E4%BB%A5%E5%8E%BB%E4%BA%86%E8%A7%A3%E5%B9%B6%E5%AE%9E%E8%B7%B5%E4%B8%8B%EF%BC%8C%E8%BF%99%E9%87%8C%E4%B8%8D%E5%81%9A%E8%AE%A8%E8%AE%BA%E3%80%82" target="_blank" rel="noopener noreferrer">https://blog.quarkslab.com/debugging-windows-isolated-user-mode-ium-processes.html），感兴趣的读者可以去了解并实践下，这里不做讨论。</a></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="三环境搭建">三、环境搭建<a href="#三环境搭建" class="hash-link" aria-label="三、环境搭建的直接链接" title="三、环境搭建的直接链接">​</a></h2><p>虚拟TPM组件漏洞的触发需要在Hyper-V虚拟机设置中的“安全”设置中，勾选“启用受信任的平台模块”。</p><p> <img loading="lazy" src="/assets/images/0c7d620e-97ff-45cc-a12f-b4c66a317e2a-73d520780556ca0a4fe552ce77213993.png" width="1214" height="869" class="img_ev3q"></p><p><strong>四、漏洞分析CVE-2023-36717</strong></p><p>该漏洞是一个拒绝服务漏洞，当这个漏洞被触发时会导致宿主机<code>vmsp.exe</code>进程进入死循环，并占用大量CPU计算资源。由于<code>vmsp.exe</code>进程是IUM进程，所以当漏洞被触发后，管理员无法从用户态结束掉这个进程，这种情况下除非重启宿主机操作系统否则计算资源一直无法被释放。</p><p>这个漏洞位于<code>TpmEngUM!TPM2_ECDH_KeyGen</code>函数中。</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">__int64 __fastcall </span><span class="token function maybe-class-name" style="color:#d73a49">TPM2_ECDH_KeyGen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">unsigned int </span><span class="token parameter operator" style="color:#393A34">*</span><span class="token parameter">a1</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> __int64 a2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token constant" style="color:#36acaa">OBJECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v3</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// rax</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token constant" style="color:#36acaa">OBJECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v4</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// rsi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  unsigned int v5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// eax</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  unsigned int v6</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// ebx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  unsigned __int16 v8</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">28</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+20h] [rbp-58h] BYREF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v3 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#d73a49">ObjectGet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">a1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v4 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> v3</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> v3</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_type </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x23</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v3</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_objectAttributes </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x10000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v3</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_objectAttributes </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x20000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> 0x19Ci64</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unsigned __int16</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#d73a49">cpri__GetEphemeralEcc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                               </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unsigned __int16 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a2 </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">104</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                               v8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                               v4</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_parameters_Detail_keyBits</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_WORD </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a2 </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x66</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#d73a49">TPMS_ECC_POINT_Marshal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_BYTE </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a2 </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">104</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> 0i64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> 0i64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    v5 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#d73a49">CryptEccPointMultiply</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_WORD </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a2 </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           v4</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_parameters_Detail_keyBits</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           v8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__int64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">v4</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_unique_ecc_x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    v6 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> v5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> v5 </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xA7</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> v5 </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x154</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      goto </span><span class="token constant" style="color:#36acaa">LABEL_9</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v6 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">156</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">LABEL_9</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">v6 </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_WORD </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">a2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#d73a49">TPMS_ECC_POINT_Marshal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_BYTE </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a2 </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> 0i64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> 0i64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> v6</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在<code>TpmEngUM!TPM2_ECDH_KeyGen</code>函数中，<code>v4-&gt;public_unique_ecc_x</code>成员可以从Guest中被控制，如果<code>v4-&gt;public_unique_ecc_x</code>成员是一个NULL ECC Point的情况下（<code>TPM2B_ECC_PARAMETER.size</code>为0x00,并且<code>TPM2B_ECC_PARAMETER.buffer</code>数组被0填充），<code>TpmEngUM!CryptEccPointMultiply</code>会一直返回错误码0x154，并不停的循环调用<code>TpmEngUM!CryptEccPointMultiply</code>函数，最终造成vmsp.exe进程死循环，导致宿主机拒绝服务。</p><p><strong>五、漏洞分析CVE-2023-36718</strong></p><p>该漏洞是远程代码执行漏洞，当这个漏洞被触发时会使用未初始化的栈空间变量。这个漏洞位于<code>TpmEngUM!CryptSecretEncrypt</code>函数中。</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">__int64 __fastcall </span><span class="token function maybe-class-name" style="color:#d73a49">CryptSecretEncrypt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">unsigned int a1</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> _BYTE </span><span class="token parameter operator" style="color:#393A34">*</span><span class="token parameter">a2_plabel</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> __int64 a3</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> __int16 </span><span class="token parameter operator" style="color:#393A34">*</span><span class="token parameter">a4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  unsigned int v7</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// ebx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token constant" style="color:#36acaa">OBJECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v8_obj</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// rax</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token constant" style="color:#36acaa">OBJECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v9_obj</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// rdi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  unsigned __int16 </span><span class="token maybe-class-name">DigestSize</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// ax</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  unsigned __int16 public_parameters_Detail_keyBits</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// cx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  __int16 public_nameAlg</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// cx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v14</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+40h] [rbp-C0h] BYREF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  __int16 v15</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">28</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+48h] [rbp-B8h] BYREF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  __int16 v16</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">56</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+80h] [rbp-80h] BYREF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  __int16 v17_Z_eccpointaftermul</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">56</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+F0h] [rbp-10h] BYREF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v7 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v8_obj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#d73a49">ObjectGet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v9_obj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> v8_obj</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">DigestSize</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">cpri__GetDigestSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v8_obj</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_nameAlg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_WORD </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">a3 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token maybe-class-name">DigestSize</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> v9_obj</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_type </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> v9_obj</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_type </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x23</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public_parameters_Detail_keyBits </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> v9_obj</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_parameters_Detail_keyBits</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    v14 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> a4 </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unsigned int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#d73a49">cpri__EccIsPointOnCurve</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         public_parameters_Detail_keyBits</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__int64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">v9_obj</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_unique_ecc_x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">cpri__GetEphemeralEcc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unsigned __int16 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">v16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unsigned __int16 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">v15</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v9_obj</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_parameters_Detail_keyBits</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">a4 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#d73a49">TPMS_ECC_POINT_Marshal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">v14</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> 0i64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unsigned int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function maybe-class-name" style="color:#d73a49">CryptEccPointMultiply</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           v17_Z_eccpointaftermul</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           v9_obj</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_parameters_Detail_keyBits</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unsigned __int16 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">v15</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__int64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">v9_obj</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_unique_ecc_x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        v7 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x9C</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#d73a49">BitIsSet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unsigned __int16</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">v9_obj</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_nameAlg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__int64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">g_toTest</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> 9u</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public_nameAlg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> v9_obj</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_nameAlg</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> public_nameAlg </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x10</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token function maybe-class-name" style="color:#d73a49">TestAlgorithm</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">public_nameAlg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> 0i64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">cpri__KDFe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        v9_obj</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_nameAlg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unsigned __int16 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">v17_Z_eccpointaftermul</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        a2_plabel</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unsigned __int16 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">v16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unsigned __int16 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">v9_obj</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_unique_ecc_x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unsigned __int16 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">a3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_BYTE </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a3 </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x9C</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> v7</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面代码中的<code>v17_Z_eccpointaftermul</code>是一个栈上的数组（也可能是个结构体），<code>v17_Z_eccpointaftermul</code>的大小是0x70字节。代码中的<code>v9_obj-&gt;public_unique_ecc_x</code>成员可以从Guest中被控制，当<code>v9_obj-&gt;public_unique_ecc_x</code>成员是一个NULL ECC Point的情况下<code>（TPM2B_ECC_PARAMETER.size</code>为0x00,并且<code>TPM2B_ECC_PARAMETER.buffer</code>数组被0填充），<code>TpmEngUM!CryptEccPointMultiply</code>函数会返回一个错误码并将v7设置为0x9C。</p><p>设置完v7的值之后，程序继续走到要调用<code>TpmEngUM!cpri__KDFe</code>函数这里，此时<code>v17_Z_eccpointaftermul</code>是一个栈上未初始化的数组，并作为<code>TpmEngUM!cpri__KDFe</code>函数的第二参数进入到之后的<code>TpmEngUM!cpri__KDFe</code>函数的代码流程里。</p><p>在<code>TpmEngUM!cpri__KDFe</code>函数后续的代码流程中，使用了未初始化的栈上的数据，导致越界读或者内存损坏。下面是崩溃时的现场：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">4afc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">2f4c</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Access</span><span class="token plain"> violation </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> code </span><span class="token function" style="color:#d73a49">c0000005</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">first chance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">First</span><span class="token plain"> chance exceptions are reported before any exception handling</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property-access maybe-class-name">This</span><span class="token plain"> exception may be expected and handled</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property-access maybe-class-name">TpmEngUM</span><span class="token operator" style="color:#393A34">!</span><span class="token maybe-class-name">SymCryptSha512AppendBlocks_ull</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0xa7</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00007ffb</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">38d9a42f 4d8b41f0        mov     r8,qword ptr [r9-10h] ds:00000000</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">00153ffe</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">??</span><span class="token operator" style="color:#393A34">??</span><span class="token operator" style="color:#393A34">??</span><span class="token operator" style="color:#393A34">??</span><span class="token operator" style="color:#393A34">??</span><span class="token operator" style="color:#393A34">??</span><span class="token operator" style="color:#393A34">??</span><span class="token operator" style="color:#393A34">??</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">000</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> k</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> # </span><span class="token maybe-class-name">Child</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">SP</span><span class="token plain">          </span><span class="token maybe-class-name">RetAddr</span><span class="token plain">           </span><span class="token maybe-class-name">Call</span><span class="token plain"> </span><span class="token maybe-class-name">Site</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">00</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00000000</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">0014ec80 00007ffb</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">38d99e01 </span><span class="token maybe-class-name">TpmEngUM</span><span class="token operator" style="color:#393A34">!</span><span class="token maybe-class-name">SymCryptSha512AppendBlocks_ull</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0xa7</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">01</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00000000</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">0014eed0 00007ffb</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">38d99e59 </span><span class="token maybe-class-name">TpmEngUM</span><span class="token operator" style="color:#393A34">!</span><span class="token maybe-class-name">SymCryptSha512Append</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x95</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">02</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00000000</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">0014ef10 00007ffb</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">38d87724 </span><span class="token maybe-class-name">TpmEngUM</span><span class="token operator" style="color:#393A34">!</span><span class="token maybe-class-name">SymCryptSha384Append</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x9</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">03</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00000000</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">0014ef40 00007ffb</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">38d66cd7 </span><span class="token maybe-class-name">TpmEngUM</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">cpri__KDFe</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x1a4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">04</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00000000</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">0014f110 00007ffb</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">38d7c7cd </span><span class="token maybe-class-name">TpmEngUM</span><span class="token operator" style="color:#393A34">!</span><span class="token maybe-class-name">CryptSecretEncrypt</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x143</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">05</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00000000</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">0014f2c0 00007ffb</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">38d70a54 </span><span class="token maybe-class-name">TpmEngUM</span><span class="token operator" style="color:#393A34">!</span><span class="token maybe-class-name">TPM2_MakeCredential</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x7d</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">06</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00000000</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">0014f340 00007ffb</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">38d61c54 </span><span class="token maybe-class-name">TpmEngUM</span><span class="token operator" style="color:#393A34">!</span><span class="token maybe-class-name">CommandDispatcher</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0xa78</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">07</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00000000</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">0014f420 00007ffb</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">38d61313 </span><span class="token maybe-class-name">TpmEngUM</span><span class="token operator" style="color:#393A34">!</span><span class="token maybe-class-name">ExecuteCommand</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x460</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">08</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00000000</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">0014f530 00000001</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">400c3862 </span><span class="token maybe-class-name">TpmEngUM</span><span class="token operator" style="color:#393A34">!</span><span class="token maybe-class-name">VTpmExecuteCommand</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x73</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>六、总结</strong></p><p>借助此文简单的介绍了下Hyper-V虚拟TPM组件的两个漏洞，可以发现这两个漏洞都是Hyper-V虚拟TPM组件在处理Guest数据时发生了错误导致宿主机进程受到了影响。通过本文帮助读者更好地理解虚拟TPM组件漏洞的成因，以及希望能够在TPM组件的漏洞挖掘工作中帮到大家。</p><p><strong>七、作者及介绍</strong></p><p>作者：洪祯皓</p><p>介绍：天工实验室安全研究员，专注于 Windows、云、虚拟化领域漏洞挖掘。曾多次获得微软 MSRC 最高漏洞赏金，荣登 2019，2020，2022 微软 MSRC 全球最具价值安全精英榜，连续两年 BlackHat USA 世界黑帽大会 Speaker。</p>]]></content>
        <author>
            <name>洪祯皓</name>
        </author>
        <category label="Microsoft" term="Microsoft"/>
        <category label="Hyper-V" term="Hyper-V"/>
        <category label="TPM" term="TPM"/>
    </entry>
</feed>