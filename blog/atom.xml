<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://poc.qianxin.com/blog</id>
    <title>破壳漏洞挖掘平台文档系统 Blog</title>
    <updated>2023-11-03T00:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://poc.qianxin.com/blog"/>
    <subtitle>破壳漏洞挖掘平台文档系统 Blog</subtitle>
    <icon>https://poc.qianxin.com/img/favicon.ico</icon>
    <entry>
        <title type="html"><![CDATA[伪随机数问题浅析]]></title>
        <id>https://poc.qianxin.com/blog/research-on-windows-kernel-race-condition-vulnerabilities</id>
        <link href="https://poc.qianxin.com/blog/research-on-windows-kernel-race-condition-vulnerabilities"/>
        <updated>2023-11-03T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[0x01 前言]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="0x01-前言">0x01 前言<a href="#0x01-前言" class="hash-link" aria-label="0x01 前言的直接链接" title="0x01 前言的直接链接">​</a></h2><p>随机数在许多科学和工程领域扮演着重要角色，尤其在计算机科学和信息安全领域，它的重要意义更是不可小觑。在这个全球数字化的时代，数据是我们经济和生活的核心，数据的安全和保密显得尤为重要。我们使用密码保护我们的银行账户、电子邮件、社交媒体账户，我们使用加密技术保护我们通信的隐私性。在这些过程中，随机数是其中最重要的一部分，它用于密码生成、数据加密、身份验证和网络协议安全，是保证电子交流安全的令牌。如果我们不能保证所生成的随机数实际上是随机的，那么它们就可能被预测，这将让我们面临安全风险。因此，在探讨随机数的同时，我们须深化理解随机性的安全性，以便更有效地使用随机数，保护自身和数据免受攻击。</p><p>本次分享的两个案例（CVE-2023-42820和CVE-2022-35890）均是由于随机数使用不当从而导致了更加严重的安全问题</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="0x02-随机数相关基础知识">0x02 随机数相关基础知识<a href="#0x02-随机数相关基础知识" class="hash-link" aria-label="0x02 随机数相关基础知识的直接链接" title="0x02 随机数相关基础知识的直接链接">​</a></h2><p>根据密码学原理，随机数的随机性检验可以分为三个标准：</p><ol><li>统计学伪随机性：在给定的随机比特流样本中，1的数量大致等于0的数量，满足这类要求的数字在人类“一眼看上去”是随机的</li><li>密码学安全伪随机性：给定随机样本的一部分和随机算法，不能有效的演算出随机样本的剩余部分</li><li>真随机性：随机样本不可重现</li></ol><p>相应的，随机数也分为三类：</p><ol><li><p><strong>伪随机数</strong>：满足第一个条件的随机数</p></li><li><p><strong>密码学安全的伪随机数</strong>：同时满足前两个条件的随机数，可以通过密码学安全伪随机数生成器计算得出</p></li><li><p><strong>真随机数</strong>：同时满足三个条件的随机数</p><ul><li>密码学安全伪随机数生成器（CSPRNG）</li></ul><p>相较于统计学伪随机数生成器和更弱的伪随机数生成器，CSPRNG所生成的密码学安全伪随机数具有额外的伪随机属性，简单来说CSPRNG本质上属于一种单向函数</p><p> <img loading="lazy" alt="随机数分类与关系图" src="/assets/images/25e7fb3b-96a3-4eac-87c0-7f570b849279-c4e876978ac0e1dded9bfc991a531436.png" width="1920" height="670" class="img_ev3q"></p></li></ol><p>这是一个使用python random库生成随机数的例子</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">import</span><span class="token plain"> random</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> random.seed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">123</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> random.random</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0.052363598850944326</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> random.random</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0.08718667752263232</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> random.seed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">123</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> random.random</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0.052363598850944326</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> random.random</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0.08718667752263232</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> random.random</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0.4072417636703983</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> random.seed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">123</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> random.random</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0.052363598850944326</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>对于随机数的使用，一般是先播种，然后使用rand来获取随机数。不播种会使用默认的种子，不同的语言不通版本种子可能不一样。这种通过rand出来的随机数，就是伪随机数，只要种子固定那么每次生成的随机数序列就会一样，同时通过上面的例子，可以发现以下特点：</p><ul><li><p>在播种后会重置随机序列</p></li><li><p>random.seed()进行播种时并没有产生新的对象，就会对后面的random产生影响，那么推断<strong>播种后种子对播种时的整个进程生效</strong></p><ul><li>对于Java这种有新对象生成的语言来说，如果每次都是调用的同一个对象，那么与上面的情况一致，<strong>播种后会对这个对象后面生成的随机数产生影响</strong></li></ul><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class A{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Random random;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void init(){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        long seed = 123456L;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.random = new Random(seed);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.init();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int num = this.random.nextInt(100);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int num2 = this.random.nextInt(100);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(num + " " + num2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="0x03-经典案例分析">0x03 经典案例分析<a href="#0x03-经典案例分析" class="hash-link" aria-label="0x03 经典案例分析的直接链接" title="0x03 经典案例分析的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="案例1jumpserver-任意账户密码重置cve-2023-42820">案例1——JumpServer 任意账户密码重置(CVE-2023-42820)<a href="#案例1jumpserver-任意账户密码重置cve-2023-42820" class="hash-link" aria-label="案例1——JumpServer 任意账户密码重置(CVE-2023-42820)的直接链接" title="案例1——JumpServer 任意账户密码重置(CVE-2023-42820)的直接链接">​</a></h3><blockquote><p><em>JumpServer 是广受欢迎的国产开源堡垒机，是符合 4A 规范的专业运维安全审计系统</em></p></blockquote><p><strong>漏洞位于找回密码时，生成的6位验证码算法是伪随机，伪随机的种子可获取，从而可以预测验证码，最终重置任意账户密码</strong></p><p>jumperserver找回密码时的流程如下图（这里借用一个知识星球中的流程图</p><p> <img loading="lazy" src="/assets/images/d840c8a2-98ab-433f-9af9-dbef59d82ffb-02f96f540e225fa2657a29ca38f05c9f.png" width="896" height="854" class="img_ev3q"></p><p>看起来流程似乎没有问题，但问题出现在<strong>随机数种子</strong>在请求验证码图片时直接展示给用户，下面从源码入手查看逻辑</p><p>先看验证码生成的逻辑</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">captcha_image</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> scale</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> scale </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> settings</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CAPTCHA_2X_IMAGE</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">raise</span><span class="token plain"> Http404</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">try</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        store </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> CaptchaStore</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">objects</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hashkey</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">except</span><span class="token plain"> CaptchaStore</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DoesNotExist</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># HTTP 410 Gone status so that crawlers don't index these expired urls.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> HttpResponse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">status</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">410</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    random</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">seed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Do not generate different images for the same key</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            </span><span class="token comment" style="color:#999988;font-style:italic"># 这里的种子是外面传进来的参数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    text </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> store</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">challenge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><a href="https://github.com/mbi/django-simple-captcha/blob/master/captcha/views.py" target="_blank" rel="noopener noreferrer">https://github.com/mbi/django-simple-captcha/blob/master/captcha/views.py</a></p><p>寻找这个函数的调用处</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> django</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">urls </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> re_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> captcha </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> views</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">urlpatterns </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    re_path</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">r"image/(?P&lt;key&gt;\w+)/$"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        views</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">captcha_image</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"captcha-image"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kwargs</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">"scale"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    re_path</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">r"image/(?P&lt;key&gt;\w+)@2/$"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        views</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">captcha_image</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"captcha-image-2x"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kwargs</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">"scale"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    re_path</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">r"audio/(?P&lt;key&gt;\w+).wav$"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> views</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">captcha_audio</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"captcha-audio"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    re_path</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">r"refresh/$"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> views</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">captcha_refresh</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"captcha-refresh"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><a href="https://github.com/mbi/django-simple-captcha/blob/master/captcha/urls.py#L9" target="_blank" rel="noopener noreferrer">https://github.com/mbi/django-simple-captcha/blob/master/captcha/urls.py#L9</a></p><p>可以发现key的值就存在于请求的url中，如下</p><p> <img loading="lazy" src="/assets/images/90c8eae3-425b-4b89-89ae-fd933b7ddf01-f36aaeac6089c1bb655d69c0e91e91ef.png" width="1080" height="142" class="img_ev3q"></p><p>这样就满足了随机数种子可知的条件</p><p>再看密码找回地方的逻辑</p><p> <img loading="lazy" src="/assets/images/bb7fd835-eebe-4b21-a9e7-c1eaa1f7e5a3-f06193bcc235d972c841b6a9ec74b52a.png" width="1080" height="570" class="img_ev3q"></p><p>这里可以发现生成验证码也使用random函数，并且没有进行重新播种，故后续的随机序列完全可以计算出来，从而导致6位验证码可以直接计算出来</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="修复">修复<a href="#修复" class="hash-link" aria-label="修复的直接链接" title="修复的直接链接">​</a></h3><p><a href="https://github.com/jumpserver/jumpserver/commit/ce645b1710c5821119f313e1b3d801470565aac" target="_blank" rel="noopener noreferrer">fix: 修复 random error · jumpserver/jumpserver@ce645b1 · GitHub</a></p><p> <img loading="lazy" src="/assets/images/80ed7e56-6479-4e15-8d03-805762876ac8-303a4ff4c68a734c2eb0cf43ce198d15.png" width="1138" height="551" class="img_ev3q"></p><p>patch是直接重新将None作为种子进行播种</p><blockquote><p><em>random.seed(a=None, version=2) If a is omitted or None , the current system time is used. If randomness sources are provided by the operating system, they are used instead of the system time (see the os.urandom() function for details on availability).</em></p></blockquote><p>查看手册，使用None作为种子，则</p><ul><li>使用系统提供的随机数发生器（/dev/urandom）作为种子</li><li>使用当前时间作为种子</li></ul><p>这样就避免了生成6位验证码时，种子已知从而可以被预测后续随机数的情况</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="案例2inductive-ignition-session劫持cve-2022-35890">案例2——Inductive Ignition session劫持(CVE-2022-35890)<a href="#案例2inductive-ignition-session劫持cve-2022-35890" class="hash-link" aria-label="案例2——Inductive Ignition session劫持(CVE-2022-35890)的直接链接" title="案例2——Inductive Ignition session劫持(CVE-2022-35890)的直接链接">​</a></h2><blockquote><p><em>Inductive Automation Ignition是美国Inductive Automation公司的一套用于SCADA系统的集成软件平台。该平台支持SCADA（数据采集与监控系统）、HMI（人机界面）等</em></p></blockquote><blockquote><p>ignition 是2022年pwn2own的比赛项目，该漏洞在比赛中被使用。</p></blockquote><p><strong>漏洞源于生成session使用的算法在Windows下为伪随机函数，且未使用默认种子，还可以通过特定方法泄露出seed大概范围，最终结合一定次数的爆破即可劫持真正session</strong></p><p>先看种子初始化的部分</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private void initRandom() throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    long seed = System.currentTimeMillis();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char[] entropy = ENTROPY;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (int i = 0; i &lt; entropy.length; ++i) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        long update = (byte)entropy[i] &lt;&lt; i % 8 * 8;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        seed ^= update;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.random = new SecureRandom();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.random.setSeed(seed);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.digest = MessageDigest.getInstance("SHA-1");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>initRandom位于GatewaySessionManager刚启动时，这里初始化了种子，使用的随机函数为java.security.SecureRandom()</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public GWSession createSession() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GWSession session = new GWSession(this.generateSessionId());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    session.startup(this.context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.sessions.put(session.getId(), session);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.log.debug((Object)("Created new session: " + session.getPublicId()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.statusTags.refresh();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return session;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>创建session位于用户成功登录处，再看具体生成session的算法</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">protected synchronized String generateSessionId() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    byte[] random = new byte[16];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String result = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    StringBuffer buffer = new StringBuffer();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int resultLenBytes = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (result != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            buffer = new StringBuffer();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ++this.duplicates;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while (resultLenBytes &lt; this.sessionIdLength) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.random.nextBytes(random);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            random = this.digest.digest(random);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (int j = 0; j &lt; random.length &amp;&amp; resultLenBytes &lt; this.sessionIdLength; ++resultLenBytes, ++j) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                byte b1 = (byte)((random[j] &amp; 0xF0) &gt;&gt; 4);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                byte b2 = (byte)(random[j] &amp; 0xF);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (b1 &lt; 10) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    buffer.append((char)(48 + b1));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    buffer.append((char)(65 + (b1 - 10)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (b2 &lt; 10) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    buffer.append((char)(48 + b2));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    continue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                buffer.append((char)(65 + (b2 - 10)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } while (this.sessions.get(result = buffer.toString()) != null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里使用了this.random生成随机数，也就是上面播种了时间戳作为种子的随机函数，那么可能存在被预测的风险</p><p>查询java.security.SecureRandom在windows平台上底层调用的函数，在stack overflow上找到了类似的问题</p><ul><li><p>Q: <em>I am interested in</em>&nbsp;<code>java.util.Random</code>&nbsp;and&nbsp;<code>java.security.SecureRandom</code>&nbsp;classes. I found that&nbsp;<code>Random</code>&nbsp;uses system clock to generate seed and&nbsp;<code>SecureRandom</code>&nbsp;uses&nbsp;<code>/dev/random</code>&nbsp;or&nbsp;<code>/dev/urandom</code>&nbsp;but these files are on Linux, while on Windows it uses some mistic&nbsp;<code>CryptGenRandom</code>. Even if that is super secure function, do we know from where does it take values? What is the basement to generate seed?</p><blockquote><p>我对 java.util.Random 和 java.security.SecureRandom 类感兴趣。 我发现 Random 使用系统时钟生成种子，SecureRandom 使用 /dev/random 或 /dev/urandom，但这些文件位于 Linux 上，而在 Windows 上则使用一些神秘的 CryptGenRandom。 即使这是超级安全的函数，我们知道它从哪里获取值吗？ 生成种子的底层逻辑是什么？</p></blockquote></li><li><p>A: <em>In Windows&nbsp;SecureRandom&nbsp;uses the method&nbsp;CryptGenRandom&nbsp;that is part of WinCrypt Windows library (Included in Advapi32.dll of Windows System libraries).</em></p><blockquote><p>在 Windows SecureRandom 中，使用 CryptGenRandom 方法，该方法是 WinCrypt Windows 库的一部分（包含在 Windows 系统库的 Advapi32.dll 中）</p></blockquote></li></ul><p>下面是微软官方手册对<em>CryptGenRandom</em>的描述（节选）</p><ul><li><p><em>Software random number generators work in fundamentally the same way. They start with a random number, known as the seed, and then use an algorithm to generate a pseudo-random sequence of bits based on it. The most difficult part of this process is to get a seed that is truly random. This is usually based on user input latency, or the jitter from one or more hardware components.</em></p><blockquote><p>软件随机数生成器的工作方式基本相同。 他们从一个随机数（称为种子）开始，然后使用算法生成基于它的<!-- -->`<strong>伪随机位序列</strong>。 这个过程中最困难的部分是获得真正随机的种子。 这通常基于用户输入延迟或来自一个或多个硬件组件的抖动。</p></blockquote></li></ul><p>通过手册，我们可知Windows底层调用的是个伪随机函数，并且默认情况下使用的种子是一个很难预测的值，但是ignition中错误的使用了系统时间作为种子</p><p><strong>如何获得伪随机种子？</strong></p><p>在ignition gateway中，有一个特殊的servlet，<code>scriptModules</code> 用于获取第三方的脚本，最终将其打包返回一个zip</p><p>直接跟到对应逻辑处</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">void zipThirdPartyScriptModulesAndCalcHash() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      this.thirdPartyZipValid = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Object object = this.thirdPartyZipLock;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      synchronized (object) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          if (this.thirdPartyZipValid) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              File pylibDir = this.getThirdPartyScriptModulesDir();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              ZipMap zipMap = new ZipMap();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              this.addDirToZip(pylibDir, pylibDir, zipMap);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              File tempFile = new File(this.systemManager.getTempDir(), "pylib_compressed.zip");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              zipMap.writeToFile(tempFile);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              this.thirdPartyScriptModulesHash = Files.hash((File)tempFile, (HashFunction)Hashing.md5()).toString();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              this.log.error("Error calculating 3rd party script zip hash.", (Throwable)e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              this.thirdPartyScriptModulesHash = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              this.thirdPartyZipValid = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              this.thirdPartyZipLock.notifyAll();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>pylib_compressed.zip在每次ignition启动时都会重新生成，对于文件来说会有一个最后修改时间的属性，同时上面所说的随机数初始化时使用的时间戳也会与这个时间接近</p><p>查看启动日志可以看到先生成了seed后启动ignition gateway，那么只需要在zip的最后修改时间值减去delay即可，一般来说2s足矣</p><p><strong>那么在爆破seed时如何知道当前session是否正确？</strong></p><p>在gateway中处理数据包时存在如下逻辑</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">if (!versionHash.isDev() &amp;&amp; msg.getVersion() != 0L &amp;&amp; versionHash.getHash() != msg.getVersion()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (session != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            session.setMaxInactiveInterval(10);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.printErrorResponse((PrintWriter)out, 309, "Version mismatch", false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>此处逻辑位于session校验之后，也就是说故意设置错误的version，当session验证通过时，即可在返回包中看到309的响应</p><p>至此完成了整个session劫持的流程</p><p>重新梳理一下整个流程：</p><p>通过scriptModules获取到ignition启动的时间 → 将时间-delay作为初始种子 → 使用初始种子计算session → 验证当前session是否正确 → 种子+1（直至正确）</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="修复-1">修复<a href="#修复-1" class="hash-link" aria-label="修复的直接链接" title="修复的直接链接">​</a></h3><p>查看修复后的版本代码</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">protected synchronized String generateSessionId() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        result = AuthUtil.generateRandomBase64String(32);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } while(this.sessions.get(result) != null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>新版本直接删掉了initRandom函数，并修改了生成session的逻辑，跟进</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public static String generateRandomBase64String(int entropyCountInBytes) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      assert entropyCountInBytes &gt; 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      byte[] bytes = new byte[entropyCountInBytes];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      SecureRandomProvider.get().nextBytes(bytes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return BASE64_ENCODER.encodeToString(bytes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>继续跟进</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public void nextBytes(byte[] bytes) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      LOG.tracef("nextBytes(bytes.length=%s)...", new Object[]{bytes.length});</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      this.secureRandom.nextBytes(bytes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      LOG.trace("Done.");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>看到使用的函数仍然是伪随机函数，查看seed是否可以推测</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private SecureRandomProvider() throws NoSuchAlgorithmException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOG.debug("Creating SecureRandom object...");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.secureRandom = SecureRandom.getInstance("SHA1PRNG");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    byte[] seed = new byte[128];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    (new Random()).nextBytes(seed);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.secureRandom.setSeed(seed);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.secureRandom.nextBytes(new byte[128]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    (new Thread(new SeedGenerator(), "secure-random-seed-gen")).start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOG.debug("... SecureRandom Created.");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里seed生成虽然使用了伪随机函数random().nextbytes()，（random函数默认使用timestamp作为种子）但是由于每次生成session时都需要调用一遍这个流程，使用的seed为当前时间，所以每次生成session时的seed没法通过之前的方法进行推测，从而使得session的值不可计算，最终防止了session被劫持的风险</p><p>这里还有另一种修复方法，即使用java.security.SecureRandom默认种子即可，不进行setseed</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="0x04-漏洞模式总结">0x04 漏洞模式总结<a href="#0x04-漏洞模式总结" class="hash-link" aria-label="0x04 漏洞模式总结的直接链接" title="0x04 漏洞模式总结的直接链接">​</a></h2><p>使用不安全的随机函数 → 种子可知/可预测 → 随机数可计算 → 造成更严重的安全问题</p><p>上面的两个案例的修复方法均是对种子进行处理，防止种子可以被预测，从而修复原有的安全问题</p><p>同样，也可以通过将<strong>伪随机函数</strong>修改为<strong>安全随机函数</strong>的方法来解决上述安全问题（但安全随机函数可能并没有伪随机函数效率高）</p><table><thead><tr><th>语言</th><th>常见伪随机函数</th><th>安全随机函数</th></tr></thead><tbody><tr><td>C</td><td>srand</td><td>linux 使用/dev/urandom</td></tr><tr><td></td><td>rand</td><td>Windows使用CryptGenRandom并使用默认种子</td></tr><tr><td>C++</td><td>mt19937</td><td>C++使用std::random_device 类来获取安全的随机种子</td></tr><tr><td></td><td>default_random_engine</td><td></td></tr><tr><td>python</td><td>random</td><td>secrets</td></tr><tr><td>java</td><td>java.security.SecureRandom  //强伪随机函数</td><td>SecureRandom.getInstanceStrong</td></tr><tr><td></td><td>java.util.Random   //弱伪随机数</td><td></td></tr><tr><td>php</td><td>mt_scrand   mt_rand</td><td>random_bytes</td></tr><tr><td>C#</td><td>Random</td><td>System.Security.Cryptography.RNGCryptoServiceProvider</td></tr><tr><td>golang</td><td>math/rand</td><td>crypto/rand</td></tr></tbody></table><p>如果种子不可预测，那么伪随机数序列就难以预测，称为强伪随机数</p><p>如果种子可预测，那么随机数序列就通常可以预测，称为弱随机数</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="0x05-reference">0x05 Reference<a href="#0x05-reference" class="hash-link" aria-label="0x05 Reference的直接链接" title="0x05 Reference的直接链接">​</a></h2><p><a href="https://mp.weixin.qq.com/s/VShjaDI1McerX843YyOENw" target="_blank" rel="noopener noreferrer">https://mp.weixin.qq.com/s/VShjaDI1McerX843YyOENw</a></p><p><a href="https://github.com/vulhub/vulhub/blob/master/jumpserver/CVE-2023-42820/README.zh-cn.md" target="_blank" rel="noopener noreferrer">https://github.com/vulhub/vulhub/blob/master/jumpserver/CVE-2023-42820/README.zh-cn.md</a></p><p><a href="https://www.leavesongs.com/PENETRATION/jumpserver-sep-2023-multiple-vulnerabilities-go-through.html" target="_blank" rel="noopener noreferrer">https://www.leavesongs.com/PENETRATION/jumpserver-sep-2023-multiple-vulnerabilities-go-through.html</a></p><p><a href="https://github.com/sourceincite/randy" target="_blank" rel="noopener noreferrer">https://github.com/sourceincite/randy</a></p><p><a href="https://stackoverflow.com/questions/53496652/seed-to-java-security-securerandom-on-windows-os" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/53496652/seed-to-java-security-securerandom-on-windows-os</a></p><p><a href="https://learn.microsoft.com/en-us/windows/win32/api/wincrypt/nf-wincrypt-cryptgenrandom" target="_blank" rel="noopener noreferrer">https://learn.microsoft.com/en-us/windows/win32/api/wincrypt/nf-wincrypt-cryptgenrandom</a></p>]]></content>
        <author>
            <name>王垚</name>
        </author>
        <category label="Cryptography" term="Cryptography"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Windows内核竞态条件漏洞研究]]></title>
        <id>https://poc.qianxin.com/blog/research-on-windows-kernel-race-condition-vulnerabilities</id>
        <link href="https://poc.qianxin.com/blog/research-on-windows-kernel-race-condition-vulnerabilities"/>
        <updated>2023-11-01T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[一、研究背景]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="0x01-前言">0x01 前言<a href="#0x01-前言" class="hash-link" aria-label="0x01 前言的直接链接" title="0x01 前言的直接链接">​</a></h2><p>随机数在许多科学和工程领域扮演着重要角色，尤其在计算机科学和信息安全领域，它的重要意义更是不可小觑。在这个全球数字化的时代，数据是我们经济和生活的核心，数据的安全和保密显得尤为重要。我们使用密码保护我们的银行账户、电子邮件、社交媒体账户，我们使用加密技术保护我们通信的隐私性。在这些过程中，随机数是其中最重要的一部分，它用于密码生成、数据加密、身份验证和网络协议安全，是保证电子交流安全的令牌。如果我们不能保证所生成的随机数实际上是随机的，那么它们就可能被预测，这将让我们面临安全风险。因此，在探讨随机数的同时，我们须深化理解随机性的安全性，以便更有效地使用随机数，保护自身和数据免受攻击。</p><p>本次分享的两个案例（CVE-2023-42820和CVE-2022-35890）均是由于随机数使用不当从而导致了更加严重的安全问题</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="0x02-随机数相关基础知识">0x02 随机数相关基础知识<a href="#0x02-随机数相关基础知识" class="hash-link" aria-label="0x02 随机数相关基础知识的直接链接" title="0x02 随机数相关基础知识的直接链接">​</a></h2><p>根据密码学原理，随机数的随机性检验可以分为三个标准：</p><ol><li>统计学伪随机性：在给定的随机比特流样本中，1的数量大致等于0的数量，满足这类要求的数字在人类“一眼看上去”是随机的</li><li>密码学安全伪随机性：给定随机样本的一部分和随机算法，不能有效的演算出随机样本的剩余部分</li><li>真随机性：随机样本不可重现</li></ol><p>相应的，随机数也分为三类：</p><ol><li><p><strong>伪随机数</strong>：满足第一个条件的随机数</p></li><li><p><strong>密码学安全的伪随机数</strong>：同时满足前两个条件的随机数，可以通过密码学安全伪随机数生成器计算得出</p></li><li><p><strong>真随机数</strong>：同时满足三个条件的随机数</p><ul><li>密码学安全伪随机数生成器（CSPRNG）</li></ul><p>相较于统计学伪随机数生成器和更弱的伪随机数生成器，CSPRNG所生成的密码学安全伪随机数具有额外的伪随机属性，简单来说CSPRNG本质上属于一种单向函数</p><p> <img loading="lazy" alt="随机数分类与关系图" src="/assets/images/25e7fb3b-96a3-4eac-87c0-7f570b849279-c4e876978ac0e1dded9bfc991a531436.png" width="1920" height="670" class="img_ev3q"></p></li></ol><p>这是一个使用python random库生成随机数的例子</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">import</span><span class="token plain"> random</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> random.seed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">123</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> random.random</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0.052363598850944326</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> random.random</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0.08718667752263232</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> random.seed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">123</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> random.random</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0.052363598850944326</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> random.random</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0.08718667752263232</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> random.random</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0.4072417636703983</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> random.seed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">123</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> random.random</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0.052363598850944326</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>对于随机数的使用，一般是先播种，然后使用rand来获取随机数。不播种会使用默认的种子，不同的语言不通版本种子可能不一样。这种通过rand出来的随机数，就是伪随机数，只要种子固定那么每次生成的随机数序列就会一样，同时通过上面的例子，可以发现以下特点：</p><ul><li><p>在播种后会重置随机序列</p></li><li><p>random.seed()进行播种时并没有产生新的对象，就会对后面的random产生影响，那么推断<strong>播种后种子对播种时的整个进程生效</strong></p><ul><li>对于Java这种有新对象生成的语言来说，如果每次都是调用的同一个对象，那么与上面的情况一致，<strong>播种后会对这个对象后面生成的随机数产生影响</strong></li></ul><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class A{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Random random;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void init(){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        long seed = 123456L;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.random = new Random(seed);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.init();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int num = this.random.nextInt(100);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int num2 = this.random.nextInt(100);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(num + " " + num2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="0x03-经典案例分析">0x03 经典案例分析<a href="#0x03-经典案例分析" class="hash-link" aria-label="0x03 经典案例分析的直接链接" title="0x03 经典案例分析的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="案例1jumpserver-任意账户密码重置cve-2023-42820">案例1——JumpServer 任意账户密码重置(CVE-2023-42820)<a href="#案例1jumpserver-任意账户密码重置cve-2023-42820" class="hash-link" aria-label="案例1——JumpServer 任意账户密码重置(CVE-2023-42820)的直接链接" title="案例1——JumpServer 任意账户密码重置(CVE-2023-42820)的直接链接">​</a></h3><blockquote><p><em>JumpServer 是广受欢迎的国产开源堡垒机，是符合 4A 规范的专业运维安全审计系统</em></p></blockquote><p><strong>漏洞位于找回密码时，生成的6位验证码算法是伪随机，伪随机的种子可获取，从而可以预测验证码，最终重置任意账户密码</strong></p><p>jumperserver找回密码时的流程如下图（这里借用一个知识星球中的流程图</p><p> <img loading="lazy" src="/assets/images/d840c8a2-98ab-433f-9af9-dbef59d82ffb-02f96f540e225fa2657a29ca38f05c9f.png" width="896" height="854" class="img_ev3q"></p><p>看起来流程似乎没有问题，但问题出现在<strong>随机数种子</strong>在请求验证码图片时直接展示给用户，下面从源码入手查看逻辑</p><p>先看验证码生成的逻辑</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">captcha_image</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> scale</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> scale </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> settings</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CAPTCHA_2X_IMAGE</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">raise</span><span class="token plain"> Http404</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">try</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        store </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> CaptchaStore</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">objects</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hashkey</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">except</span><span class="token plain"> CaptchaStore</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DoesNotExist</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># HTTP 410 Gone status so that crawlers don't index these expired urls.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> HttpResponse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">status</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">410</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    random</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">seed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Do not generate different images for the same key</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            </span><span class="token comment" style="color:#999988;font-style:italic"># 这里的种子是外面传进来的参数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    text </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> store</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">challenge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><a href="https://github.com/mbi/django-simple-captcha/blob/master/captcha/views.py" target="_blank" rel="noopener noreferrer">https://github.com/mbi/django-simple-captcha/blob/master/captcha/views.py</a></p><p>寻找这个函数的调用处</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> django</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">urls </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> re_path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> captcha </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> views</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">urlpatterns </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    re_path</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">r"image/(?P&lt;key&gt;\w+)/$"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        views</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">captcha_image</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"captcha-image"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kwargs</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">"scale"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    re_path</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">r"image/(?P&lt;key&gt;\w+)@2/$"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        views</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">captcha_image</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"captcha-image-2x"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kwargs</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">"scale"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    re_path</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">r"audio/(?P&lt;key&gt;\w+).wav$"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> views</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">captcha_audio</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"captcha-audio"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    re_path</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">r"refresh/$"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> views</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">captcha_refresh</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"captcha-refresh"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><a href="https://github.com/mbi/django-simple-captcha/blob/master/captcha/urls.py#L9" target="_blank" rel="noopener noreferrer">https://github.com/mbi/django-simple-captcha/blob/master/captcha/urls.py#L9</a></p><p>可以发现key的值就存在于请求的url中，如下</p><p> <img loading="lazy" src="/assets/images/90c8eae3-425b-4b89-89ae-fd933b7ddf01-f36aaeac6089c1bb655d69c0e91e91ef.png" width="1080" height="142" class="img_ev3q"></p><p>这样就满足了随机数种子可知的条件</p><p>再看密码找回地方的逻辑</p><p> <img loading="lazy" src="/assets/images/bb7fd835-eebe-4b21-a9e7-c1eaa1f7e5a3-f06193bcc235d972c841b6a9ec74b52a.png" width="1080" height="570" class="img_ev3q"></p><p>这里可以发现生成验证码也使用random函数，并且没有进行重新播种，故后续的随机序列完全可以计算出来，从而导致6位验证码可以直接计算出来</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="修复">修复<a href="#修复" class="hash-link" aria-label="修复的直接链接" title="修复的直接链接">​</a></h3><p><a href="https://github.com/jumpserver/jumpserver/commit/ce645b1710c5821119f313e1b3d801470565aac" target="_blank" rel="noopener noreferrer">fix: 修复 random error · jumpserver/jumpserver@ce645b1 · GitHub</a></p><p> <img loading="lazy" src="/assets/images/80ed7e56-6479-4e15-8d03-805762876ac8-303a4ff4c68a734c2eb0cf43ce198d15.png" width="1138" height="551" class="img_ev3q"></p><p>patch是直接重新将None作为种子进行播种</p><blockquote><p><em>random.seed(a=None, version=2) If a is omitted or None , the current system time is used. If randomness sources are provided by the operating system, they are used instead of the system time (see the os.urandom() function for details on availability).</em></p></blockquote><p>查看手册，使用None作为种子，则</p><ul><li>使用系统提供的随机数发生器（/dev/urandom）作为种子</li><li>使用当前时间作为种子</li></ul><p>这样就避免了生成6位验证码时，种子已知从而可以被预测后续随机数的情况</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="案例2inductive-ignition-session劫持cve-2022-35890">案例2——Inductive Ignition session劫持(CVE-2022-35890)<a href="#案例2inductive-ignition-session劫持cve-2022-35890" class="hash-link" aria-label="案例2——Inductive Ignition session劫持(CVE-2022-35890)的直接链接" title="案例2——Inductive Ignition session劫持(CVE-2022-35890)的直接链接">​</a></h2><blockquote><p><em>Inductive Automation Ignition是美国Inductive Automation公司的一套用于SCADA系统的集成软件平台。该平台支持SCADA（数据采集与监控系统）、HMI（人机界面）等</em></p></blockquote><blockquote><p>ignition 是2022年pwn2own的比赛项目，该漏洞在比赛中被使用。</p></blockquote><p><strong>漏洞源于生成session使用的算法在Windows下为伪随机函数，且未使用默认种子，还可以通过特定方法泄露出seed大概范围，最终结合一定次数的爆破即可劫持真正session</strong></p><p>先看种子初始化的部分</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private void initRandom() throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    long seed = System.currentTimeMillis();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char[] entropy = ENTROPY;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (int i = 0; i &lt; entropy.length; ++i) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        long update = (byte)entropy[i] &lt;&lt; i % 8 * 8;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        seed ^= update;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.random = new SecureRandom();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.random.setSeed(seed);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.digest = MessageDigest.getInstance("SHA-1");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>initRandom位于GatewaySessionManager刚启动时，这里初始化了种子，使用的随机函数为java.security.SecureRandom()</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public GWSession createSession() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GWSession session = new GWSession(this.generateSessionId());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    session.startup(this.context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.sessions.put(session.getId(), session);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.log.debug((Object)("Created new session: " + session.getPublicId()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.statusTags.refresh();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return session;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>创建session位于用户成功登录处，再看具体生成session的算法</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">protected synchronized String generateSessionId() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    byte[] random = new byte[16];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String result = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    StringBuffer buffer = new StringBuffer();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int resultLenBytes = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (result != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            buffer = new StringBuffer();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ++this.duplicates;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while (resultLenBytes &lt; this.sessionIdLength) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.random.nextBytes(random);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            random = this.digest.digest(random);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (int j = 0; j &lt; random.length &amp;&amp; resultLenBytes &lt; this.sessionIdLength; ++resultLenBytes, ++j) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                byte b1 = (byte)((random[j] &amp; 0xF0) &gt;&gt; 4);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                byte b2 = (byte)(random[j] &amp; 0xF);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (b1 &lt; 10) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    buffer.append((char)(48 + b1));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    buffer.append((char)(65 + (b1 - 10)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (b2 &lt; 10) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    buffer.append((char)(48 + b2));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    continue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                buffer.append((char)(65 + (b2 - 10)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } while (this.sessions.get(result = buffer.toString()) != null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里使用了this.random生成随机数，也就是上面播种了时间戳作为种子的随机函数，那么可能存在被预测的风险</p><p>查询java.security.SecureRandom在windows平台上底层调用的函数，在stack overflow上找到了类似的问题</p><ul><li><p>Q: <em>I am interested in</em>&nbsp;<code>java.util.Random</code>&nbsp;and&nbsp;<code>java.security.SecureRandom</code>&nbsp;classes. I found that&nbsp;<code>Random</code>&nbsp;uses system clock to generate seed and&nbsp;<code>SecureRandom</code>&nbsp;uses&nbsp;<code>/dev/random</code>&nbsp;or&nbsp;<code>/dev/urandom</code>&nbsp;but these files are on Linux, while on Windows it uses some mistic&nbsp;<code>CryptGenRandom</code>. Even if that is super secure function, do we know from where does it take values? What is the basement to generate seed?</p><blockquote><p>我对 java.util.Random 和 java.security.SecureRandom 类感兴趣。 我发现 Random 使用系统时钟生成种子，SecureRandom 使用 /dev/random 或 /dev/urandom，但这些文件位于 Linux 上，而在 Windows 上则使用一些神秘的 CryptGenRandom。 即使这是超级安全的函数，我们知道它从哪里获取值吗？ 生成种子的底层逻辑是什么？</p></blockquote></li><li><p>A: <em>In Windows&nbsp;SecureRandom&nbsp;uses the method&nbsp;CryptGenRandom&nbsp;that is part of WinCrypt Windows library (Included in Advapi32.dll of Windows System libraries).</em></p><blockquote><p>在 Windows SecureRandom 中，使用 CryptGenRandom 方法，该方法是 WinCrypt Windows 库的一部分（包含在 Windows 系统库的 Advapi32.dll 中）</p></blockquote></li></ul><p>下面是微软官方手册对<em>CryptGenRandom</em>的描述（节选）</p><ul><li><p><em>Software random number generators work in fundamentally the same way. They start with a random number, known as the seed, and then use an algorithm to generate a pseudo-random sequence of bits based on it. The most difficult part of this process is to get a seed that is truly random. This is usually based on user input latency, or the jitter from one or more hardware components.</em></p><blockquote><p>软件随机数生成器的工作方式基本相同。 他们从一个随机数（称为种子）开始，然后使用算法生成基于它的<!-- -->`<strong>伪随机位序列</strong>。 这个过程中最困难的部分是获得真正随机的种子。 这通常基于用户输入延迟或来自一个或多个硬件组件的抖动。</p></blockquote></li></ul><p>通过手册，我们可知Windows底层调用的是个伪随机函数，并且默认情况下使用的种子是一个很难预测的值，但是ignition中错误的使用了系统时间作为种子</p><p><strong>如何获得伪随机种子？</strong></p><p>在ignition gateway中，有一个特殊的servlet，<code>scriptModules</code> 用于获取第三方的脚本，最终将其打包返回一个zip</p><p>直接跟到对应逻辑处</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">void zipThirdPartyScriptModulesAndCalcHash() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      this.thirdPartyZipValid = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Object object = this.thirdPartyZipLock;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      synchronized (object) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          if (this.thirdPartyZipValid) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              File pylibDir = this.getThirdPartyScriptModulesDir();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              ZipMap zipMap = new ZipMap();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              this.addDirToZip(pylibDir, pylibDir, zipMap);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              File tempFile = new File(this.systemManager.getTempDir(), "pylib_compressed.zip");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              zipMap.writeToFile(tempFile);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              this.thirdPartyScriptModulesHash = Files.hash((File)tempFile, (HashFunction)Hashing.md5()).toString();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              this.log.error("Error calculating 3rd party script zip hash.", (Throwable)e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              this.thirdPartyScriptModulesHash = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              this.thirdPartyZipValid = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              this.thirdPartyZipLock.notifyAll();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>pylib_compressed.zip在每次ignition启动时都会重新生成，对于文件来说会有一个最后修改时间的属性，同时上面所说的随机数初始化时使用的时间戳也会与这个时间接近</p><p>查看启动日志可以看到先生成了seed后启动ignition gateway，那么只需要在zip的最后修改时间值减去delay即可，一般来说2s足矣</p><p><strong>那么在爆破seed时如何知道当前session是否正确？</strong></p><p>在gateway中处理数据包时存在如下逻辑</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">if (!versionHash.isDev() &amp;&amp; msg.getVersion() != 0L &amp;&amp; versionHash.getHash() != msg.getVersion()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (session != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            session.setMaxInactiveInterval(10);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.printErrorResponse((PrintWriter)out, 309, "Version mismatch", false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>此处逻辑位于session校验之后，也就是说故意设置错误的version，当session验证通过时，即可在返回包中看到309的响应</p><p>至此完成了整个session劫持的流程</p><p>重新梳理一下整个流程：</p><p>通过scriptModules获取到ignition启动的时间 → 将时间-delay作为初始种子 → 使用初始种子计算session → 验证当前session是否正确 → 种子+1（直至正确）</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="修复-1">修复<a href="#修复-1" class="hash-link" aria-label="修复的直接链接" title="修复的直接链接">​</a></h3><p>查看修复后的版本代码</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">protected synchronized String generateSessionId() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    do {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        result = AuthUtil.generateRandomBase64String(32);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } while(this.sessions.get(result) != null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>新版本直接删掉了initRandom函数，并修改了生成session的逻辑，跟进</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public static String generateRandomBase64String(int entropyCountInBytes) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      assert entropyCountInBytes &gt; 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      byte[] bytes = new byte[entropyCountInBytes];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      SecureRandomProvider.get().nextBytes(bytes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return BASE64_ENCODER.encodeToString(bytes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>继续跟进</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public void nextBytes(byte[] bytes) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      LOG.tracef("nextBytes(bytes.length=%s)...", new Object[]{bytes.length});</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      this.secureRandom.nextBytes(bytes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      LOG.trace("Done.");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>看到使用的函数仍然是伪随机函数，查看seed是否可以推测</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private SecureRandomProvider() throws NoSuchAlgorithmException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOG.debug("Creating SecureRandom object...");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.secureRandom = SecureRandom.getInstance("SHA1PRNG");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    byte[] seed = new byte[128];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    (new Random()).nextBytes(seed);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.secureRandom.setSeed(seed);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.secureRandom.nextBytes(new byte[128]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    (new Thread(new SeedGenerator(), "secure-random-seed-gen")).start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOG.debug("... SecureRandom Created.");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里seed生成虽然使用了伪随机函数random().nextbytes()，（random函数默认使用timestamp作为种子）但是由于每次生成session时都需要调用一遍这个流程，使用的seed为当前时间，所以每次生成session时的seed没法通过之前的方法进行推测，从而使得session的值不可计算，最终防止了session被劫持的风险</p><p>这里还有另一种修复方法，即使用java.security.SecureRandom默认种子即可，不进行setseed</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="0x04-漏洞模式总结">0x04 漏洞模式总结<a href="#0x04-漏洞模式总结" class="hash-link" aria-label="0x04 漏洞模式总结的直接链接" title="0x04 漏洞模式总结的直接链接">​</a></h2><p>使用不安全的随机函数 → 种子可知/可预测 → 随机数可计算 → 造成更严重的安全问题</p><p>上面的两个案例的修复方法均是对种子进行处理，防止种子可以被预测，从而修复原有的安全问题</p><p>同样，也可以通过将<strong>伪随机函数</strong>修改为<strong>安全随机函数</strong>的方法来解决上述安全问题（但安全随机函数可能并没有伪随机函数效率高）</p><table><thead><tr><th>语言</th><th>常见伪随机函数</th><th>安全随机函数</th></tr></thead><tbody><tr><td>C</td><td>srand</td><td>linux 使用/dev/urandom</td></tr><tr><td></td><td>rand</td><td>Windows使用CryptGenRandom并使用默认种子</td></tr><tr><td>C++</td><td>mt19937</td><td>C++使用std::random_device 类来获取安全的随机种子</td></tr><tr><td></td><td>default_random_engine</td><td></td></tr><tr><td>python</td><td>random</td><td>secrets</td></tr><tr><td>java</td><td>java.security.SecureRandom  //强伪随机函数</td><td>SecureRandom.getInstanceStrong</td></tr><tr><td></td><td>java.util.Random   //弱伪随机数</td><td></td></tr><tr><td>php</td><td>mt_scrand   mt_rand</td><td>random_bytes</td></tr><tr><td>C#</td><td>Random</td><td>System.Security.Cryptography.RNGCryptoServiceProvider</td></tr><tr><td>golang</td><td>math/rand</td><td>crypto/rand</td></tr></tbody></table><p>如果种子不可预测，那么伪随机数序列就难以预测，称为强伪随机数</p><p>如果种子可预测，那么随机数序列就通常可以预测，称为弱随机数</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="0x05-reference">0x05 Reference<a href="#0x05-reference" class="hash-link" aria-label="0x05 Reference的直接链接" title="0x05 Reference的直接链接">​</a></h2><p><a href="https://mp.weixin.qq.com/s/VShjaDI1McerX843YyOENw" target="_blank" rel="noopener noreferrer">https://mp.weixin.qq.com/s/VShjaDI1McerX843YyOENw</a></p><p><a href="https://github.com/vulhub/vulhub/blob/master/jumpserver/CVE-2023-42820/README.zh-cn.md" target="_blank" rel="noopener noreferrer">https://github.com/vulhub/vulhub/blob/master/jumpserver/CVE-2023-42820/README.zh-cn.md</a></p><p><a href="https://www.leavesongs.com/PENETRATION/jumpserver-sep-2023-multiple-vulnerabilities-go-through.html" target="_blank" rel="noopener noreferrer">https://www.leavesongs.com/PENETRATION/jumpserver-sep-2023-multiple-vulnerabilities-go-through.html</a></p><p><a href="https://github.com/sourceincite/randy" target="_blank" rel="noopener noreferrer">https://github.com/sourceincite/randy</a></p><p><a href="https://stackoverflow.com/questions/53496652/seed-to-java-security-securerandom-on-windows-os" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/53496652/seed-to-java-security-securerandom-on-windows-os</a></p><p><a href="https://learn.microsoft.com/en-us/windows/win32/api/wincrypt/nf-wincrypt-cryptgenrandom" target="_blank" rel="noopener noreferrer">https://learn.microsoft.com/en-us/windows/win32/api/wincrypt/nf-wincrypt-cryptgenrandom</a></p>]]></content>
        <author>
            <name>米米</name>
        </author>
        <category label="Microsoft" term="Microsoft"/>
        <category label="Windows" term="Windows"/>
        <category label="Race Condition" term="Race Condition"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Microsoft Hyper-V 虚拟 TPM 设备漏洞分析]]></title>
        <id>https://poc.qianxin.com/blog/microsoft-hyper-vtpm</id>
        <link href="https://poc.qianxin.com/blog/microsoft-hyper-vtpm"/>
        <updated>2023-10-25T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[一、漏洞描述]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="一漏洞描述">一、漏洞描述<a href="#一漏洞描述" class="hash-link" aria-label="一、漏洞描述的直接链接" title="一、漏洞描述的直接链接">​</a></h2><p>2023年10月微软发布的安全更新中，修复了2个由笔者报送的Hyper-V虚拟TPM设备漏洞。本次修复的Hyper-V虚拟TPM组件的漏洞可以通过远程访问虚拟机的方式触发漏洞，造成宿主机拒绝服务或者远程代码执行，对宿主机上的其他虚拟机或业务造成损失。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="二背景介绍">二、背景介绍<a href="#二背景介绍" class="hash-link" aria-label="二、背景介绍的直接链接" title="二、背景介绍的直接链接">​</a></h2><p>Hyper-V的虚拟TPM组件旨在为虚拟机提供模拟的TPM设备，虚拟TPM设备可以为依赖TPM设备的服务或者操作系统（例如Windows 11）提供支持。</p><p>漏洞位于<code>vmsp.exe</code>进程中的<code>TpmEngUM.dll</code>二进制文件中，本次介绍的两个虚拟TPM组件的漏洞就是位于<code>TpmEngUM.dll</code>这个二进制文件中。</p><p><code>vmsp.exe</code>进程与<code>vmwp.exe</code>进程相似，都是一个虚拟机实例启动一个进程。但是不同的是<code>vmsp.exe</code>进程是隔离用户模式(IUM)进程，也就是说<code>vmsp.exe</code>进程无法在windows用户态下被正常attach。所以在调试上，针对<code>vmsp.exe</code>进程的调试就需要额外的“手脚”，这里我们引用Quarkslab博客的文章（<a href="https://blog.quarkslab.com/debugging-windows-isolated-user-mode-ium-processes.html%EF%BC%89%EF%BC%8C%E6%84%9F%E5%85%B4%E8%B6%A3%E7%9A%84%E8%AF%BB%E8%80%85%E5%8F%AF%E4%BB%A5%E5%8E%BB%E4%BA%86%E8%A7%A3%E5%B9%B6%E5%AE%9E%E8%B7%B5%E4%B8%8B%EF%BC%8C%E8%BF%99%E9%87%8C%E4%B8%8D%E5%81%9A%E8%AE%A8%E8%AE%BA%E3%80%82" target="_blank" rel="noopener noreferrer">https://blog.quarkslab.com/debugging-windows-isolated-user-mode-ium-processes.html），感兴趣的读者可以去了解并实践下，这里不做讨论。</a></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="三环境搭建">三、环境搭建<a href="#三环境搭建" class="hash-link" aria-label="三、环境搭建的直接链接" title="三、环境搭建的直接链接">​</a></h2><p>虚拟TPM组件漏洞的触发需要在Hyper-V虚拟机设置中的“安全”设置中，勾选“启用受信任的平台模块”。</p><p> <img loading="lazy" src="/assets/images/0c7d620e-97ff-45cc-a12f-b4c66a317e2a-73d520780556ca0a4fe552ce77213993.png" width="1214" height="869" class="img_ev3q"></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="四漏洞分析cve-2023-36717">四、漏洞分析CVE-2023-36717<a href="#四漏洞分析cve-2023-36717" class="hash-link" aria-label="四、漏洞分析CVE-2023-36717的直接链接" title="四、漏洞分析CVE-2023-36717的直接链接">​</a></h2><p>该漏洞是一个拒绝服务漏洞，当这个漏洞被触发时会导致宿主机<code>vmsp.exe</code>进程进入死循环，并占用大量CPU计算资源。由于<code>vmsp.exe</code>进程是IUM进程，所以当漏洞被触发后，管理员无法从用户态结束掉这个进程，这种情况下除非重启宿主机操作系统否则计算资源一直无法被释放。</p><p>这个漏洞位于<code>TpmEngUM!TPM2_ECDH_KeyGen</code>函数中。</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">__int64 __fastcall </span><span class="token function maybe-class-name" style="color:#d73a49">TPM2_ECDH_KeyGen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">unsigned int </span><span class="token parameter operator" style="color:#393A34">*</span><span class="token parameter">a1</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> __int64 a2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token constant" style="color:#36acaa">OBJECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v3</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// rax</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token constant" style="color:#36acaa">OBJECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v4</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// rsi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  unsigned int v5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// eax</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  unsigned int v6</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// ebx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  unsigned __int16 v8</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">28</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+20h] [rbp-58h] BYREF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v3 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#d73a49">ObjectGet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">a1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v4 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> v3</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> v3</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_type </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x23</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v3</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_objectAttributes </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x10000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v3</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_objectAttributes </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x20000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> 0x19Ci64</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unsigned __int16</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#d73a49">cpri__GetEphemeralEcc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                               </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unsigned __int16 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a2 </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">104</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                               v8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                               v4</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_parameters_Detail_keyBits</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_WORD </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a2 </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x66</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#d73a49">TPMS_ECC_POINT_Marshal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_BYTE </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a2 </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">104</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> 0i64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> 0i64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    v5 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#d73a49">CryptEccPointMultiply</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_WORD </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a2 </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           v4</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_parameters_Detail_keyBits</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           v8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__int64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">v4</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_unique_ecc_x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    v6 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> v5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> v5 </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xA7</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> v5 </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x154</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      goto </span><span class="token constant" style="color:#36acaa">LABEL_9</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v6 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">156</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">LABEL_9</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">v6 </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_WORD </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">a2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#d73a49">TPMS_ECC_POINT_Marshal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_BYTE </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a2 </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> 0i64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> 0i64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> v6</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在<code>TpmEngUM!TPM2_ECDH_KeyGen</code>函数中，<code>v4-&gt;public_unique_ecc_x</code>成员可以从Guest中被控制，如果<code>v4-&gt;public_unique_ecc_x</code>成员是一个NULL ECC Point的情况下（<code>TPM2B_ECC_PARAMETER.size</code>为0x00,并且<code>TPM2B_ECC_PARAMETER.buffer</code>数组被0填充），<code>TpmEngUM!CryptEccPointMultiply</code>会一直返回错误码0x154，并不停的循环调用<code>TpmEngUM!CryptEccPointMultiply</code>函数，最终造成vmsp.exe进程死循环，导致宿主机拒绝服务。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="五漏洞分析cve-2023-36718">五、漏洞分析CVE-2023-36718<a href="#五漏洞分析cve-2023-36718" class="hash-link" aria-label="五、漏洞分析CVE-2023-36718的直接链接" title="五、漏洞分析CVE-2023-36718的直接链接">​</a></h2><p>该漏洞是远程代码执行漏洞，当这个漏洞被触发时会使用未初始化的栈空间变量。这个漏洞位于<code>TpmEngUM!CryptSecretEncrypt</code>函数中。</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">__int64 __fastcall </span><span class="token function maybe-class-name" style="color:#d73a49">CryptSecretEncrypt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">unsigned int a1</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> _BYTE </span><span class="token parameter operator" style="color:#393A34">*</span><span class="token parameter">a2_plabel</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> __int64 a3</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> __int16 </span><span class="token parameter operator" style="color:#393A34">*</span><span class="token parameter">a4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  unsigned int v7</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// ebx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token constant" style="color:#36acaa">OBJECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v8_obj</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// rax</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token constant" style="color:#36acaa">OBJECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v9_obj</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// rdi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  unsigned __int16 </span><span class="token maybe-class-name">DigestSize</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// ax</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  unsigned __int16 public_parameters_Detail_keyBits</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// cx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  __int16 public_nameAlg</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// cx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v14</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+40h] [rbp-C0h] BYREF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  __int16 v15</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">28</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+48h] [rbp-B8h] BYREF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  __int16 v16</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">56</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+80h] [rbp-80h] BYREF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  __int16 v17_Z_eccpointaftermul</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">56</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+F0h] [rbp-10h] BYREF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v7 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v8_obj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#d73a49">ObjectGet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v9_obj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> v8_obj</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token maybe-class-name">DigestSize</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">cpri__GetDigestSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v8_obj</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_nameAlg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_WORD </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">a3 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token maybe-class-name">DigestSize</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> v9_obj</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_type </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> v9_obj</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_type </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x23</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public_parameters_Detail_keyBits </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> v9_obj</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_parameters_Detail_keyBits</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    v14 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> a4 </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unsigned int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#d73a49">cpri__EccIsPointOnCurve</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         public_parameters_Detail_keyBits</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__int64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">v9_obj</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_unique_ecc_x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">cpri__GetEphemeralEcc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unsigned __int16 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">v16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unsigned __int16 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">v15</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v9_obj</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_parameters_Detail_keyBits</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">a4 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#d73a49">TPMS_ECC_POINT_Marshal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">v14</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> 0i64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unsigned int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function maybe-class-name" style="color:#d73a49">CryptEccPointMultiply</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           v17_Z_eccpointaftermul</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           v9_obj</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_parameters_Detail_keyBits</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unsigned __int16 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">v15</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__int64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">v9_obj</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_unique_ecc_x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        v7 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x9C</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#d73a49">BitIsSet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unsigned __int16</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">v9_obj</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_nameAlg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__int64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">g_toTest</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> 9u</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public_nameAlg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> v9_obj</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_nameAlg</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> public_nameAlg </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x10</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token function maybe-class-name" style="color:#d73a49">TestAlgorithm</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">public_nameAlg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> 0i64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">cpri__KDFe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        v9_obj</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_nameAlg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unsigned __int16 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">v17_Z_eccpointaftermul</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        a2_plabel</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unsigned __int16 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">v16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unsigned __int16 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">v9_obj</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">public_unique_ecc_x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unsigned __int16 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">a3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_BYTE </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a3 </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x9C</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> v7</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面代码中的<code>v17_Z_eccpointaftermul</code>是一个栈上的数组（也可能是个结构体），<code>v17_Z_eccpointaftermul</code>的大小是0x70字节。代码中的<code>v9_obj-&gt;public_unique_ecc_x</code>成员可以从Guest中被控制，当<code>v9_obj-&gt;public_unique_ecc_x</code>成员是一个NULL ECC Point的情况下<code>（TPM2B_ECC_PARAMETER.size</code>为0x00,并且<code>TPM2B_ECC_PARAMETER.buffer</code>数组被0填充），<code>TpmEngUM!CryptEccPointMultiply</code>函数会返回一个错误码并将v7设置为0x9C。</p><p>设置完v7的值之后，程序继续走到要调用<code>TpmEngUM!cpri__KDFe</code>函数这里，此时<code>v17_Z_eccpointaftermul</code>是一个栈上未初始化的数组，并作为<code>TpmEngUM!cpri__KDFe</code>函数的第二参数进入到之后的<code>TpmEngUM!cpri__KDFe</code>函数的代码流程里。</p><p>在<code>TpmEngUM!cpri__KDFe</code>函数后续的代码流程中，使用了未初始化的栈上的数据，导致越界读或者内存损坏。下面是崩溃时的现场：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">4afc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">2f4c</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">Access</span><span class="token plain"> violation </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> code </span><span class="token function" style="color:#d73a49">c0000005</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">first chance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">First</span><span class="token plain"> chance exceptions are reported before any exception handling</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property-access maybe-class-name">This</span><span class="token plain"> exception may be expected and handled</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property-access maybe-class-name">TpmEngUM</span><span class="token operator" style="color:#393A34">!</span><span class="token maybe-class-name">SymCryptSha512AppendBlocks_ull</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0xa7</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00007ffb</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">38d9a42f 4d8b41f0        mov     r8,qword ptr [r9-10h] ds:00000000</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">00153ffe</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">??</span><span class="token operator" style="color:#393A34">??</span><span class="token operator" style="color:#393A34">??</span><span class="token operator" style="color:#393A34">??</span><span class="token operator" style="color:#393A34">??</span><span class="token operator" style="color:#393A34">??</span><span class="token operator" style="color:#393A34">??</span><span class="token operator" style="color:#393A34">??</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">000</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> k</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> # </span><span class="token maybe-class-name">Child</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">SP</span><span class="token plain">          </span><span class="token maybe-class-name">RetAddr</span><span class="token plain">           </span><span class="token maybe-class-name">Call</span><span class="token plain"> </span><span class="token maybe-class-name">Site</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">00</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00000000</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">0014ec80 00007ffb</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">38d99e01 </span><span class="token maybe-class-name">TpmEngUM</span><span class="token operator" style="color:#393A34">!</span><span class="token maybe-class-name">SymCryptSha512AppendBlocks_ull</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0xa7</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">01</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00000000</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">0014eed0 00007ffb</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">38d99e59 </span><span class="token maybe-class-name">TpmEngUM</span><span class="token operator" style="color:#393A34">!</span><span class="token maybe-class-name">SymCryptSha512Append</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x95</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">02</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00000000</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">0014ef10 00007ffb</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">38d87724 </span><span class="token maybe-class-name">TpmEngUM</span><span class="token operator" style="color:#393A34">!</span><span class="token maybe-class-name">SymCryptSha384Append</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x9</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">03</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00000000</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">0014ef40 00007ffb</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">38d66cd7 </span><span class="token maybe-class-name">TpmEngUM</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">cpri__KDFe</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x1a4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">04</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00000000</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">0014f110 00007ffb</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">38d7c7cd </span><span class="token maybe-class-name">TpmEngUM</span><span class="token operator" style="color:#393A34">!</span><span class="token maybe-class-name">CryptSecretEncrypt</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x143</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">05</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00000000</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">0014f2c0 00007ffb</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">38d70a54 </span><span class="token maybe-class-name">TpmEngUM</span><span class="token operator" style="color:#393A34">!</span><span class="token maybe-class-name">TPM2_MakeCredential</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x7d</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">06</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00000000</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">0014f340 00007ffb</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">38d61c54 </span><span class="token maybe-class-name">TpmEngUM</span><span class="token operator" style="color:#393A34">!</span><span class="token maybe-class-name">CommandDispatcher</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0xa78</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">07</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00000000</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">0014f420 00007ffb</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">38d61313 </span><span class="token maybe-class-name">TpmEngUM</span><span class="token operator" style="color:#393A34">!</span><span class="token maybe-class-name">ExecuteCommand</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x460</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">08</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00000000</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token template-string string" style="color:#e3116c">0014f530 00000001</span><span class="token template-string template-punctuation string" style="color:#e3116c">`</span><span class="token plain">400c3862 </span><span class="token maybe-class-name">TpmEngUM</span><span class="token operator" style="color:#393A34">!</span><span class="token maybe-class-name">VTpmExecuteCommand</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x73</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="六总结">六、总结<a href="#六总结" class="hash-link" aria-label="六、总结的直接链接" title="六、总结的直接链接">​</a></h2><p>借助此文简单的介绍了下Hyper-V虚拟TPM组件的两个漏洞，可以发现这两个漏洞都是Hyper-V虚拟TPM组件在处理Guest数据时发生了错误导致宿主机进程受到了影响。通过本文帮助读者更好地理解虚拟TPM组件漏洞的成因，以及希望能够在TPM组件的漏洞挖掘工作中帮到大家。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="七作者及介绍">七、作者及介绍<a href="#七作者及介绍" class="hash-link" aria-label="七、作者及介绍的直接链接" title="七、作者及介绍的直接链接">​</a></h2><p>作者：HongZhenhao</p><p>介绍：天工实验室安全研究员，专注于 Windows、云、虚拟化领域漏洞挖掘。曾多次获得微软 MSRC 最高漏洞赏金，荣登 2019，2020，2022 微软 MSRC 全球最具价值安全精英榜，连续两年 BlackHat USA 世界黑帽大会 Speaker。</p>]]></content>
        <author>
            <name>HongZhenhao</name>
        </author>
        <category label="Microsoft" term="Microsoft"/>
        <category label="Hyper-V" term="Hyper-V"/>
        <category label="TPM" term="TPM"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[CVE-2023-0179 Linux内核提权]]></title>
        <id>https://poc.qianxin.com/blog/cve-2023-0179-linux</id>
        <link href="https://poc.qianxin.com/blog/cve-2023-0179-linux"/>
        <updated>2023-10-18T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[0x00 前言]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="0x00-前言">0x00 前言<a href="#0x00-前言" class="hash-link" aria-label="0x00 前言的直接链接" title="0x00 前言的直接链接">​</a></h2><p>2022年7月为天府杯准备的Linux提权漏洞，但是22年天府杯没办，23年1月被外国人报了。</p><p>思路来源于这篇文章，在看到这篇文章后决定去好好过一下netfilter相关模块。</p><p>文章链接：<a href="https://mp.weixin.qq.com/s?__biz=Mzk0OTU2ODQ4Mw==&amp;mid=2247483772&amp;idx=1&amp;sn=d1a48ae8f391d42e9d8981b67747ccc5&amp;chksm=c35717f0f4209ee67e547252ef5ad6a75654aa19708987f849c1748fc370755562879d39ae48&amp;token=665487310&amp;lang=zh_CN" target="_blank" rel="noopener noreferrer">How The Tables Have Turned: An analysis of two new Linux vulnerabilities in nf_tables</a></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="0x01-背景">0x01 背景<a href="#0x01-背景" class="hash-link" aria-label="0x01 背景的直接链接" title="0x01 背景的直接链接">​</a></h2><p>该漏洞位于Linux内核中netfilter模块对vlan进行处理的相关代码中，由于整型溢出导致的栈溢出，最后是ROP修改modprobe_path路径完成提权，在Ubuntu下测试可以稳定触发，提权成功率百分之百。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="0x02-漏洞成因加还是减">0x02 漏洞成因，加还是减<a href="#0x02-漏洞成因加还是减" class="hash-link" aria-label="0x02 漏洞成因，加还是减的直接链接" title="0x02 漏洞成因，加还是减的直接链接">​</a></h2><p>下面是漏洞代码，处理vlan相关的部分代码。</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/* add vlan header into the user buffer for if tag was removed by offloads */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> bool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">nft_payload_copy_vlan</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">u32 </span><span class="token parameter operator" style="color:#393A34">*</span><span class="token parameter">d</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#00009f">const</span><span class="token parameter"> struct sk_buff </span><span class="token parameter operator" style="color:#393A34">*</span><span class="token parameter">skb</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> u8 offset</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> u8 len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  int mac_off </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">skb_mac_header</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">skb</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> skb</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  u8 </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">vlanh</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">dst_u8 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u8 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> d</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  struct vlan_ethhdr veth</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  u8 vlan_hlen </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">skb</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">protocol </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">htons</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">ETH_P_8021AD</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       skb</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">protocol </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">htons</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">ETH_P_8021Q</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      offset </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">VLAN_ETH_HLEN</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> offset </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">VLAN_ETH_HLEN</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">VLAN_HLEN</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vlan_hlen </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">VLAN_HLEN</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  vlanh </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u8 </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">veth</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">offset </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">VLAN_ETH_HLEN</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> vlan_hlen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    u8 ethlen </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> len</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">vlan_hlen </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">skb_copy_bits</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">skb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mac_off</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">veth</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">VLAN_ETH_HLEN</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token function" style="color:#d73a49">nft_payload_rebuild_vlan_hdr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">skb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mac_off</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">veth</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">offset </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> len </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">VLAN_ETH_HLEN</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> vlan_hlen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ethlen </span><span class="token operator" style="color:#393A34">-=</span><span class="token plain"> offset </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> len </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">VLAN_ETH_HLEN</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> vlan_hlen</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">memcpy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dst_u8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> vlanh </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> offset </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> vlan_hlen</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ethlen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    len </span><span class="token operator" style="color:#393A34">-=</span><span class="token plain"> ethlen</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">len </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dst_u8 </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> ethlen</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    offset </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">ETH_HLEN</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> vlan_hlen</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    offset </span><span class="token operator" style="color:#393A34">-=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">VLAN_HLEN</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> vlan_hlen</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">skb_copy_bits</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">skb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> offset </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> mac_off</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dst_u8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这一段代码好像有点问题？<strong>整数溢出！！！</strong></p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">offset </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> len </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">VLAN_ETH_HLEN</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> vlan_hlen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ethlen </span><span class="token operator" style="color:#393A34">-=</span><span class="token plain"> offset </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> len </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">VLAN_ETH_HLEN</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> vlan_hlen</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在判断if (offset + len &gt; VLAN_ETH_HLEN + vlan_hlen)后，应该用offset + len减去VLAN_ETH_HLEN + vlan_hlen，很明显代码中少了括号运算，修复补丁也是简单的将+改为-。</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">offset </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> len </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter constant" style="color:#36acaa">VLAN_ETH_HLEN</span><span class="token parameter"> </span><span class="token parameter operator" style="color:#393A34">+</span><span class="token parameter"> vlan_hlen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">offset </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> len </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">VLAN_ETH_HLEN</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> vlan_hlen</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>栈溢出！！！</strong></p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">memcpy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dst_u8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> vlanh </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> offset </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> vlan_hlen</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ethlen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>dst_u8(rdi)指向上层调用函数的regs栈上变量，vlanh(rsi)指向veth栈上变量，ethlen(rcx &lt;&lt; 3)在整数溢出后会变为一个较大值。</p><p> <img loading="lazy" src="/assets/images/7848c444-c556-44ba-a298-91e2573502d7-0976ec7020384aea8cf1ff39ebb82f27.png" width="1720" height="1036" class="img_ev3q"></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="0x03-漏洞利用">0x03 漏洞利用<a href="#0x03-漏洞利用" class="hash-link" aria-label="0x03 漏洞利用的直接链接" title="0x03 漏洞利用的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="条件一需要cap_net_admin权限">条件一：需要CAP_NET_ADMIN权限<a href="#条件一需要cap_net_admin权限" class="hash-link" aria-label="条件一：需要CAP_NET_ADMIN权限的直接链接" title="条件一：需要CAP_NET_ADMIN权限的直接链接">​</a></h3><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">nfnetlink_rcv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">struct sk_buff </span><span class="token parameter operator" style="color:#393A34">*</span><span class="token parameter">skb</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        struct nlmsghdr </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">nlh </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">nlmsg_hdr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">skb</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">skb</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">len </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NLMSG_HDRLEN</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            nlh</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">nlmsg_len </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NLMSG_HDRLEN</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            skb</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">len </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> nlh</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">nlmsg_len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token function" style="color:#d73a49">netlink_net_capable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">skb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">CAP_NET_ADMIN</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token function" style="color:#d73a49">netlink_ack</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">skb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nlh</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">EPERM</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nlh</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">nlmsg_type </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NFNL_MSG_BATCH_BEGIN</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token function" style="color:#d73a49">nfnetlink_rcv_skb_batch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">skb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nlh</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token function" style="color:#d73a49">netlink_rcv_skb</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">skb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nfnetlink_rcv_msg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bool </span><span class="token function" style="color:#d73a49">netlink_net_capable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter keyword" style="color:#00009f">const</span><span class="token parameter"> struct sk_buff </span><span class="token parameter operator" style="color:#393A34">*</span><span class="token parameter">skb</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> int cap</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">netlink_ns_capable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">skb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sock_net</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">skb</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">sk</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">user_ns</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cap</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>命令空间</strong></p><p>Linux下默认的根命令空间是init_user_ns，如果CONFIG_USER_NS和CONFIG_NET_NS配置选项开启，用户便可以创建自己的命令空间，并且在该用户命令空间中获得所有权限。所以可以通过创建新的命令空间以满足上述CAP_NET_ADMIN权限检查。</p><p> <img loading="lazy" src="/assets/images/81f59f3f-098d-4671-8167-b943b5629a35-6a41d15113b0649127129dfeb8a10b90.png" width="1127" height="181" class="img_ev3q"></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="条件二溢出的长度不足">条件二：溢出的长度不足<a href="#条件二溢出的长度不足" class="hash-link" aria-label="条件二：溢出的长度不足的直接链接" title="条件二：溢出的长度不足的直接链接">​</a></h3><p>ethlen的类型是u8，那么最大值为0xff，很明显不足以覆盖返回地址，regs变量后跟着nft_jumpstack结构体数组，长度为16，大小为256字节。</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#define </span><span class="token constant" style="color:#36acaa">NFT_JUMP_STACK_SIZE</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">16</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">struct nft_jumpstack </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> struct nft_chain  </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">chain</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  struct nft_rule  </span><span class="token operator" style="color:#393A34">*</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">rules</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unsigned int</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">nft_do_chain</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">struct nft_pktinfo </span><span class="token parameter operator" style="color:#393A34">*</span><span class="token parameter">pkt</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#00009f">void</span><span class="token parameter"> </span><span class="token parameter operator" style="color:#393A34">*</span><span class="token parameter">priv</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> struct nft_chain </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">chain </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> priv</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">basechain </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> chain</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> struct net </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">net </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">nft_net</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pkt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  struct nft_rule </span><span class="token operator" style="color:#393A34">*</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">rules</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> struct nft_rule </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">rule</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> struct nft_expr </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">expr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">last</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  struct nft_regs regs</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  unsigned int stackptr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  struct nft_jumpstack jumpstack</span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">NFT_JUMP_STACK_SIZE</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  bool genbit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">READ_ONCE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">net</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">nft</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">gencursor</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  struct nft_traceinfo info</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ida反汇编结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">__int64 __fastcall </span><span class="token function" style="color:#d73a49">nft_do_chain</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token parameter">__int64 </span><span class="token parameter operator" style="color:#393A34">*</span><span class="token parameter">a1</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"></span><br></span><span class="token-line" style="color:#393A34"><span class="token parameter">        struct nft_regs </span><span class="token parameter operator" style="color:#393A34">*</span><span class="token parameter">a2</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"></span><br></span><span class="token-line" style="color:#393A34"><span class="token parameter">        __int64 a3</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"></span><br></span><span class="token-line" style="color:#393A34"><span class="token parameter">        __int64 a4</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"></span><br></span><span class="token-line" style="color:#393A34"><span class="token parameter">        __int64 a5</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"></span><br></span><span class="token-line" style="color:#393A34"><span class="token parameter">        __int64 a6</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"></span><br></span><span class="token-line" style="color:#393A34"><span class="token parameter">        char a7</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"></span><br></span><span class="token-line" style="color:#393A34"><span class="token parameter">        int a8</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"></span><br></span><span class="token-line" style="color:#393A34"><span class="token parameter">        __int16 a9</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  struct nft_regs regs</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+60h] [rbp-190h] BYREF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  struct nft_jumpstack v51</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+B0h] [rbp-140h] BYREF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  unsigned __int64 canary</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+1B8h] [rbp-38h]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  __int64 v53</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+1C0h] [rbp-30h]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  __int64 v54</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+1C8h] [rbp-28h]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  __int64 v55</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+1D0h] [rbp-20h]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  __int64 v56</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+1D8h] [rbp-18h]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  __int64 v57</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+1E0h] [rbp-10h]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  __int64 v58</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+1E8h] [rbp-8h]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>通过利用改写nft_jumpstack结构体，扩大越界读写范围。</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">unsigned int</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">nft_do_chain</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">struct nft_pktinfo </span><span class="token parameter operator" style="color:#393A34">*</span><span class="token parameter">pkt</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> </span><span class="token parameter keyword" style="color:#00009f">void</span><span class="token parameter"> </span><span class="token parameter operator" style="color:#393A34">*</span><span class="token parameter">priv</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> struct nft_chain </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">chain </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> priv</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">basechain </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> chain</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> struct net </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">net </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">nft_net</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pkt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  struct nft_rule </span><span class="token operator" style="color:#393A34">*</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">rules</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> struct nft_rule </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">rule</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> struct nft_expr </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">expr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">last</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  struct nft_regs regs</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  unsigned int stackptr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  struct nft_jumpstack jumpstack</span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">NFT_JUMP_STACK_SIZE</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  bool genbit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">READ_ONCE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">net</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">nft</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">gencursor</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  struct nft_traceinfo info</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  info</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">trace</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">static_branch_unlikely</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">nft_trace_enabled</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">nft_trace_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pkt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">regs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">verdict</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> basechain</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">do_chain</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">genbit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rules </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rcu_dereference</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">chain</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">rules_gen_1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rules </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rcu_dereference</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">chain</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">rules_gen_0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">next_rule</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rule </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">rules</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  regs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">verdict</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">code</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NFT_CONTINUE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">rules </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> rules</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rule </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">rules</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">nft_rule_for_each_expr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">expr</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> last</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> rule</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">expr</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">ops </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">nft_cmp_fast_ops</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">nft_cmp_fast_eval</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">expr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">regs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">expr</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">ops </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">nft_bitwise_fast_ops</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">nft_bitwise_fast_eval</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">expr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">regs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">expr</span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">ops </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">nft_payload_fast_ops </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token operator" style="color:#393A34">!</span><span class="token function" style="color:#d73a49">nft_payload_fast_eval</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">expr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">regs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pkt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">expr_call_ops_eval</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">expr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">regs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pkt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">regs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">verdict</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">code</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NFT_CONTINUE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">regs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">verdict</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">code</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NFT_BREAK</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      regs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">verdict</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">code</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NFT_CONTINUE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">continue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NFT_CONTINUE</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">nft_trace_packet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> chain</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rule</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token constant" style="color:#36acaa">NFT_TRACETYPE_RULE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">continue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">regs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">verdict</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">code</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NF_VERDICT_MASK</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NF_ACCEPT</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NF_DROP</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NF_QUEUE</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NF_STOLEN</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">nft_trace_packet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> chain</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rule</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token constant" style="color:#36acaa">NFT_TRACETYPE_RULE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> regs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">verdict</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">code</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">regs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">verdict</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">code</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NFT_JUMP</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">WARN_ON_ONCE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stackptr </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NFT_JUMP_STACK_SIZE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NF_DROP</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jumpstack</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">stackptr</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">chain</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> chain</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jumpstack</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">stackptr</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">rules</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rules </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stackptr</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fallthrough</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NFT_GOTO</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">nft_trace_packet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> chain</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rule</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token constant" style="color:#36acaa">NFT_TRACETYPE_RULE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chain </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> regs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">verdict</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">chain</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    goto do_chain</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NFT_CONTINUE</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NFT_RETURN</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">nft_trace_packet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> chain</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rule</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token constant" style="color:#36acaa">NFT_TRACETYPE_RETURN</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword module" style="color:#00009f">default</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token constant" style="color:#36acaa">WARN_ON</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stackptr </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stackptr</span><span class="token operator" style="color:#393A34">--</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chain </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> jumpstack</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">stackptr</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">chain</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rules </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> jumpstack</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">stackptr</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">rules</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    goto next_rule</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p> <img loading="lazy" src="/assets/images/065b65c4-aa16-41fc-92f1-ed336e8ba155-3c5cf086591cf206bd6a39e95d1efbf5.jpeg" width="2000" height="1333" class="img_ev3q"></p><p> <img loading="lazy" src="/assets/images/0c63e908-6b17-4832-a95a-e2e1fb9913e4-22b849ff21dc5315798ff33fcd1c4c6e.png" width="831" height="475" class="img_ev3q"></p><p>通过增加多个verdict.code为NFT_JUMP的规则，在规则执行后就会填充jumpstack数组，并在最后一个规则触发越界写，修改jumpstack数组，控制其中的rules指针，后续覆盖返回地址，做ROP即可。</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">struct unft_base_chain_param bp</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">hook_num</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NF_INET_PRE_ROUTING</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">prio</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">int i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> exp_chain_num</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">sprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exp_chain_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"%s%d"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"exp_chain"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">p </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             p </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">bp</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">create_chain</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nl</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> table_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exp_chain_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NFPROTO_BRIDGE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">seq</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">perror</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Failed creating exp chain"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">exit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">EXIT_FAILURE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">int i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> exp_chain_num</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">sprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exp_chain_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"%s%d"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"exp_chain"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">sprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exp_chain_name_next</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"%s%d"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"exp_chain"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        struct nftnl_rule</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> r </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">build_rule</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">table_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exp_chain_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NFPROTO_BRIDGE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">rule_add_payload</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">r</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NFT_PAYLOAD_LL_HEADER</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x40</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            char </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">cmp_str </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">MAGIC</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">rule_add_cmp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">r</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NFT_CMP_EQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cmp_str</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            uint64_t stack_value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stack </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xffff</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">rule_add_payload</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">r</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NFT_PAYLOAD_LL_HEADER</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x40</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">rule_add_cmp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">r</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NFT_CMP_EQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">stack_value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> exp_chain_num </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">rule_add_payload</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">r</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NFT_PAYLOAD_LL_HEADER</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x40</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// trigger</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">rule_add_immediate_verdict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">r</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NFT_JUMP</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exp_chain_name_next</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">send_batch_request</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nl</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token constant" style="color:#36acaa">NFT_MSG_NEWRULE</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">NFT_TYPE_RULE</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token constant" style="color:#36acaa">NLM_F_CREATE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NFPROTO_BRIDGE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">**</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">r</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">seq</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">puts</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">CLR_RED</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"[-] Set exp chain rule failed"</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">CLR_RESET</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">perror</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">""</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">exit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">EXIT_FAILURE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="条件三触发漏洞时内核上下文不确定">条件三：触发漏洞时内核上下文不确定<a href="#条件三触发漏洞时内核上下文不确定" class="hash-link" aria-label="条件三：触发漏洞时内核上下文不确定的直接链接" title="条件三：触发漏洞时内核上下文不确定的直接链接">​</a></h3><p>在recv接收数据时触发漏洞，所以不确定是在哪一个内核上下文中，栈溢出后也不能直接返回用户态。</p><p>不过多破坏栈上数据，在有限的栈空间内修改modprobe_path（在运行非ELF格式的二进制时，会以root权限调用该脚本）指向我们可控的脚本，最后调整rsp为上一层未破坏的栈帧，正常返回。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="0x04-总结">0x04 总结<a href="#0x04-总结" class="hash-link" aria-label="0x04 总结的直接链接" title="0x04 总结的直接链接">​</a></h2><p>netfilter子系统是一个相当复杂的系统，借助此文介绍了CVE-2023-0179的漏洞成因和漏洞利用过程中的一些注意点，希望能起到抛砖引玉的效果。</p>]]></content>
        <author>
            <name>李敏</name>
        </author>
        <category label="Linux" term="Linux"/>
        <category label="Privilege Escalation" term="Privilege Escalation"/>
    </entry>
</feed>