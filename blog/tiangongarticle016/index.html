<!doctype html>
<html lang="zh-Hans" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">常见 PHP 源码保护与还原 | 破壳漏洞挖掘平台</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://poc.qianxin.com/img/poc-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://poc.qianxin.com/img/poc-social-card.jpg"><meta data-rh="true" property="og:url" content="https://poc.qianxin.com/blog/tiangongarticle016"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="常见 PHP 源码保护与还原 | 破壳漏洞挖掘平台"><meta data-rh="true" name="description" content="一、前言"><meta data-rh="true" property="og:description" content="一、前言"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2024-01-24T00:00:00.000Z"><meta data-rh="true" property="article:tag" content="PHP"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://poc.qianxin.com/blog/tiangongarticle016"><link data-rh="true" rel="alternate" href="https://poc.qianxin.com/blog/tiangongarticle016" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://poc.qianxin.com/blog/tiangongarticle016" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://M80RFF4T9F-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="破壳漏洞挖掘平台 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="破壳漏洞挖掘平台 Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="破壳漏洞挖掘平台" href="/opensearch.xml">
<script src="https://www.clarity.ms/tag/k257lj4y58"></script>
<script src="https://hm.baidu.com/hm.js?bd805f6d9db85a795e91b7f0e7038239" async></script><link rel="stylesheet" href="/assets/css/styles.a2b3cc1f.css">
<script src="/assets/js/runtime~main.ff9e11b9.js" defer="defer"></script>
<script src="/assets/js/main.59859709.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://poc.qianxin.com" target="_blank" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/img/logo.svg" alt="破壳文档" class="nav-logo-class themedComponent_mlkZ themedComponent--light_NVdE" height="20" width="100"><img src="/img/logo.svg" alt="破壳文档" class="nav-logo-class themedComponent_mlkZ themedComponent--dark_xIcU" height="20" width="100"></div><b class="navbar__title text--truncate"></b></a><a class="navbar__item navbar__link tutorialClass" href="/">文档</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">博客</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/blog/tags">标签</a><a class="navbar__item navbar__link" href="/blog/archive">归档</a><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div><a href="https://poc.qianxin.com/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">破壳官网<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">所有文章</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle020">Ghidra脚本编写：从IR到反编译C</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle019">关于Linux内核条件竞争的探讨</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle018">WebAssembly安全研究总结</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle017">Terrapin 攻击分析</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/tiangongarticle016">常见 PHP 源码保护与还原</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle015">Server as Client 漏洞模型</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle014">破壳分析：Linksys设备多个0-day漏洞</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle013">ESXi SLP漏洞复现</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle012">从传统到 AI 探讨 Webshell 检测攻防对抗</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle011">人与代码的桥梁-聊聊SAST</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle010">BMC 漏洞实例分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle009">CodeDom 漏洞模式与 SharePoint RCE</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle008">Datacon 2023 漏洞分析赛道赛题二官方题解</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle007">IoT 设备中的认证绕过漏洞分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle006">Exchange Server(CVE-2023-36439)远程代码执行漏洞分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle005">WAF防护绕过技巧分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle004">伪随机数问题浅析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle003">Windows内核竞态条件漏洞研究</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle002">Microsoft Hyper-V 虚拟 TPM 设备漏洞分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle001">CVE-2023-0179 Linux内核提权</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="https://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="一、前言"><header><h1 class="title_f1Hy" itemprop="headline">常见 PHP 源码保护与还原</h1><div class="container_mt6G margin-vert--md"><time datetime="2024-01-24T00:00:00.000Z" itemprop="datePublished">2024年1月24日</time> · <!-- -->阅读需 29 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><img class="avatar__photo" src="https://github.com/sco4x0.png" alt="4uuu Nya" itemprop="image"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">4uuu Nya</span></div><small class="avatar__subtitle" itemprop="description">Nu1L Team，Web安全与代码审计</small></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="一前言">一、前言<a href="#一前言" class="hash-link" aria-label="一、前言的直接链接" title="一、前言的直接链接">​</a></h2>
<p>近期在工作中遇到了一些使用php开发的应用，而这些应用都使用了不同的源码保护方案对自身代码进行了加密处理，某些应用的加密强度甚至比较高，导致工作还没开始可能就得宣告结束。</p>
<p>为了解决遇到的这个问题，针对市面上一些常见的保护方案进行了研究，并且成功将这些较为常见的保护完成了代码还原，接下来将对这几种常见的保护与还原方法进行介绍。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="二无扩展加密">二、无扩展加密<a href="#二无扩展加密" class="hash-link" aria-label="二、无扩展加密的直接链接" title="二、无扩展加密的直接链接">​</a></h2>
<p>这种程度的加密，只是对代码本身做了压缩与编码，处理完之后本身就是一个正常可运行的文件，依托于php的变量与函数可以使用绝大部分字符（除了一些特字符），导致这种方式处理之后的文件内容几乎全是不可见字符，只有零星一些明显被编码后的字符串以及极个别  函数符号可见。</p>
<p>由于加密强度不高，所以我们可以通过强行阅读处理后的文件来还原出解码方式从而获取原始代码，下面使用两种市面上常用的加密来做例子演示如何进行逆向还原。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="21-phpjmnet">2.1 <a href="http://phpjm.net" target="_blank" rel="noopener noreferrer">phpjm.net</a><a href="#21-phpjmnet" class="hash-link" aria-label="21-phpjmnet的直接链接" title="21-phpjmnet的直接链接">​</a></h3>
<p>工具地址：<a href="http://www.phpjm.net/" target="_blank" rel="noopener noreferrer">http://www.phpjm.net/</a></p>
<p>使用这种方式处理后的文件，只能运行在 php &lt; 7的版本上，而且处理后的文件代码量较少，我们甚至可以直接通过手工的方式来对其进行还原，下面是一段代码被处理之后的情况：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/7c6bad0a-1e71-4b96-97c8-a3212700d099-24186034bb249fe7fb00c7d07c47d7ad.png" width="1506" height="834" class="img_ev3q"></p>
<p>可以看到基本上全是不可见字符+编码后的字符串，其中可以注意到有一个明文可见的符号 <code>base64_decode</code>，所以也能确定那一堆可见字符就是一堆base64编码（低版本php在遇到非码表内的字符会进行忽略从而完成正常解析，而高版本php&gt;=7会抛出异常，这也就是为什么这种处理后的代码只能跑在低版本php上），那么直接对代码进行一下格式化，然后尝试对其还原，格式化后的代码如下所示：</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;?php </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">������������Ϣ�����Ǳ�php�ļ������ߣ����Ա��ļ�����������Ϣֻ���ṩ�˶Ա�php�ļ����ܡ������Ҫ��PHP�ļ����м��ܣ��밴������Ϣ��ϵ��</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Warning: do not modify this file, otherwise may cause the program to run.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">QQ: 1833596</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Website: http://www.phpjm.net/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Copyright (c) 2012-2024 phpjm.net All Rights Reserved.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (!defined(&quot;EBCCDDCDEF&quot;)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	define(&quot;EBCCDDCDEF&quot;, __FILE__);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	global $�,$��,$���,$����,$����,$������,$�������,$��������,$���������,$����������,$�����������,$�����������,$�������������,$��������������,$���������������,$���������������;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	function ��($��,$���=&quot;&quot;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		global $�,$��,$���,$����,$����,$������,$�������,$��������,$���������,$����������,$�����������,$�����������,$�������������,$��������������,$���������������,$���������������;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		if(empty($���)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			return base64_decode($��);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		} else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			return ��($�����������($��,$���,$���($���)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	$���=��(&quot;c3RycmV2�&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	$�����������=��(&quot;c3RydHI=�&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	$����=��(&quot;LXLhbA==�&quot;,&quot;ZpomPWJL&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	$����=��(&quot;A3p1bmNvbXByAXNz�&quot;,&quot;ZTQA&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	$������=��(&quot;nmFzZTn0X2R�ln29kZQ==�&quot;,&quot;YhJpAn&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	$����������=��(&quot;SHJlZ19yZXBsYWNl�&quot;,&quot;chtS&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	$���������������=��(&quot;ZzdlNWM5Yjd�iMDRhNjLlNT�JhMDm0LGVkM�zlhMjM5YjYz�Z2U=�&quot;,&quot;LomFgvZ&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	function ����(&amp;$����) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		global $�,$��,$���,$����,$����,$������,$�������,$��������,$���������,$����������,$�����������,$�����������,$�������������,$��������������,$���������������,$���������������;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		$����������������=��(&quot;Okll�&quot;,&quot;ZGfMkO&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		@$����������($���������������,$����.&quot;(@$����($������(&#x27;eNptku1P2lAYxf8V�0vDhNuuUUosj5GZb�M0GJI4AghW0hLbQM�bGcFgsNpEFaohDfp�ECvC1j91vZeXGLaP�957fc87Nea57Aic2�IDRVqWixSEZSk9Ag�KCKT42MHGkEG3Hof�AwktUhGZiDJBoipr�CaT9enq+n08tDJyc�h5V0KgZNBJyHOOnb�CUIW5tB8fO4YmEny�Xy/FkP8sGYPwDnHS�RbWcRNidOWqbzU53�iDk5FaPnji5GPx4p�5YKMiGZjaLZvHwa9�n7MWhgqq/7KQ2oMt�ZHR4XOWUAuL6t/ez�32Zz2m63zWUqx5wW�OSZeXzhgrva9UApp�CQ6hxmDe0i1dN6xe�d/CE2eBhVMnQ/mp6�XouXhPcQjtFQuMZH�g2jioTtrdRZGo9U3�5ta4a+KZcIqV07xQ�T/NncOTgwoeL0yu1�FEYDExtms8Gj44Ns�NlCUwVYkIHbBzqu3�5GewS1AOSzlt2yT5�w90zFn9siE6f6C+B�G0mpSJvLiR24cfdm�1lSfOqeXtYAlQrmI�sojCx43Hnu4wqzWB�9ZQTtUJJvOCNsF0f�WFlQrxmahHBb3CwN�bCv/d/E4Pl5yh/Dv�e/dzPokVPX5vjmXl�vEDnmbyPFd74WNqz�JxAUQ5I403V97fqn�dBugrzfq2/Dd0nn9�foBvyZffyYbVoiqB�dRl4XwoTp0U1UhN5�rt5X+MgV2nEmnghp�itPaX0ZAL+E=�&#x27;)));&quot;,&quot;���</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">������7e5c9b7b04a66e52a084ded39a239b63������&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		return &quot;�&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	global $�,$��,$���,$����,$����,$������,$�������,$��������,$���������,$����������,$�����������,$�����������,$�������������,$��������������,$���������������,$���������������;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	$���=��(&quot;c3RycmV2�&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	$�����������=��(&quot;c3RydHI=�&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	$����=��(&quot;LXLhbA==�&quot;,&quot;ZpomPWJL&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	$����=��(&quot;A3p1bmNvbXByAXNz�&quot;,&quot;ZTQA&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	$������=��(&quot;nmFzZTn0X2R�ln29kZQ==�&quot;,&quot;YhJpAn&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	$����������=��(&quot;SHJlZ19yZXBsYWNl�&quot;,&quot;chtS&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	$���������������=��(&quot;ZzdlNWM5Yjd�iMDRhNjLlNT�JhMDm0LGVkM�zlhMjM5YjYz�Z2U=�&quot;,&quot;LomFgvZ&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$���������=��(&quot;JU5vAjBNNE5CJ0F�DY4JxRWOZ�&quot;,&quot;ZxqeLAgnJ&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$��������=����($���������);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@$����������($���������������,$����.&quot;(@$����($������(&#x27;eNo1jkEKwjAURK8�i8hcK8QSKnsVFwY�0iVBeu2sSkMaZp7�beNaZrqVY0LNwMz�bxhmuVmvNsfdcZJ�e0lOyn03Ph+&quot;.$���������.$��������.&quot;y20/nyj86HNDnNo�CXASwLPOoqW44dA�k700j8Y7y20k/fA�I1hEYscLXUEgCN6�wF0kJVBEp7E8aMt�IgFZLXO6dB6GwjQ�rEKRd0ZfPYu1/OH�fSK0QAuOANIFxx7�l0WpmeQNe07tOpv�g3hTmkTA+VZMcqM�lTK4RuHv9hfB0F7�u�&#x27;)));&quot;,&quot;��</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">������7e5c9b7b04a66e52a084ded39a239b63�����&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">?&gt;cc7f01b3f642b179356e745ca3eef0b7</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>代码量不多，逻辑也比较清晰，如果觉得这类不可见字符影响阅读，甚至可以直接使用winhex等工具直接批量替换一下，首先可以看到这里面只有两个函数，将其重新命名为func0和func1，先来看看其中有符号 <code>base64_decode</code> 的func0，忽略掉那一堆扰乱视线的全局变量，将编码后的明文字符串带入，可以还原出func0函数的处理流程。</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">function func0($var1, $var2=&quot;&quot;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	// global $varxxx...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	if (empty($var2)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		return base64_decode($var1);	</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	} else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		//func0($varx($var1, $var2, $vary($var2)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		func0(strtr($var, $var2, strrev($var2)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>注释中的 <code>varx</code> 和 <code>vary</code> 其实就是 <code>func0(&#x27;c3RycmV2�&#x27;) = strrev</code> 以及 <code>func0(&#x27;c3RydHI=�&#x27;) = strtr</code>，到此最核心的解码函数其实就已经恢复完了，下面这一堆看起来很复杂的调用，其实就是解码需要用的函数符号，解码后的结果如下：</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$���=��(&quot;c3RycmV2�&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$�����������=��(&quot;c3RydHI=�&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$����=��(&quot;LXLhbA==�&quot;,&quot;ZpomPWJL&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$����=��(&quot;A3p1bmNvbXByAXNz�&quot;,&quot;ZTQA&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$������=��(&quot;nmFzZTn0X2R�ln29kZQ==�&quot;,&quot;YhJpAn&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$����������=��(&quot;SHJlZ19yZXBsYWNl�&quot;,&quot;chtS&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$���������������=��(&quot;ZzdlNWM5Yjd�iMDRhNjLlNT�JhMDm0LGVkM�zlhMjM5YjYz�Z2U=�&quot;,&quot;LomFgvZ&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">string(6) &quot;strrev&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">string(5) &quot;strtr&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">string(4) &quot;eval&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">string(12) &quot;gzuncompress&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">string(13) &quot;base64_decode&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">string(12) &quot;preg_replace&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">string(35) &quot;/7e5c9b7b04a66e52a084ded39a239b63/e&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以此类推，将所有不可见字符全都给替换回来之后，整个文件的代码就会变成如下所示，阅读起来非常简单。</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">function func0($var1,$var2=&quot;&quot;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	if(empty($var2)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		return base64_decode($var1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	} else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		return func0(strtr($var1, $var2, strrev($var2)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">function func1(&amp;$var1) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	eval(gzuncompress(base64_decode(&#x27;xxxx&#x27;)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	return pack(&#x27;H*&#x27;, &#x27;80&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$tmp_var = func0(pack(&#x27;H*&#x27;, &#x27;4A553576416A424E4E4535434A30469F4459344A7852574F5A83&#x27;), pack(&#x27;H*&#x27;, &#x27;5A7871654C41676E4A&#x27;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$tmp_var2 = func1($tmp_var);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@preg_replace(&#x27;/7e5c9b7b04a66e52a084ded39a239b63/e&#x27;, &quot;eval(@gzuncompress(base64_decode(str . $tmp_var . $tmp_var2 . str)));&quot;, &#x27;������7e5c9b7b04a66e52a084ded39a239b63�����&#x27;);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在func1中还有一段 <code>eval(gzuncompress(base64_decode(&#x27;xxx&#x27;)))</code> 的调用，将其进行恢复一下之后，发现是一段比较长的代码，除了一句对 <code>$var1</code> 进行赋值的代码，对还原文件没有什么太大的帮助，主要是对当前文件做一些md5的完整性校验等，赋值代码原型如下：</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$var1 = gzuncompress(base64_decode($var1));</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>对其进行原样调用后就得到了 <code>$tmp_var</code> 以及 <code>$tmp_var2</code> 的值，将其进行拼接，然后做 <code>gzuncompress(base64_decode)</code> ，就可以还原出php本来的代码了。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/c9ebc537-ae90-4969-9f2d-1a5e860593d5-bae63d93fe4bf4f21be4d8f64e479466.png" width="1514" height="531" class="img_ev3q"></p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="22-phpjiamicom">2.2 <a href="http://phpjiami.com" target="_blank" rel="noopener noreferrer">phpjiami.com</a><a href="#22-phpjiamicom" class="hash-link" aria-label="22-phpjiamicom的直接链接" title="22-phpjiamicom的直接链接">​</a></h3>
<p>工具使用地址：<a href="https://www.phpjiami.com/phpjiami.html" target="_blank" rel="noopener noreferrer">https://www.phpjiami.com/phpjiami.html</a></p>
<p>经过这种方式处理后的代码，和 <code>phpjm</code> 没有什么本质上的区别，无非就是逻辑变得更复杂了一些，处理前后的代码对比如下所示：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/af33807f-214f-49de-b7d6-429afbe535f0-ad6db8097cad891082331a3fa72e5731.png" width="1517" height="974" class="img_ev3q"></p>
<p>这个代码量相比较 <code>phpjm</code> 就大了不少，手工来做还原就比较费劲，可以使用 <code>nikic/php-parser</code> 对文件做解析，  把其中所有变量从不可见字符给换成可见字符串，再手动对代码做一些修复和替换使其可读性更高，方便还原解密逻辑，对函数和符号重命名的 <code>Visitor</code> 如下所示：</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">class VariableVisitor extends NodeVisitorAbstract</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public function leaveNode(Node $node) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        global $varCount, $funcCount, $maps;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($node instanceof Expr\Variable) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $varName = is_string($node-&gt;name) ? $node-&gt;name : $node-&gt;name-&gt;name;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $varName = md5($varName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if ($varName &amp;&amp; !array_key_exists($varName, $maps)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $maps[$varName] = &#x27;var&#x27; . $varCount++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $node-&gt;name = $maps[$varName];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ($node instanceof Node\Stmt\Function_) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $funcName = $node-&gt;name-&gt;name;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $funcName = md5($funcName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if ($funcName &amp;&amp; !array_key_exists($funcName, $maps)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                $maps[$funcName] = &#x27;func&#x27; . $funcCount++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            $node-&gt;name = $maps[$funcName];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="/assets/images/4a7b160f-05c3-4bdb-a65c-b42ceb22a9ef-87b72efbce6483c9114caa363a92a378.png" width="1674" height="1089" class="img_ev3q"></p>
<p>在大致恢复符号后可以发现一共有三个函数，被重新命名成了func0，func1，func2，由于只有func2中有一个可见字符的函数：<code>base64_decode</code> 并且之后有一堆明显的调用，那么从恢复这个函数开始，手动将其解码再重新赋值，恢复完成之后会发现其实这是一个核心的解密函数，func2恢复对比如下：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/a6614d87-2f09-4498-b91a-63e0dde08529-b32066f3b574c30da8cfe646cb77465b.png" width="1678" height="529" class="img_ev3q"></p>
<p>如法炮制恢复出func1，可以发现就是一个比较简单的解码操作。</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">function func1(&amp;$var1, $var2) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $enc = func2(pack(&#x27;H*&#x27;, &#x27;A6CAE0B236F23833DEA29A2B9C30E2DCD89CEA42AE32EE2BE635C4989AD2D8C2E8EE34C4CA47C29A33A0AAC8C8DAE0B037D8364333E2C8A2C4EC3932F244E04730F4A6CEA2D2E2B238C439F4EE9EB234DCCE9C30493338E8AA474396A6969847D898CC309CE44A379AC6C4A64235D6AEAEDC3749DCF4A246C630383944DEACF2A04AB22B2F2BA2A4F0333098C6B0364632E8E0A6E62FEAC637ECD849AC4546CC30A647C2F0A039C239C6A8DEC4DC35D0CCC4E24748A241AEE02B9C46E8DADADAF444A6CC&#x27;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $res = str_rot13(strrev(gzuncompress(stripslashes($enc))));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $s = explode(&#x27;,&#x27;, $res);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $var1 = $s[$var2];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>对其进行解码后dump出来发现其实就是函数符号表，供var1这一堆很长的全局变量使用。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/18b625bd-d24b-43e4-a15f-c8f41c1e3469-70eb5c03f2caec19c09b9a2b29713826.png" width="326" height="206" class="img_ev3q"></p>
<p>最后解到func0，会发现这就是最终解出原始代码的函数，其中有一堆校验防止用户破解。</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">function func0($var1) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    php_sapi_name() == &#x27;cli&#x27; ? die() : &#x27;&#x27;;   // 防止在cli下运行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $content = file_get_contents(__FILE__);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 同样防止在cli下运行，这里可能是怕直接hook了php_sapi_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if(!isset($_SERVER[&#x27;HTTP_HOST&#x27;]) &amp;&amp; !isset($_SERVER[&#x27;SEREVER_ADDR&#x27;]) &amp;&amp; !isset($_SERVER[&#x27;REMOTE_ADDR&#x27;])) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        die();   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $time = microtime(true) * 1000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 防止eval hook，断点时间超1秒就退出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    eval(&quot;&quot;); </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (microtime(true) * 1000 - $time &gt; 100) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        die();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    eval(&quot;if(strpos(__FILE__, &#x27;nirpnqsz&#x27;) !== 0){$exitfunc();}&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    !strpos(func2(substr($content, func2(getHexStr(&#x27;4841A4A2&#x27;)), func2(pack(&#x27;H*&#x27;, &#x27;4841453D&#x27;))), md5(substr($content, func2(), func2())))) ? undefined() : undefined();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $start = func2(pack(&#x27;H*&#x27;, &#x27;484146A6ACA23D3D&#x27;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $end = func2(pack(&#x27;H*&#x27;, &#x27;4841A4A8&#x27;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 还原的核心代码，其实就是取了?&gt;后那一堆乱码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $content = str_rot13(@gzuncompress(func2(substr($content, $start, $end))));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return $content;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">｝</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>将还原的核心代码取出来 <code>str_rot13(@gzuncompress(func2(substr($content, $start, $end))));</code> 对着加密后的文件做一下调用，就可以还原出加密前的代码了。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/2a567629-5bfc-4b16-a483-ec1aec0b4122-7a0c317e80eec915d71b1cf44df06e8d.png" width="1404" height="842" class="img_ev3q"></p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="三-扩展加密源码混淆">三、 扩展加密（源码混淆）<a href="#三-扩展加密源码混淆" class="hash-link" aria-label="三、 扩展加密（源码混淆）的直接链接" title="三、 扩展加密（源码混淆）的直接链接"> ​</a></h2>
<p>当加密到了这一步，方式开始有所变化，比如需要用户手动编译启用一个php扩展，使用扩展提供的工具对文件进行一次对应的加密，这样在web目录中的文件几乎全是乱码，任何可见符号都看不到，但究其本质上来讲，这种加密其实和上述的两种加密没有任何区别，只不过增加了一点扩展逆向难度而已，下面同样使用两种市面上常见的扩展作为例子。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="31-php-beast">3.1 php-beast<a href="#31-php-beast" class="hash-link" aria-label="3.1 php-beast的直接链接" title="3.1 php-beast的直接链接">​</a></h3>
<p>项目地址：<a href="https://github.com/liexusong/php-beast" target="_blank" rel="noopener noreferrer">https://github.com/liexusong/php-beast</a></p>
<p>使用这个扩展对文件进行处理后，整个文件将变成完全不可读的状态，在非默认情况下脱离了扩展本身其实很难还原，加密前后对比如下：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/444494ff-1a9a-464b-94c6-10623f9570d5-e020d7aab50dd38672e2f53f4e53df3a.png" width="617" height="283" class="img_ev3q"></p>
<p>直接看他如何hook的 <code>compile_file</code></p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">zend_op_array </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">__fastcall </span><span class="token function" style="color:#d73a49">cgi_compile_file</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">zend_file_handle </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">h</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> type</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">filename</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// rdi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  FILE </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v4</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// rax</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  FILE </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// rbp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> v6</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// eax</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> v7</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// eax</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  zend_stream_type v8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// eax</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  file_handler </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v9</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// rax</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> v10</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// edx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> v11</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// r13d</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">beast_free_buf_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">free</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// rax</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  beast_ops </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ops</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+8h] [rbp-40h] BYREF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+10h] [rbp-38h] BYREF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> free_buffer</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+18h] [rbp-30h] BYREF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+1Ch] [rbp-2Ch] BYREF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  filename </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> h</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">filename</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  free_buffer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ops </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0LL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v4 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fopen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">filename</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;rb&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v5 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> v4</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">v4 </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">goto</span><span class="token plain"> final</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v6 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fileno</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v7 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">decrypt_file</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">h</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">filename</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v6</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">free_buffer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">ops</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">old_compile_file</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">h</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> type</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在打开文件后调用了自己实现的 <code>decrypt_file</code> ，之后做了一系列操作重新将解密后的内容扔给了 <code>old_compile_file</code> 继续正常的编译执行操作，那么主要关注到这个 <code>decrypt_file</code>，看看是如何做的解密。</p>
<p>首先经由beast混淆过的文件会有一个文件头特征，默认情况下将会是：<code>0xe8, 0x16, 0xa4, 0x0c, 0xf2, 0xb2, 0x60, 0xee</code> ，代码中会检查这个文件头来判断是否是加密文件。用户可以在编译之前修改 <code>header.c</code> 来替换掉这个值，所以这个特征并不是固定的。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">000000000000E668</span><span class="token plain">                 public encrypt_file_header_sign</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">000000000000E668</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> encrypt_file_header_sign</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">000000000000E668</span><span class="token plain"> encrypt_file_header_sign db </span><span class="token number" style="color:#36acaa">0E8</span><span class="token plain">h</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">h</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">A4h</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">Ch</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0F</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">h</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">B2h</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">60</span><span class="token plain">h</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">EEh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">000000000000E668</span><span class="token plain">                                         </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> DATA XREF</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> LOAD</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">0000000000000</span><span class="token plain">EF0↑o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">000000000000E668</span><span class="token plain">                                         </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">got</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">encrypt_file_header_sign_ptr↑o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">000000000000E660</span><span class="token plain">                 public encrypt_file_header_length</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">000000000000E660</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> encrypt_file_header_length</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">000000000000E660</span><span class="token plain"> encrypt_file_header_length dd </span><span class="token number" style="color:#36acaa">8</span><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> DATA XREF</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> LOAD</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">00000000000010</span><span class="token plain">A0↑o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">000000000000E660</span><span class="token plain">                                         </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">got</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">encrypt_file_header_length_ptr↑o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">memcmp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">header</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> encrypt_file_header_sign</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> encrypt_file_header_length</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> log_normal_file </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">beast_write_log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">beast_log_error</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;File `%s&#x27; isn&#x27;t a encrypted file&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> filename</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在判断文件头符合之后，会继续从文件头中取出三个信息，文件大小、有效日期与加密方式，其中最重要的就是加密方式这个值（三个值都需要转为大端序）。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  v16 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_DWORD </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">header</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">encrypt_file_header_length</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v17 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_DWORD </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">header</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">encrypt_file_header_length </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v18 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_DWORD </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">header</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">encrypt_file_header_length </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v42 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4386</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v19 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v16 </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">24</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v16 </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xFF0000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v16 </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xFF00</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">HIBYTE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v16</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v20 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v17 </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">24</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v17 </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xFF0000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v17 </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xFF00</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">HIBYTE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v17</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v21 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v18 </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">24</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v18 </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xFF0000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v18 </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xFF00</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">HIBYTE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v18</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> beast_max_filesize </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> v19 </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> beast_max_filesize </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">beast_write_log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      beast_log_error</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">&quot;File size `%d&#x27; out of max size `%d&#x27;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">v19</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">beast_max_filesize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> v20 </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> v20 </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> beast_now_time </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">beast_write_log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">beast_log_error</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;File `%s&#x27; was expired&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> filename</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v31 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> chk</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  encrypt_algo </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">beast_get_encrypt_algo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v21</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>将代码所示具体到文件中，就可以看到文件头中关于这四个信息的情况，分别为文件头标志、文件大小、有效日期以及加密方式。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/a9936487-54b2-4a25-834c-7d7877065756-2ca5e2606d1169b86039b5e22521d259.png" width="895" height="310" class="img_ev3q"></p>
<p>现在知道了加密方式为 <code>1</code>，那么继续跟入看看这个数 字代指什么方式的混淆。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">beast_ops </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">__fastcall </span><span class="token function" style="color:#d73a49">beast_get_encrypt_algo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> type</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">beast_get_encrypt_algo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">type</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">beast_ops </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">__fastcall </span><span class="token function" style="color:#d73a49">beast_get_encrypt_algo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> type</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> v1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// edi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> type </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> v1 </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ops_handler_list</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ops_handler_list</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">000000000020</span><span class="token plain">C620                 public ops_handler_list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">000000000020</span><span class="token plain">C620 </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> beast_ops </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ops_handler_list</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">000000000020</span><span class="token plain">C620 ops_handler_list dq offset des_handler_ops</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> offset aes_handler_ops</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> offset base64_handler_ops</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">000000000020</span><span class="token plain">C620                                         </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> DATA XREF</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> LOAD</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">0000000000001</span><span class="token plain">AE8↑o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">000000000020</span><span class="token plain">C620                                         </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">got</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">ops_handler_list_ptr↑o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">000000000020</span><span class="token plain">C638                 dq offset dword_0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这里就能看到beast提供的三种代码混淆方式：DES、AES、BASE64，默认DES。这里我们的值为1，可得当前文件使用的混淆方式是DES，那么接下来的事情就比较简单了，在对应的 <code>decrypt_handler</code> 中找到对应的key，然后使用python简单写个解密脚本即可（这里的key同样是可以被修改掉的）。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">000000000000E5</span><span class="token plain">A8 </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> key_0</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">000000000000E5</span><span class="token plain">A8 key_0           db </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1F</span><span class="token plain">h</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1F</span><span class="token plain">h</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">Eh</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">Eh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">000000000000E5</span><span class="token plain">A8                                         </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> DATA XREF</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> des_encrypt_handler</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">89</span><span class="token plain">↑o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">000000000000E5</span><span class="token plain">A8                                         </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> des_decrypt_handler</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">50</span><span class="token plain">↑o</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>针对加密后文件进行解密的操作如下所示（AES与BASE64同理）。</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> Crypto</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Cipher </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> DES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> Crypto</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Util</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Padding </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> pad</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ECB_KEY </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&#x27;\x01\x1F\x01\x1F\x01\x0E\x01\x0E&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HEAD_LENGTH </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ENCRYPT_TYPES </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;DES&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;AES&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;BASE64&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">des_decrypt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ciphertext</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cipher </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> DES</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ECB_KEY</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> DES</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">MODE_ECB</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    plaintext </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cipher</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">decrypt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ciphertext</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> plaintext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">decode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;utf-8&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> errors</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;ignore&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> </span><span class="token builtin">open</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;./index.php&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;rb&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    content </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    head_sign </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> content</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">HEAD_LENGTH</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    file_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_bytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">content</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">HEAD_LENGTH</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> HEAD_LENGTH </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;big&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    encrypt_type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_bytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">content</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">HEAD_LENGTH </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> HEAD_LENGTH </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;big&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;[+] file size: %dB&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> file_size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;[+] encrypt type: %s&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> ENCRYPT_TYPES</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">encrypt_type </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enc_filedata </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> content</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">HEAD_LENGTH </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    padded_content </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pad</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">enc_filedata</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> DES</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">block_size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    plaintext </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> des_decrypt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">padded_content</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">plaintext</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="/assets/images/6b42f5b3-e819-46a0-9aaa-29187c90180f-035d1d53e7616c498bb9618f6411f40f.png" width="853" height="220" class="img_ev3q"></p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="32-php-screw">3.2 PHP Screw<a href="#32-php-screw" class="hash-link" aria-label="3.2 PHP Screw的直接链接" title="3.2 PHP Screw的直接链接">​</a></h3>
<p>项目地址：<a href="https://github.com/Luavis/php-screw" target="_blank" rel="noopener noreferrer">https://github.com/Luavis/php-screw</a></p>
<p>和php-beast一样，screw同样是通过hook了 <code>compile_file</code> 来做的混淆操作，原理上来讲大同小异，混淆算法的区别而已，加密前后对比如下所示：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/36ec368d-6716-482f-bea6-29c0005f89aa-e1082b72220c769e9f3da0c930f854e1.png" width="763" height="243" class="img_ev3q"></p>
<p>在screw中，有一个初始 化函数 <code>zm_startup_php_screw</code> 用来替换函数指针。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> __fastcall </span><span class="token function" style="color:#d73a49">zm_startup_php_screw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> type</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> module_number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  org_compile_file </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">zend_op_array </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">zend_file_handle </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">zend_compile_file</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  zend_compile_file </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pm9screw_compile_file</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>所以我们主要看到hook的函数 <code>pm9screw_compile_file</code> ，这个函数本身比较短。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">zend_op_array </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">__fastcall </span><span class="token function" style="color:#d73a49">pm9screw_compile_file</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">zend_file_handle </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">file_handle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> type</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  FILE </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v3</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// rax</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  FILE </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v4</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// rbp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  zend_stream_type v5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// eax</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  FILE </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v6</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// rax</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">filename</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// rdi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">active_function_name</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// rax</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> buf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+5h] [rbp-53h] BYREF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> fname</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">32</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+10h] [rbp-48h] BYREF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">memset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fname</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fname</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> __int8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#d73a49">zend_is_executing</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_active_function_name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      active_function_name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#d73a49">get_active_function_name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">strncpy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fname</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> active_function_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x1EuLL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> fname</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token function" style="color:#d73a49">strcasecmp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fname</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;show_source&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token function" style="color:#d73a49">strcasecmp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fname</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;highlight_file&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0LL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v3 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fopen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">file_handle</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">filename</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;r&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v4 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> v3</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">v3 </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">org_compile_file</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">file_handle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> type</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">fread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xAuLL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1uLL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token function" style="color:#d73a49">memcmp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;\tPM9SCREW\t&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xAuLL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    v5 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> file_handle</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">type</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> file_handle</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">type </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> ZEND_HANDLE_FP </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">fclose</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">file_handle</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">handle</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      v5 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> file_handle</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">type</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> v5 </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> ZEND_HANDLE_FD </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">file_handle</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">handle</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fd</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    v6 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">pm9screw_ext_fopen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    filename </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> file_handle</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">filename</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    file_handle</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">handle</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> v6</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    file_handle</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ZEND_HANDLE_FP</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    file_handle</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">opened_path </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#d73a49">expand_filepath</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">filename</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0LL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">org_compile_file</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">file_handle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> type</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">fclose</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">org_compile_file</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">file_handle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> type</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在这里我们发现，使用screw做保护方案的代码，默认情况下同样会有一个明显的文件特征 <code>\tPM9SCREW\t</code> （这个特征值可以在php_screw.h文件中被修改掉）。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/fc8cf2d1-c136-4580-ad93-e3948f81182b-9341c246ed1d59d00c4c1568912537e5.png" width="816" height="109" class="img_ev3q"></p>
<p>如果存在这个文件头，那么才会被当做已混淆的代码，进入解密流程，否则就直接使用原始 <code>zend_compile_file</code> 进行编译执行，所以想要解密文件，继  续跟入 <code>pm9screw_ext_fopen</code> 看看究竟是如何处理，这个函数同样不大。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">FILE </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">__fastcall </span><span class="token function" style="color:#d73a49">pm9screw_ext_fopen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">FILE </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">fp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> v1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// eax</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> st_size</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// ebp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> v3</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// r12d</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v4</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// rbx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// rsi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> v6</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// ecx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v7</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// r12</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  FILE </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// rbp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> newdatalen</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+Ch] [rbp-BCh] BYREF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  stat stat_buf</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [rsp+10h] [rbp-B8h] BYREF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fileno</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">__fxstat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">stat_buf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  st_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> stat_buf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">st_size</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v3 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">LODWORD</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stat_buf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">st_size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v4 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#d73a49">malloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">LODWORD</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stat_buf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">st_size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">fread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1uLL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">fclose</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> v3 </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    v5 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> v4</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      v6 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> st_size </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">st_size</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">++</span><span class="token plain">v5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v5 </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">LOBYTE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pm9screw_mycryptkey</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">v6 </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">^</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">~</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v5 </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> st_size </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v7 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">zdecode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">newdatalen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v8 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tmpfile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">fwrite</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v7</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> newdatalen</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1uLL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">free</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">free</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v7</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">rewind</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> v8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>加密原理就是非常简单的xor而已，那么我们需要关心的主要就是这个 <code>pm9screw_mycryptkey</code>。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">0000000000202128</span><span class="token plain">                 public pm9screw_mycryptkey</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">0000000000202128</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> __int16 pm9screw_mycryptkey</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">0000000000202128</span><span class="token plain"> pm9screw_mycryptkey dw </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">B90h</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">170</span><span class="token plain">h</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">C0h</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">501</span><span class="token plain">h</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">Eh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">0000000000202128</span><span class="token plain">                                         </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> DATA XREF</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> LOAD</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">0000000000000600</span><span class="token plain">↑o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">0000000000202128</span><span class="token plain">                                         </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">got</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">pm9screw_mycryptkey_ptr↑o</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在获取了对应的key后，就可以使用python对照着写一个解密脚本，使用效果如下：</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">decrypt_file</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">content</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    file_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">content</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    compress_data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&#x27;&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> file_size </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tmp_data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">bytearray</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">content</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">file_size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            tmp_data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ctypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c_ubyte</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">screw_key</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">file_size </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">^</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">~</span><span class="token plain">tmp_data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            file_size </span><span class="token operator" style="color:#393A34">-=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        compress_data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">bytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tmp_data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> zlib</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">decompress</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">compress_data</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="/assets/images/e19865df-4c77-4f1c-be97-cb10a97a2bbc-ae7f8cb91e56ec791df93d1f53a7f669.png" width="707" height="125" class="img_ev3q"></p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="四通用还原方法">四、通用还原方法<a href="#四通用还原方法" class="hash-link" aria-label="四、通用还原方法的直接链接" title="四、通用还原方法的直接链接">​</a></h2>
<p>上面这几种加密，其实只是对源码整体给压缩编码一下套层壳，实际上并没有改动代码本身，类似无扩展中 <code>eval(string)</code> 这样的加密，直接hook住 <code>compile_string</code> 就可以解开，这类实现网上已经非常多，比如使用如下的代码：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> len</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">copy</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">Z_TYPE_P</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">source_string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> IS_STRING</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">orig_compile_string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">source_string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> filename TSRMLS_CC</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">len  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Z_STRLEN_P</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">source_string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">copy </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">estrndup</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">Z_STRVAL_P</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">source_string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">len </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">strlen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">copy</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> c</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">len</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> c</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">copy</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> copy</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token char">&#x27;?&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">php_printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;----------decode----------\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">php_printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;%s\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> copy</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">php_printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;----------decode----------\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>编译并启用扩展后访问目标文件，针对phpjiami的解密效果如下所示：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/13917fc5-bfcb-48f0-a23a-46e676c2f18c-a6c6ed3b96de17d4fd9d5c36ea9b65c4.png" width="863" height="366" class="img_ev3q"></p>
<p>但是这种方法对于 <code>php-beast</code> 对整个文件做操作的加密显然不奏效，那么针对这种加密需要hook另一个地方，也就是 <code>compile_file</code>。</p>
<blockquote>
<p>不同php版本下的file_handle结构是不相同的，需要根据不同的版本做调整</p>
</blockquote>
<p>当前PHP版本（7.3.33） <code>file_handle</code> 结构如下：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">_zend_file_handle</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">union</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain">           fd</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		FILE          </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">fp</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		zend_stream   stream</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> handle</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain">        </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">filename</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	zend_string       </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">opened_path</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	zend_stream_type  type</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	zend_bool free_filename</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> zend_file_handle</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 我们可以使用这个函数，将内容写到buf中</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ZEND_API </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">zend_stream_fixup</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">zend_file_handle </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">file_handle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">size_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在hook的 <code>compile_file</code> 函数中，添加一段代码：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 需要在原始compile_file之后调用，否则文件内容仍然是加密后的</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">op_array </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">old_compile_file</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">file_handle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> type</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">size_t</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">zend_stream_fixup</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">file_handle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> SUCCESS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">php_printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;---------decode--------\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">php_printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;%s\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> buf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">php_printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;---------decode--------\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>针对 <code>php-beast</code> 的解密效果如下：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/5813e9b3-a72b-465d-b90d-419cc968b532-4305289ccc121d536ea16f18ab798985.png" width="906" height="408" class="img_ev3q"></p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="五扩展加密opcode">五、扩展加密（opcode）<a href="#五扩展加密opcode" class="hash-link" aria-label="五、扩展加密（opcode）的直接链接" title="五、扩展加密（opcode）的直接链接">​</a></h2>
<p>当混淆到了这个时候，扩展接管了编译这个过程，直接拿出完整的opcode交到zend执行，甚至会有自己魔改opcode后使用自定义的函数去执行，所以我们已经没有办法再使用上述流程通过hook <code>compile_file</code> 的方式来拿到加密之前的文件内容，能使用通用方式做到的最后一步，就是取到opcode然后通过各种方式对其进行还原，下面使用 <code>SourceGuardian</code> 作为例子。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="51-sourceguardian114">5.1 SourceGuardian11.4<a href="#51-sourceguardian114" class="hash-link" aria-label="5.1 SourceGuardian11.4的直接链接" title="5.1 SourceGuardian11.4的直接链接">​</a></h3>
<p>使用SourceGuardian11.4加密后的文件与原始文件对比：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/ec230d17-b294-40eb-8024-1bb3a61aad6b-22a947482f26611de939df96b56517f0.png" width="1536" height="979" class="img_ev3q"></p>
<p>由于SourceGuardian并不是通过hook <code>compile_file</code>、 <code>compile_string</code> 来实现源码保护的，所以我们需要找到一种新的办法，首先来看一看loader的处理流程，可以知道他肯定会处理一个sg_load的函数，当前以ixed.7.3.lin为例，将sg_load作为入口分析一下究竟做了什么操作。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">000000000021</span><span class="token plain">A7E0 off_21A7E0      dq offset aSgLoad       </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> DATA XREF</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">000000000021</span><span class="token plain">A988↓o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">000000000021</span><span class="token plain">A7E0                                         </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;sg_load&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">000000000021</span><span class="token plain">A7E8                 dq offset sub_9560</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">__int64 __fastcall </span><span class="token function" style="color:#d73a49">sub_9560</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__int64 a1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> __int64 a2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sub_6880</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> a2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在函数 <code>sub_6880</code> 中确实看到了处理的流程。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/a2299dee-c493-46d3-8053-02e877157c8b-3067d83da0691e2484604d050c8abfd2.png" width="1100" height="531" class="img_ev3q"></p>
<p>由于整个函数去了符号而且特别长，逆向难度稍大，但是不用管前面的流程，直接拉到函数末尾可以看到一个比较关键的地方。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> v304 </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">dword_21AD24 </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    executed_scope </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">zend_get_executed_scope</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dword_21AB98 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    v304</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> executed_scope</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">zend_execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__int64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">v304</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> a2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">destroy_op_array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v304</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_efree</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v304</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>zend_execute(v304, a2)</code> 以及 <code>destroy_op_array(v304)</code> ，也就是说 <code>v304</code> 这个变量是一个 <code>zend_op_array</code> 类型的值，所以理论上如果我们可以获取到 <code>v304</code> 这个值，那么也就可以通过阅读opcode来还原代码，继续看看php中关于 <code>zend_execute</code> 的处理。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression" style="color:#36acaa">Zend</span><span class="token macro property expression operator" style="color:#393A34">/</span><span class="token macro property expression" style="color:#36acaa">zend_vm_execute</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression" style="color:#36acaa">h</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ZEND_API </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">zend_execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">zend_op_array </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">op_array</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> zval </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">return_value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	zend_execute_data </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">execute_data</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">object_or_called_scope</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token class-name">uint32_t</span><span class="token plain"> call_info</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">EG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exception</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	object_or_called_scope </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">zend_get_this_object</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">EG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current_execute_data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">EXPECTED</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">object_or_called_scope</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		object_or_called_scope </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">zend_get_called_scope</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">EG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current_execute_data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		call_info </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ZEND_CALL_TOP_CODE </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> ZEND_CALL_HAS_SYMBOL_TABLE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		call_info </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ZEND_CALL_TOP_CODE </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> ZEND_CALL_HAS_SYMBOL_TABLE </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> ZEND_CALL_HAS_THIS</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# 分配zend_execute_data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	execute_data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">zend_vm_stack_push_call_frame</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">call_info</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">zend_function</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">op_array</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> object_or_called_scope</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	# 设置符号表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">EG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current_execute_data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		execute_data</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">symbol_table </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">zend_rebuild_symbol_table</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		execute_data</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">symbol_table </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token function" style="color:#d73a49">EG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">symbol_table</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">EX</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">prev_execute_data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">EG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current_execute_data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// execute_data-&gt;prev_execute_data = EG(current_execute_data)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">i_init_code_execute_data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">execute_data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> op_array</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> return_value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 初始化execute_data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">ZEND_OBSERVER_FCALL_BEGIN</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">execute_data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">zend_execute_ex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">execute_data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 执行opcode</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">/* Observer end handlers are called from ZEND_RETURN */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">zend_vm_stack_free_call_frame</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">execute_data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">//释放execute_data,销毁所有变量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在这里面使用 <code>op_array</code> 做了一些初始化 <code>execute_data</code> 的操作，最终调用 <code>zend_execute_ex</code> 这个函数，所以我  们可以直接hook住 <code>zend_execute_ex</code> 这个函数，在这其中来对 <code>execute_data</code> 这个值做一下dump操作就能获取到目标opcode，<code>execute_data</code> 结构如下：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">_zend_execute_data</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> zend_op       </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">opline</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic">/* executed opline                */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	zend_execute_data   </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">call</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">             </span><span class="token comment" style="color:#999988;font-style:italic">/* current call                   */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	zval                </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">return_value</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	zend_function       </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">func</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">             </span><span class="token comment" style="color:#999988;font-style:italic">/* executed function              */</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	zval                 This</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">             </span><span class="token comment" style="color:#999988;font-style:italic">/* this + call_info + num_args    */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	zend_execute_data   </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">prev_execute_data</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	zend_array          </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">symbol_table</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">void</span><span class="token plain">               </span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">run_time_cache</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">/* cache op_array-&gt;run_time_cache */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	zend_array          </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">extra_named_params</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">union</span><span class="token plain"> _zend_function </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	zend_uchar type</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">/* MUST be the first element of this struct! */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token class-name">uint32_t</span><span class="token plain">   quick_arg_flags</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		zend_uchar type</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/* never used */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		zend_uchar arg_flags</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* bitset of arg_info.pass_by_reference */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token class-name">uint32_t</span><span class="token plain"> fn_flags</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		zend_string </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">function_name</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		zend_class_entry </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">scope</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		zend_function </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">prototype</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token class-name">uint32_t</span><span class="token plain"> num_args</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token class-name">uint32_t</span><span class="token plain"> required_num_args</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		zend_arg_info </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">arg_info</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/* index -1 represents the return value info, if any */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		HashTable   </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">attributes</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> common</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	zend_op_array op_array</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	zend_internal_function internal_function</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>那么可以通过 <code>execute_data-&gt;func-&gt;op_array</code> 来获取到对应的opcode，但是 <code>zend_op_array</code> 这个结构比较大而且很复杂，如果自己来写解析会很麻烦，不过已经有人已经做过这个工作，可以直接在这个基础上进行修改，比如 VLD <a href="https://github.com/derickr/vld" target="_blank" rel="noopener noreferrer">https://github.com/derickr/vld</a>。</p>
<p>在vld中，作者本身就已经hook了两个函数 <code>compile_file</code> 和 <code>compile_string</code>，留下了一个没有代码块的空函数 <code>vld_execute_ex</code> 也就是我们的目标hook函数。在初始化过程中，vld开始hook三个函数，这里需要注意的是，只有当 <code>active=1</code> 且 <code>execute=0</code> 的时候，<code>zend_execute_ex</code> 才会被替换成 <code>vld_execute_ex</code>。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">PHP_RINIT_FUNCTION</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">vld</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	old_compile_file </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> zend_compile_file</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	old_compile_string </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> zend_compile_string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	old_execute_ex </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> zend_execute_ex</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">VLD_G</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">active</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		zend_compile_file </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> vld_compile_file</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		zend_compile_string </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> vld_compile_string</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token function" style="color:#d73a49">VLD_G</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">execute</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			zend_execute_ex </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> vld_execute_ex</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>直接在 <code>vld_execute_ex</code> 中来编写一下dump opcode的代码，这里可以直接将原本 <code>compile_file/string</code> 中的用法拿过来就好，有一点需要注意的是一些函数调用与回调情况，也会走到 <code>execute_ex</code>，如果直接在这里面不加任何条件在真实环境中使用，就会因为各种调用而跑飞掉，所以需要在这里面加一些限制，让他只输出目标文件的opcode。</p>
<p>但是又不能进入函数直接dump就返回，因为第一次调用到 <code>execute_ex</code> 一定是因为 <code>sg_load</code> ，这个时候dump出来仍然是加密后的不可读代码，那么可以在这里加一个标志位做一次判断，看是否第一次执行，如果是 的话那么让他正常走向原始 <code>execute_ex</code>，如果已经执行过一次，那么这时的opcode就是代码本身，取出 <code>execute_data-&gt;func-&gt;op_array</code> 然后使用 <code>vld_dump_oparray</code> dump出来，代码如下所示：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bool flag </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">vld_execute_ex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">zend_execute_data </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">execute_data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// nothing to do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">flag</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">vld_dump_oparray</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">execute_data</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">func</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">op_array TSRMLS_CC</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">zend_hash_apply_with_argument</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">CG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">function_table</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> TSRMLS_CC</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">apply_func_args_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#d73a49">VLD_WRAP_PHP7</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">vld_dump_fe</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">zend_hash_apply</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">CG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">class_table</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">apply_func_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#d73a49">VLD_WRAP_PHP7</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">vld_dump_cle</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> TSRMLS_CC</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	flag </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">old_execute_ex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">execute_data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>至此，我们就可以实现在运行时将代码执行的真实opcode给dump出来，如下所示：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/d94a61d7-dc1c-421d-88ed-cf8d72c832a0-54e92b80e6e536fd3587249d63e7e1b1.png" width="914" height="433" class="img_ev3q"></p>
<p>之后就需要将dump出来的opcode转换为原始php代码，所幸php中的opcode可读性很强，如果会写php，哪怕从没见过这些指令也能还原个七七八八。但是这个工作如果纯人工来做会比较费时费力，现在或许可以直接尝试使用gpt来帮助还原一下，比如当前这个文件的完整opcode如下，编写对应的prompt之后让gpt帮忙翻译一下：</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">filename:       /var/www/html/index.php</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">function name:  (null)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">number of ops:  10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">compiled vars:  none</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">line      #* E I O op                           fetch          ext  return  operands</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-------------------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    2     0  E &gt;   INIT_FCALL                                               &#x27;show_source&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          1        SEND_VAL                                                 &#x27;%2Fvar%2Fwww%2Fhtml%2Findex.php&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          2        DO_ICALL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    3     3        ECHO                                                     &#x27;%3Chr%2F%3E&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    4     4        INIT_FCALL                                               &#x27;system&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          5        SEND_VAL                                                 &#x27;uname+-a&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          6        DO_ICALL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    5     7        INIT_FCALL                                               &#x27;phpinfo&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          8        DO_ICALL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          9      &gt; RETURN                                                   1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">branch: #  0; line:     2-    5; sop:     0; eop:     9; out0:  -2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">path #1: 0,</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>gpt翻译结果如下，对于代码量不大且不是过分复杂的opcode相对来说能省去不少工作。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/e21b7451-02d1-40d7-b5c4-5e435c793859-38f96e53734080e2e072f933dd48bebb.png" width="1705" height="966" class="img_ev3q"></p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="六总结">六、总结<a href="#六总结" class="hash-link" aria-label="六、总结的直接链接" title="六、总结的直接链接">​</a></h2>
<p>文章介绍了一下目前工作中遇到的一些针对PHP的源码保护方案与对应的还原方法，文中所使用的例子其实破解成本都不算高，并且这三种方式的保护方案都有对应的通用还原方式，虽然从opcode还原至php代码略微麻烦。</p>
<p>目前市面上还有一些强度更高的保护方案，会对opcode做进一步的处理甚至直接是个VM，在选用保护方案时，可以尽可能考虑这类破解成本较高的方案。</p>
<p>如果对文中提到的三种场景感兴趣，可以参考对应docker镜像 <a href="https://github.com/sco4x0/php-decrypt-env" target="_blank" rel="noopener noreferrer">https://github.com/sco4x0/php-decrypt-env</a>。</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/php">PHP</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/TianGongLab/poc_docs/tree/main/blog/2024-01-24-common-PHP-source-code-protection-and-restoration/index.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="博文分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/tiangongarticle017"><div class="pagination-nav__sublabel">较新一篇</div><div class="pagination-nav__label">Terrapin 攻击分析</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/tiangongarticle015"><div class="pagination-nav__sublabel">较旧一篇</div><div class="pagination-nav__label">Server as Client 漏洞模型</div></a></nav><div style="margin-top:20px"></div></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#一前言" class="table-of-contents__link toc-highlight">一、前言</a></li><li><a href="#二无扩展加密" class="table-of-contents__link toc-highlight">二、无扩展加密</a><ul><li><a href="#21-phpjmnet" class="table-of-contents__link toc-highlight">2.1 phpjm.net</a></li><li><a href="#22-phpjiamicom" class="table-of-contents__link toc-highlight">2.2 phpjiami.com</a></li></ul></li><li><a href="#三-扩展加密源码混淆" class="table-of-contents__link toc-highlight">三、 扩展加密（源码混淆）</a><ul><li><a href="#31-php-beast" class="table-of-contents__link toc-highlight">3.1 php-beast</a></li><li><a href="#32-php-screw" class="table-of-contents__link toc-highlight">3.2 PHP Screw</a></li></ul></li><li><a href="#四通用还原方法" class="table-of-contents__link toc-highlight">四、通用还原方法</a></li><li><a href="#五扩展加密opcode" class="table-of-contents__link toc-highlight">五、扩展加密（opcode）</a><ul><li><a href="#51-sourceguardian114" class="table-of-contents__link toc-highlight">5.1 SourceGuardian11.4</a></li></ul></li><li><a href="#六总结" class="table-of-contents__link toc-highlight">六、总结</a></li></ul></div></div></div></div></div></div>
</body>
</html>