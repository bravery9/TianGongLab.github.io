<!doctype html>
<html lang="zh-Hans" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">FortiGate SSLVPN CVE-2024-21762漏洞利用分析 | 破壳漏洞挖掘平台</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://poc.qianxin.com/img/poc-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://poc.qianxin.com/img/poc-social-card.jpg"><meta data-rh="true" property="og:url" content="https://poc.qianxin.com/blog/tiangongarticle021"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="FortiGate SSLVPN CVE-2024-21762漏洞利用分析 | 破壳漏洞挖掘平台"><meta data-rh="true" name="description" content="一、漏洞简介"><meta data-rh="true" property="og:description" content="一、漏洞简介"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2024-03-13T00:00:00.000Z"><meta data-rh="true" property="article:tag" content="FortiGate,SSLVPN,CVE"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://poc.qianxin.com/blog/tiangongarticle021"><link data-rh="true" rel="alternate" href="https://poc.qianxin.com/blog/tiangongarticle021" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://poc.qianxin.com/blog/tiangongarticle021" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://M80RFF4T9F-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="破壳漏洞挖掘平台 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="破壳漏洞挖掘平台 Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="破壳漏洞挖掘平台" href="/opensearch.xml">
<script src="https://www.clarity.ms/tag/k257lj4y58"></script>
<script src="https://hm.baidu.com/hm.js?bd805f6d9db85a795e91b7f0e7038239" async></script><link rel="stylesheet" href="/assets/css/styles.2596aafb.css">
<script src="/assets/js/runtime~main.d7b99991.js" defer="defer"></script>
<script src="/assets/js/main.9cb50580.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://poc.qianxin.com" target="_blank" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/img/logo.svg" alt="破壳文档" class="nav-logo-class themedComponent_mlkZ themedComponent--light_NVdE" height="20" width="100"><img src="/img/logo.svg" alt="破壳文档" class="nav-logo-class themedComponent_mlkZ themedComponent--dark_xIcU" height="20" width="100"></div><b class="navbar__title text--truncate"></b></a><a class="navbar__item navbar__link tutorialClass" href="/">文档</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">博客</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/blog/tags">标签</a><a class="navbar__item navbar__link" href="/blog/archive">归档</a><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div><a href="https://poc.qianxin.com/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">破壳官网<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">所有文章</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle022">Windows hypervisor&amp;内核调试的几种常见/不常见方法</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/tiangongarticle021">FortiGate SSLVPN CVE-2024-21762漏洞利用分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle020">Ghidra脚本编写：从IR到反编译C</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle019">关于Linux内核条件竞争的探讨</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle018">WebAssembly安全研究总结</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle017">Terrapin 攻击分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle016">常见 PHP 源码保护与还原</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle015">Server as Client 漏洞模型</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle014">破壳分析：Linksys设备多个0-day漏洞</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle013">ESXi SLP漏洞复现</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle012">从传统到 AI 探讨 Webshell 检测攻防对抗</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle011">人与代码的桥梁-聊聊SAST</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle010">BMC 漏洞实例分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle009">CodeDom 漏洞模式与 SharePoint RCE</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle008">Datacon 2023 漏洞分析赛道赛题二官方题解</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle007">IoT 设备中的认证绕过漏洞分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle006">Exchange Server(CVE-2023-36439)远程代码执行漏洞分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle005">WAF防护绕过技巧分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle004">伪随机数问题浅析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle003">Windows内核竞态条件漏洞研究</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle002">Microsoft Hyper-V 虚拟 TPM 设备漏洞分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle001">CVE-2023-0179 Linux内核提权</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="https://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="一、漏洞简介"><header><h1 class="title_f1Hy" itemprop="headline">FortiGate SSLVPN CVE-2024-21762漏洞利用分析</h1><div class="container_mt6G margin-vert--md"><time datetime="2024-03-13T00:00:00.000Z" itemprop="datePublished">2024年3月13日</time> · <!-- -->阅读需 11 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><img class="avatar__photo" src="https://tiangonglab.github.io/img/authors/zbleet.jpg" alt="zbleet" itemprop="image"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">zbleet</span></div><small class="avatar__subtitle" itemprop="description">二进制安全、IoT安全、浏览器安全</small></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="一漏洞简介">一、漏洞简介<a href="#一漏洞简介" class="hash-link" aria-label="一、漏洞简介的直接链接" title="一、漏洞简介的直接链接">​</a></h2>
<p>FortiGate二月份发布版本更新，修复多个中高危漏洞，其中一个严重级别漏洞是SSL VPN的未授权越界写漏洞，<a href="https://www.fortiguard.com/psirt/FG-IR-24-015" target="_blank" rel="noopener noreferrer">漏洞预警</a>称该漏洞可能被在野利用。本文将介绍笔者分析利用该漏洞，实现远程代码执行的过程。</p>
<p><img decoding="async" loading="lazy" alt="https://www.fortiguard.com/psirt/FG-IR-24-015" src="/assets/images/6bdb4e46-ab48-410b-942d-feb7ab8a9468-0481067f848fe3802e27eb9d5481b1a1.png" width="1830" height="388" class="img_ev3q"></p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="二漏洞分析">二、漏洞分析<a href="#二漏洞分析" class="hash-link" aria-label="二、漏洞分析的直接链接" title="二、漏洞分析的直接链接">​</a></h2>
<p>本文漏洞分析使用的环境是<code>FGT_VM64-v7.4.2.F-build2571</code>。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="21-diff-patch">2.1 diff patch<a href="#21-diff-patch" class="hash-link" aria-label="2.1 diff patch的直接链接" title="2.1 diff patch的直接链接">​</a></h3>
<p>对修复版本的二进制进行对比（7.4.2和7.4.3），分析发现修复代码位于函数<code>sub_18F4980</code>(7.4.2)。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/fc05a1d1-3f31-4880-8cd4-f8b0f7b09090-5d55821ef1d689fb01c6c1c8e480b556.png" width="1973" height="1445" class="img_ev3q"></p>
<p>分析该函数不难发现，该函数逻辑是读取HTTP POST请求的body数据。同时根据<code>Transfer-Encoding</code>请求头判断是按照chunk格式读取，还是根据<code>Content-Length</code>读取。根据控制流图对比结果，存在两处代码修改：</p>
<ol>
<li>解析chunk格式时，调用<code>ap_getline</code>读取分块长度，检查<code>ap_getline</code>的返回值是否大于16，大于16认为是非法的chunk length。
<img decoding="async" loading="lazy" src="/assets/images/04b4cd7f-26a7-4edf-9170-5877a4faf85c-94377426a6766b3e5062f9372e8a86d2.png" width="2277" height="1221" class="img_ev3q"></li>
<li>读取chunk trailer时，写入<code>\r\n</code>的偏移<code>line_off</code>的赋值来源，修复前<code>line_off</code>的值来源于<code>*(_QWORD *)(a1 + 744)</code>，修复后<code>line_off</code>为<code>ap_getline</code>的返回值。
<img decoding="async" loading="lazy" src="/assets/images/08b6ccf8-ebc5-4f99-9ba1-22878906ed2a-b7413aaa8afd0151ad9a770be566d21f.png" width="2247" height="1249" class="img_ev3q"></li>
</ol>
<p>继续向前回溯，可以找到<code>*(_QWORD *)(a1 + 744)</code>的值正是第一处校验的chunk length字段的长度</p>
<p><img decoding="async" loading="lazy" src="/assets/images/5fa4e3f7-68fe-4c97-a28b-9416d587ca5c-0d8e9c8e2f6d1b435903d6efc2920f72.png" width="945" height="395" class="img_ev3q"></p>
<p>同时阅读代码可以得知，当chunk length字段经过hex解码后值为0时，就会进入到chunk trailer读取的逻辑。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="22-触发越界写">2.2 触发越界写<a href="#22-触发越界写" class="hash-link" aria-label="2.2 触发越界写的直接链接" title="2.2 触发越界写的直接链接">​</a></h3>
<p>经过对patch的分析，我们可以得到以下结论：</p>
<p>1、解析chunk时，如果chunk length字段hex解码后值为0，则开始chunk trailer的读取。</p>
<p>2、调用ap_getline读取chunk trailer后，会根据chunk length字段的长度向缓冲区中写入<code>\r\n</code>。</p>
<p>因此，如果chunk length字段传入很多个0，0的长度大于剩余缓冲区长度的1/2时，就会触发越界写入<code>\r\n</code>。通过调试可知目标缓冲区位于栈上（函数sub_1A111E0），偏移0x2028的位置保存了返回地址。如果在偏移0x202e的位置写入<code>\r\n</code>，当函数返回执行<code>ret</code>指令恢复rip时就会因地址非法产生崩溃。</p>
<p>Crash PoC：</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pkt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token triple-quoted-string string" style="color:#e3116c">b&quot;&quot;&quot;\</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">GET / HTTP/1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">Host: %s</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">Transfer-Encoding: chunked</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">%s\r\n%s\r\n\r\n&quot;&quot;&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hostname</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">encode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;0&quot;</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x202e</span><span class="token operator" style="color:#393A34">//</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;a&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssock </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> create_ssock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hostname</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> port</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssock</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pkt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssock</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">recv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">4096</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>崩溃现场：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/4bd85c58-3d36-4e25-ae9a-4da3a37bb345-d8ea67c849ca9aecd98b433f7b16b4f4.png" width="839" height="271" class="img_ev3q"></p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="三漏洞利用">三、漏洞利用<a href="#三漏洞利用" class="hash-link" aria-label="三、漏洞利用的直接链接" title="三、漏洞利用的直接链接">​</a></h2>
<p>通过分析漏洞成因可知，利用该漏洞可以实现栈上越界写<code>\r\n</code>两个字节，越界范围接近0x2000。由于写入的内容非常有限，无法通过直接劫持rip实现RCE。因此需要把目光放在栈上保存的内存指针上。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="31-失败的尝试">3.1 失败的尝试<a href="#31-失败的尝试" class="hash-link" aria-label="3.1 失败的尝试的直接链接" title="3.1 失败的尝试的直接链接">​</a></h3>
<p>比较容易想到的是劫持rbp，通过覆盖rbp的低字节，使rbp刚好指向可控的内存区域。当上一级函数返回执行<code>leave ret</code>指令时，就可以完全劫持rip。然而验证时发现即使覆盖了栈上的rbp，也无法劫持rsp和rip，甚至程序不会产生崩溃。继续向上回溯，找到<code>sub_1A111E0</code>的父函数<code>sub_1A26040</code>，该函数在返回时并没有调用<code>leave ret</code>来恢复rsp，而是直接<code>add rsp, 0x18</code>，因此无法达到预期的效果。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/5370cb70-0aea-4f0f-b030-f064d66d1e96-c71f1f37f39323a10264c36f6fda04d0.png" width="957" height="261" class="img_ev3q"></p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="32-寻找栈上的内存指针">3.2 寻找栈上的内存指针<a href="#32-寻找栈上的内存指针" class="hash-link" aria-label="3.2 寻找栈上的内存指针的直接链接" title="3.2 寻找栈上的内存指针的直接链接">​</a></h3>
<p>如上一小节看到的 那样，<code>sub_1A26040</code>函数在栈上保存了rbx、r12-r15五个寄存器的值，并在函数返回时恢复这些寄存器。继续向上回溯找到父函数<code>sub_1A27650</code>。可以看到r13中保存的正是参数<code>a1</code>。</p>
<p><img decoding="async" loading="lazy" src="/assets/images/78e4d666-bde7-41bf-a381-fb43d0ab59fc-37dea9956243c26dea895b655d62ef03.png" width="909" height="71" class="img_ev3q"></p>
<p><code>a1</code>是一个结构体指针，通过调试也可以看出栈上保存的<code>r13</code>是一个堆地址</p>
<p><img decoding="async" loading="lazy" src="/assets/images/832428aa-0e00-4304-8746-ad76f5b89f49-edcef5964fd3d3c3adf8ae33cdd2ab7e.png" width="857" height="167" class="img_ev3q"></p>
<p>如果通过越界写覆盖图中红色区域的内存，那么<code>sub_1A26040</code>函数返回时恢复r13寄存器，就可以篡改<code>a1</code>指针的值。如果能够对堆内存进行布局，使得a1指向提前布置好的内存区域，那么就可以劫持整个a1结构体。同时通过分析<code>sub_1A27650</code>和<code>sub_1A26040</code>的代码逻辑，其中存在大量a1多级结构体成员的动态函数调用，因此劫持a1会有更多的利用机会。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="33-劫持结构体">3.3 劫持结构体<a href="#33-劫持结构体" class="hash-link" aria-label="3.3 劫持结构体的直接链接" title="3.3 劫持结构体的直接链接">​</a></h3>
<p>根据设想，a1指针的低字节被覆盖成<code>\r\n</code>后，可以恰好指向预先布置好的内存。如图所示：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/7a2dc0e8-aa9f-4602-939a-4bd887f60af9-0402c9dc23ca6085a92e20b905b0e243.png" width="1327" height="819" class="img_ev3q"></p>
<p>为实现这一效果，需要达成如下条件：</p>
<ol>
<li>a1结构体地址比堆喷区域地址更高，并且二者间隔很小。</li>
<li><code>0x7fxxxxxxx0a0d</code>一定指向伪造的结构体。</li>
</ol>
<p>调试可以发现a1结构体的大小是0x730，根据jemalloc的对齐规则，会分配到0x800大小的堆块。0x800的堆块在请求处理的过程中并不常用，因此很容易把tcache中0x800的堆块耗尽，同时申请更多新的0x800的块，使得释放后进入tcache。堆喷也选择不常用的大小的堆块，使得新申请的堆块是连续的，同时与新申请的0x800距离较近；堆喷选择使用较大堆块，以保证其地址为0x800对齐，这样就很容易做到每一个伪造的结构体地址的低12比特为0xa0d；堆喷范围不小于0x10000，以保证<code>0x7fxxxxxxx0a0d</code>指向堆喷的区域。劫持后的效果如图：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/9aee4f58-faaf-4149-95c8-2e0021765428-b05963211233db3159c4b58315f0d7a8.png" width="957" height="663" class="img_ev3q"></p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="34-寻找可利用的多级指针">3.4 寻找可利用的多级指针<a href="#34-寻找可利用的多级指针" class="hash-link" aria-label="3.4 寻找可利用的多级指针的直接链接" title="3.4 寻找可利用的多级指针的直接链接">​</a></h3>
<p>通过上述操作，可实现a1结构体的劫持。梳理函数<code>sub_1A27650</code>和<code>sub_1A26040</code>的代码，其中存在多处a1结构体成员二级指针和三级指针的动态调用，例如：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/b70c38cc-2f67-41ea-a8ad-5171db378f60-f5fe88d74bcda4926b35f4e0b580d73e.png" width="1137" height="591" class="img_ev3q"></p>
<p>当满足<code>*(_BYTE *)(a1+0x20*(N+6)+0x10)&amp;6==0</code>(0 &lt; N &lt; 5)时，就会动态调用<code>*(__int64 (__fastcall **)(__int64))(*(_QWORD *)(*(_QWORD *)(a1 + 0x298)+0x70)+0xC0)(a1)</code>因此，需要把<code>a1 + 0x298</code>成员伪造成一个多级指针，最终指向我们想要调用的函数。由于目标二进制没有开启PIE保护，所以可以在目标二进制寻找符合条件的多级指针。分析  二进制，可以发现Rela重定位节中每一个条目的第一个字段都指向对应函数的GOT表地址。</p>
<p><img decoding="async" loading="lazy" alt="Rela重定位条目" src="/assets/images/bb4591c2-c265-465b-a297-355ffdd71ca6-f4ab02090099db9342af5244b3831380.png" width="1879" height="205" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="GOT表" src="/assets/images/dab807ff-e94c-4042-8f60-3e0ace738a7c-1b49595795399f4a7c2cdb9d3620b108.png" width="1591" height="203" class="img_ev3q"></p>
<p>因此，以<code>system</code>函数为例可以找到符合条件的多级指针</p>
<p><img decoding="async" loading="lazy" src="/assets/images/1858556a-64dd-4580-83e5-f18716e53675-81c895d3f77edec18988662f3fe963d3.png" width="749" height="95" class="img_ev3q"></p>
<p>在堆喷时，将结构体偏移0x298处的值改成<code>0x4368d0</code>就可以实现对system函数的调用，效果如下：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/c66a0187-d618-4812-ae16-71360387dcad-4f4e5a8437cd7c3e4c7a88774058ea97.png" width="1249" height="593" class="img_ev3q"></p>
<p>如图所示，动态调用的参数正是a1，指向的内存可控。到这里正常就可以利用system函数执行任意命令了。但是在FortiGate中，<code>/bin/sh</code>文件不具备执行命令的能力，因此使用system函数执行命令无法执行成功。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="35-劫持rip">3.5 劫持RIP<a href="#35-劫持rip" class="hash-link" aria-label="3.5 劫持RIP的直接链接" title="3.5 劫持RIP的直接链接">​</a></h3>
<p>由于system函数无法执行命令，只能再想别的办法完成RCE。现有的条件是可以调用任意的GOT表函数，函数的第一个参数指向的内存可控，所以如果GOT表中存在某个函数会回调参数中的某个成员，就有机会实现RIP劫持。很容易想到在以前的FortiGate漏洞利用中经常使用到的函数<code>SSL_do_handshake</code>。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SSL_do_handshake</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SSL </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">method</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">ssl_renegotiate_check</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">SSL_in_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SSL_in_before</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">mode </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> SSL_MODE_ASYNC</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ASYNC_get_current_job</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">ssl_async_args</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            args</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">s </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ssl_start_async_job</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ssl_do_handshake_intern</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> s</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">handshake_func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ret</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>只需要构造SSL结构体，使得满足条件，最终调用<code>s-&gt;handshake_func(s)</code>，就可以实现rip劫持，把rip劫持到0xdeadbeef如图：</p>
<p><img decoding="async" loading="lazy" src="/assets/images/8ee4d24b-c6bf-406c-b760-9158b0e56d2a-24ae5943089e4899e2aea04ecea48848.png" width="1283" height="507" class="img_ev3q"></p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="36-rop">3.6 ROP<a href="#36-rop" class="hash-link" aria-label="3.6 ROP的直接链接" title="3.6 ROP的直接链接">​</a></h3>
<p>FortiGate主程序是一个All in One的二进制，大小已超过70MB，有大量的gadget可以利用，利用ROP实现RCE并不困难，不再赘述。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="四利用演示">四、利用演示<a href="#四利用演示" class="hash-link" aria-label="四、利用演示的直接链接" title="四、利用演示的直接链接">​</a></h2>
<p>尽管7.4.2版本SSL VPN默认已关闭web mode，浏览器访问返回403，但是该漏洞仍然可以在默认配置下完成利用。</p>
<p><a href="/assets/files/ea0543c3-963a-4213-b48c-140a4bd46be9-b43413449c565ce0732b3e379a3a48c0.mp4" target="_blank">cve-2024-21762.mp4 1920x1080</a></p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="五总结">五、总结<a href="#五总结" class="hash-link" aria-label="五、总结的直  接链接" title="五、总结的直接链接">​</a></h2>
<p>该漏洞与去年的<code>CVE-2023-27997</code>XOR导致的堆溢出漏洞类似，都是看起来比较鸡肋的溢出漏洞，利用过程比较Trick，更像是一道CTF题目。但是与传统攻击堆管理器的CTF题目相比，真实漏洞更多的需要借助上下文的结构体和代码逻辑完成利用。笔者水平有限，如有纰漏，欢迎指正。</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/forti-gate">FortiGate</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/sslvpn">SSLVPN</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/cve">CVE</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/TianGongLab/poc_docs/tree/main/blog/2024-03-13-fortigate-sslvpn-cve-2024-21762/index.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="博文分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/tiangongarticle022"><div class="pagination-nav__sublabel">较新一篇</div><div class="pagination-nav__label">Windows hypervisor&amp;内核调试的几种常见/不常见方法</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/tiangongarticle020"><div class="pagination-nav__sublabel">较旧一篇</div><div class="pagination-nav__label">Ghidra脚本编写：从IR到反编译C</div></a></nav><div style="margin-top:20px"></div></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#一漏洞简介" class="table-of-contents__link toc-highlight">一、漏洞简介</a></li><li><a href="#二漏洞分析" class="table-of-contents__link toc-highlight">二、漏洞分析</a><ul><li><a href="#21-diff-patch" class="table-of-contents__link toc-highlight">2.1 diff patch</a></li><li><a href="#22-触发越界写" class="table-of-contents__link toc-highlight">2.2 触发越界写</a></li></ul></li><li><a href="#三漏洞利用" class="table-of-contents__link toc-highlight">三、漏洞利用</a><ul><li><a href="#31-失败的尝试" class="table-of-contents__link toc-highlight">3.1 失败的尝试</a></li><li><a href="#32-寻找栈上的内存指针" class="table-of-contents__link toc-highlight">3.2 寻找栈上的内存指针</a></li><li><a href="#33-劫持结构体" class="table-of-contents__link toc-highlight">3.3 劫持结构体</a></li><li><a href="#34-寻找可利用的多级指针" class="table-of-contents__link toc-highlight">3.4 寻找可利用的多级指针</a></li><li><a href="#35-劫持rip" class="table-of-contents__link toc-highlight">3.5 劫持RIP</a></li><li><a href="#36-rop" class="table-of-contents__link toc-highlight">3.6 ROP</a></li></ul></li><li><a href="#四利用演示" class="table-of-contents__link toc-highlight">四、利用演示</a></li><li><a href="#五总结" class="table-of-contents__link toc-highlight">五、总结</a></li></ul></div></div></div></div></div></div>
</body>
</html>