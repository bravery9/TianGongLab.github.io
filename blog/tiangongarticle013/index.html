<!doctype html>
<html lang="zh-Hans" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.1">
<title data-rh="true">ESXi SLP漏洞复现 | 破壳漏洞挖掘平台</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://poc.qianxin.com/img/poc-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://poc.qianxin.com/img/poc-social-card.jpg"><meta data-rh="true" property="og:url" content="https://poc.qianxin.com/blog/tiangongarticle013"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="ESXi SLP漏洞复现 | 破壳漏洞挖掘平台"><meta data-rh="true" name="description" content="一、前言"><meta data-rh="true" property="og:description" content="一、前言"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2024-01-03T00:00:00.000Z"><meta data-rh="true" property="article:tag" content="VMware,ESXi,SLP"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://poc.qianxin.com/blog/tiangongarticle013"><link data-rh="true" rel="alternate" href="https://poc.qianxin.com/blog/tiangongarticle013" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://poc.qianxin.com/blog/tiangongarticle013" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://M80RFF4T9F-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="破壳漏洞挖掘平台 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="破壳漏洞挖掘平台 Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="破壳漏洞挖掘平台" href="/opensearch.xml">
<script src="https://www.clarity.ms/tag/k257lj4y58"></script>
<script src="https://hm.baidu.com/hm.js?bd805f6d9db85a795e91b7f0e7038239" async></script><link rel="stylesheet" href="/assets/css/styles.5ed708aa.css">
<script src="/assets/js/runtime~main.c3998473.js" defer="defer"></script>
<script src="/assets/js/main.4b03e371.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://poc.qianxin.com" target="_blank" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/img/logo.svg" alt="破壳文档" class="nav-logo-class themedComponent_mlkZ themedComponent--light_NVdE" height="20" width="100"><img src="/img/logo.svg" alt="破壳文档" class="nav-logo-class themedComponent_mlkZ themedComponent--dark_xIcU" height="20" width="100"></div><b class="navbar__title text--truncate"></b></a><a class="navbar__item navbar__link tutorialClass" href="/">文档</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">博客</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/blog/tags">标签</a><a class="navbar__item navbar__link" href="/blog/archive">归档</a><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div><a href="https://poc.qianxin.com/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">破壳官网<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">所有文章</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle017">Terrapin 攻击分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle016">常见 PHP 源码保护与还原</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle015">Server as Client 漏洞模型</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle014">破壳分析：Linksys设备多个0-day漏洞</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/tiangongarticle013">ESXi SLP漏洞复现</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle012">从传统到 AI 探讨 Webshell 检测攻防对抗</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle011">人与代码的桥梁-聊聊SAST</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle010">BMC 漏洞实例分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle009">CodeDom 漏洞模式与 SharePoint RCE</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle008">Datacon 2023 漏洞分析赛道赛题二官方题解</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle007">IoT 设备中的认证绕过漏洞分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle006">Exchange Server(CVE-2023-36439)远程代码执行漏洞分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle005">WAF防护绕过技巧分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle004">伪随机数问题浅析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle003">Windows内核竞态条件漏洞研究</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle002">Microsoft Hyper-V 虚拟 TPM 设备漏洞分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle001">CVE-2023-0179 Linux内核提权</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="https://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="一、前言"><header><h1 class="title_f1Hy" itemprop="headline">ESXi SLP漏洞复现</h1><div class="container_mt6G margin-vert--md"><time datetime="2024-01-03T00:00:00.000Z" itemprop="datePublished">2024年1月3日</time> · <!-- -->阅读需 13 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><img class="avatar__photo" src="https://tiangonglab.github.io/img/authors/S1duku.jpg" alt="S1duku" itemprop="image"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">S1duku</span></div><small class="avatar__subtitle" itemprop="description">GeekCon2023 参赛选手</small></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="一前言">一、前言<a href="#一前言" class="hash-link" aria-label="一、前言的直接链接" title="一、前言的直接链接">​</a></h2>
<p>关于SLP几个漏洞的成因与利用，网上已经有彭博士非常精彩且详细的分享（<a href="https://github.com/knownsec/KCon/blob/master/2023/vSphere%20%E6%94%BB%E9%98%B2%E6%8A%80%E6%B3%95%E5%88%86%E4%BA%AB.pdf" target="_blank" rel="noopener noreferrer">vSphere 攻防技法分享</a>），这里不会做过多的赘述，写这个的意义只是记录一下针对特定低版本ESXi场景下32位SLP的利用心路。网上的一些公开利用，在低版本情况下皆无法成功。</p>
<p>安全研究人员在对某个目标进行研究时，经常会遇到一个场景，研究人员在一个正在开发的功能中发现漏洞，但因此功能未完善，无法进一步利用的遗憾。</p>
<p>笔者遇到的正是类似于此类场景，不过不是正在开发的功能场景，而是一个漏洞的触发路径上存在另一个漏洞，两个漏洞的相互影响下，导致利用无法完成的悲伤。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="二slp历史漏洞">二、SLP历史漏洞<a href="#二slp历史漏洞" class="hash-link" aria-label="二、SLP历史漏洞的直接链接" title="二、SLP历史漏洞的直接链接">​</a></h2>
<p>以下是SLP的历年漏洞</p>
<table><thead><tr><th><strong>CVE编号</strong></th><th><strong>漏洞类型</strong></th></tr></thead><tbody><tr><td>CVE-2019-5544</td><td>堆溢出</td></tr><tr><td>CVE-2020-3992</td><td>UAF</td></tr><tr><td>CVE-2021-21974</td><td>堆溢出</td></tr><tr><td>CVE-2022-31699</td><td>堆溢出</td></tr></tbody></table>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="三cve-2021-21974漏洞利用">三、CVE-2021-21974漏洞利用<a href="#三cve-2021-21974漏洞利用" class="hash-link" aria-label="三、CVE-2021-21974漏洞利用的直接链接" title="三、CVE-2021-21974漏洞利用的直接链接">​</a></h2>
<p>笔者最初选择的是CVE-2021-21974。</p>
<p>该漏洞存在于SLP的“目录代理通告”，目录代理 (DA) 是可选的 SLP 代理，用于存储和维护服务代理 (SA) 发送的服务广告的缓存。</p>
<p><img loading="lazy" src="/assets/images/2023031310314073-048aa3922f60bfd4e26e716b9ee55a98.jpg" width="706" height="438" class="img_ev3q"></p>
<p>在<code>SLPParseSrvUrl</code>函数中，会解析“目录代理通告”中的URL字段，如下面代码所示</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/* allocate space for structure + srvurl + longest net family tag */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">parsedurl </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SLPParsedSrvUrl </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#d73a49">xmalloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SLPParsedSrvUrl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> SLP_NF_MAX_SIZE    </span><span class="token comment" style="color:#999988;font-style:italic">/* long enough for longest net family */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> srvurllen </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* +1 for null-terminator */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">parsedurl </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ENOMEM</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">/* point to family tag buffer, copy url to buffer space */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">parsedurl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">family </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">parsedurl </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SLPParsedSrvUrl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   slider1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> slider2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">parsedurl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">family </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> SLP_NF_MAX_SIZE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token function" style="color:#d73a49">memcpy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">slider1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> srvurl</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> srvurllen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">/* find end and terminate url copy */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   endptr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> slider1 </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> srvurllen</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">endptr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">/* parse out the service type */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">parsedurl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">srvtype </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> slider1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   slider2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">strstr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">slider1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;://&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">slider2 </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">xfree</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">parsedurl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">parsedurl </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> EINVAL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">/* ill-formatted URL - missing &quot;://&quot; */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>问题出现在 <code>slider2 = strstr(slider1, &quot;://&quot;)</code></p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="31-漏洞分析">3.1 漏洞分析<a href="#31-漏洞分析" class="hash-link" aria-label="3.1 漏洞分析的直接链接" title="3.1 漏洞分析的直接链接">​</a></h3>
<p>要分析这个问题，先从wireshark的抓包看起，下图是发生“目录代理通告”时捕获的数据包</p>
<p><img loading="lazy" src="/assets/images/3b2059e3-4f8e-408a-8c0c-649a183e3bd1-ccd9ac1ef9a5afdc65e2f08908bb2e2c.png" width="1897" height="295" class="img_ev3q"></p>
<p>重点关注<code>Scope List Length</code>字段，该字段的大小被定义为uint16，且紧跟在URL字段后面。</p>
<p>带着这些知识，来分析<code>slider2 = strstr(slider1, &quot;://&quot;)</code>的问题所在。</p>
<p><code>slider2 = strstr(slider1, &quot;://&quot;)</code>的本意是解析URL字段，获取<code>://</code>后面的内容。</p>
<p>URL的正常构造示例：<code>service:daytime://www.mtjones.com</code></p>
<p>此时假设一个情况，如果发包时URL字段不带有<code>://</code>，且<code>Scope List Length</code>字段的值小于0x100。<code>slider2 = strstr(slider1, &quot;://&quot;)</code>遍历完URL后遇到<code>Scope List Length</code>的\x00，将\x00视为URL字段的终止符，<code>strstr</code>函数结束，未找到目标字符串，返回空。</p>
<p>如果<code>Scope List Length</code>字段的值大于0x100，<code>strstr</code>函数就会搜寻到<code>Scope List Length</code>字段甚至<code>Scope List</code>字段，在箭头所指的地方产生越界写</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  v4 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">calloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1u</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> srvurllen </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">29</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">v4 </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v5 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">strstr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">srvurl</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;:/&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v21 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> v5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">v5 </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">free</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  v6 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">srvurl</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">srvurllen</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  haystack </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v5 </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> srvurl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">memcpy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">v4 </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">21</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> srvurl</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v5 </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> srvurl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">-</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到  剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="32-悲剧的诞生">3.2 悲剧的诞生<a href="#32-悲剧的诞生" class="hash-link" aria-label="3.2 悲剧的诞生的直接链接" title="3.2 悲剧的诞生的直接链接">​</a></h3>
<p>在走完有漏洞的<code>SLPParseSrvUrl</code>函数后，紧跟着的是下面代码所示的<code>SLPNetResolveHostToAddr</code>，该函数大意是将&quot;<a href="http://www.test.com" target="_blank" rel="noopener noreferrer">www.test.com</a>&quot;之类的转为IP，这个Host从上述的<code>URL</code>字段中获取</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#d73a49">SLPParseSrvUrl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a1</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">43</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> char </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">a1</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">44</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">ptr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    goto </span><span class="token constant" style="color:#36acaa">LABEL_3</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#d73a49">SLPNetResolveHostToAddr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_DWORD </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">ptr </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v14</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">free</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ptr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token spread operator" style="color:#393A34">...</span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>正常URL如下</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">示例：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">URL为service:daytime://www.mtjones.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">则获取www.mtjones.com作为参数传入</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>很不幸，此时触发漏洞需要的URL不是正常的构造，要想触发漏洞且进行正常利用，需要满足以下几个条件：</p>
<ol>
<li><code>Scope List Length</code>需要大于等于0x100</li>
<li><code>Scope List</code>中<code>&quot;://&quot;</code>出现的位置不能过于后面，不然会导致越界写入过多的内存，破坏下一个堆的结构</li>
</ol>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SLP的处理代码简化为：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">v4 = calloc(1u, srvurllen + 0x1D);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">v5 = strstr(srvurl, &quot;:/&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">memcpy((char *)v4 + 0x15, srvurl, v5 - srvurl);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">示例：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">srvurl = b&#x27;A&#x27; * 24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scope_list = b&#x27;B&#x27; * 13 + struct.pack(&#x27;&lt;H&#x27;, size + flag) + b&#x27;:/&#x27; + b&#x27;C&#x27; * 647</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">会产生0x38的堆块(32位下)，0x15+24+13+2=0x3c，下一个位置刚好是下一个堆块的size位</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这就构成了一个悖论，要想利用，<code>Scope List Length</code>必须&gt;=0x100，要想&gt;=0x100，&quot;://&quot;后的数据要足够长，数据足够长又导致无法通过<code>SLPNetResolveHostToAddr</code>，导致程序执行流转入下面所示的<code>LABEL_3</code>中进行<code>SLPBufferFree</code>（还有一种可能是申请一个足够长的域名，携带在&quot;://&quot;后进行解析，但是在实战中，有泄露信息的风险，这里不予考虑）</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">LABEL_3</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">SLPMessageFree</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">SLPBufferFree</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">SLPDatabaseClose</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v12</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LABEL_4</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">HIDWORD</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__readgsdword</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x14u</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">^</span><span class="token plain"> v15</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">LODWORD</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> v2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>接着又在下面进行了一次<code>SLPBufferFree</code>，构成了无法避免的，完美的Double Free</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> v21</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> v21</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">v5 </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">goto</span><span class="token plain"> LABEL_27</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        v17 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> v3</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        v3 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        v20 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> v7</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">SLPBufferFree</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v17</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        v7 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> v20</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">SLPMessageFree</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v7</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在稍微高一点的版本中进行了内部修复，在进行第一次<code>SLPBufferFree</code>后对指针进行了置零操作</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="四cve-2019-5544漏洞利用">四、CVE-2019-5544漏洞利用<a href="#四cve-2019-5544漏洞利用" class="hash-link" aria-label="四、CVE-2019-5544漏洞利用的直接链接" title="四、CVE-2019-5544漏洞利用的直接链接">​</a></h2>
<p>换个洞，开始第二次利用尝试，这次选择CVE-2019-5544</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="41-漏洞分析">4.1 漏洞分析<a href="#41-漏洞分析" class="hash-link" aria-label="4.1 漏洞分析的直接链接" title="4.1 漏洞分析的直接链接">​</a></h3>
<p><strong>Service Registration报文</strong></p>
<p>该报文旨在注册相应的服务</p>
<p><img loading="lazy" src="/assets/images/5463c7b1-126f-450b-9aa6-1d441637b08b-b35a46c19a0c2a7156721f6f01255290.png" width="686" height="364" class="img_ev3q"></p>
<p><strong>Service Request报文</strong></p>
<p>该报文旨在定位服务并查询他们的信息</p>
<p><img loading="lazy" src="/assets/images/44ee70a9-cc07-43ea-839d-1bfcd20ad560-43b883c76f9efcc5d3fa0136687ccc9f.png" width="749" height="367" class="img_ev3q"></p>
<p>正常交互逻辑是，先向SLP发送Service Registration报文，在SLP中注册某类服务。后续如果有用户想要查询该服务信息，就向SLP发送Service Request报文进行查询。而漏洞就诞生在向SLP进行查询时候的处理。</p>
<p>SLP会重新定义返回的信息包大小，该大小由你发送Service Request报文的langtaglen字段决定</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/* reallocate the result buffer */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SLPBufferRealloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      errorcode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> SLP_ERROR_INTERNAL_ERROR</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">goto</span><span class="token plain"> FINISHED</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>接着根据Service Request报文中请求的服务在SLPDataBase中查找，看该服务是否已经被注册，如果被注册就取出、读取服务信息到返回包中。</p>
<p>但很不幸，读取服务信息这一操作的读取大小，是由注册时服务的urllen决定的，其没有校验服务的urllen大小与返回包大小之间的差异。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">PutUINT16</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">result</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">curpos</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> db</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">urlcount</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> db</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">urlcount</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic">/* urlentry is the url from the db result */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         urlentry </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> db</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">urlarray</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">ifdef</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression" style="color:#36acaa">ENABLE_SLPv1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">urlentry</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">opaque </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">/* url-entry reserved */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">result</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">curpos</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">/* url-entry lifetime */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">PutUINT16</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">result</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">curpos</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> urlentry</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">lifetime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">/* url-entry urllen */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">PutUINT16</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">result</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">curpos</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> urlentry</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">urllen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">/* url-entry url */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">memcpy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">curpos</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> urlentry</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">url</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> urlentry</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">urllen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            result</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">curpos </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> urlentry</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">urllen</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">/* url-entry auths */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">result</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">curpos</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="42-漏洞利用">4.2 漏洞利用<a href="#42-漏洞利用" class="hash-link" aria-label="4.2 漏洞利用的直接链接" title="4.2 漏洞利用的直接链接">​</a></h3>
<p>此部分很大程度上参考彭博士的利用手法，但不完全相同</p>
<p><strong>思路</strong></p>
<ol>
<li>泄露libc</li>
<li>布局出任意写</li>
<li>通过任意写覆写free_hook</li>
</ol>
<p><strong>清理内存碎片</strong></p>
<p>发送大量SLP的Service Request报文清理碎片</p>
<p><strong>泄露libc</strong></p>
<p>和彭博士的手法一样，要注意的是，在布局SLP SendBuffer和RecvBuffer的同时，也要一并布局SLPSocket结构体，在目标堆被放入LargeBin时立马修改对应SLPSocket的状态，将其转变为<code>STREAM_WRITE_FIRST</code>，读回glibc地址</p>
<p><img loading="lazy" src="/assets/images/79f012af-959c-482c-b501-ebb9341d3fc1-0ba3baba186e9fa500bd34af7922ecbc.png" width="1271" height="432" class="img_ev3q"></p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">SOCKET_PENDING_IO</span><span class="token macro property" style="color:#36acaa">       </span><span class="token macro property expression number" style="color:#36acaa">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">SOCKET_LISTEN</span><span class="token macro property" style="color:#36acaa">           </span><span class="token macro property expression number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">SOCKET_CLOSE</span><span class="token macro property" style="color:#36acaa">            </span><span class="token macro property expression number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">DATAGRAM_UNICAST</span><span class="token macro property" style="color:#36acaa">        </span><span class="token macro property expression number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">DATAGRAM_MULTICAST</span><span class="token macro property" style="color:#36acaa">      </span><span class="token macro property expression number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">DATAGRAM_BROADCAST</span><span class="token macro property" style="color:#36acaa">      </span><span class="token macro property expression number" style="color:#36acaa">4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">STREAM_CONNECT_IDLE</span><span class="token macro property" style="color:#36acaa">     </span><span class="token macro property expression number" style="color:#36acaa">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">STREAM_CONNECT_BLOCK</span><span class="token macro property" style="color:#36acaa">    </span><span class="token macro property expression number" style="color:#36acaa">6</span><span class="token macro property expression" style="color:#36acaa">   </span><span class="token macro property expression operator" style="color:#393A34">+</span><span class="token macro property expression" style="color:#36acaa"> SOCKET_PENDING_IO</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">STREAM_CONNECT_CLOSE</span><span class="token macro property" style="color:#36acaa">    </span><span class="token macro property expression number" style="color:#36acaa">7</span><span class="token macro property expression" style="color:#36acaa">   </span><span class="token macro property expression operator" style="color:#393A34">+</span><span class="token macro property expression" style="color:#36acaa"> SOCKET_PENDING_IO</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">STREAM_READ</span><span class="token macro property" style="color:#36acaa">             </span><span class="token macro property expression number" style="color:#36acaa">8</span><span class="token macro property expression" style="color:#36acaa">   </span><span class="token macro property expression operator" style="color:#393A34">+</span><span class="token macro property expression" style="color:#36acaa"> SOCKET_PENDING_IO</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">STREAM_READ_FIRST</span><span class="token macro property" style="color:#36acaa">       </span><span class="token macro property expression number" style="color:#36acaa">9</span><span class="token macro property expression" style="color:#36acaa">   </span><span class="token macro property expression operator" style="color:#393A34">+</span><span class="token macro property expression" style="color:#36acaa"> SOCKET_PENDING_IO</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">STREAM_WRITE</span><span class="token macro property" style="color:#36acaa">            </span><span class="token macro property expression number" style="color:#36acaa">10</span><span class="token macro property expression" style="color:#36acaa">  </span><span class="token macro property expression operator" style="color:#393A34">+</span><span class="token macro property expression" style="color:#36acaa"> SOCKET_PENDING_IO</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">STREAM_WRITE_FIRST</span><span class="token macro property" style="color:#36acaa">      </span><span class="token macro property expression number" style="color:#36acaa">11</span><span class="token macro property expression" style="color:#36acaa">  </span><span class="token macro property expression operator" style="color:#393A34">+</span><span class="token macro property expression" style="color:#36acaa"> SOCKET_PENDING_IO</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">STREAM_WRITE_WAIT</span><span class="token macro property" style="color:#36acaa">       </span><span class="token macro property expression number" style="color:#36acaa">12</span><span class="token macro property expression" style="color:#36acaa">  </span><span class="token macro property expression operator" style="color:#393A34">+</span><span class="token macro property expression" style="color:#36acaa"> SOCKET_PENDING_IO</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在泄露libc时，涉及到修改SLPSocket，这是一个需要关注的点，修改操作破坏了SLPSocket链表的完整性，导致链表被断链，一些Socket连接无法被搜寻到，且无法产生新的Socket连接。</p>
<p>所以在任意写操作进行前，需要修复SLPSocket链表，使其恢复正常。</p>
<p>以下是SLPSocket链表结构、插入、使用代码</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">_SLPList</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   SLPListItem </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> head</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   SLPListItem </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> tail</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> count</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> SLPList</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">_SLPListItem</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">_SLPListItem</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> previous</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">_SLPListItem</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> next</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> SLPListItem</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">_SLPDSocket</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   SLPListItem listitem</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SLPListItem </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SLPListLinkHead</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SLPList </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> list</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SLPListItem </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> item</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   item</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">previous </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   item</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">next </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> list</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">head</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">list</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">head</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      list</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">head</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">previous </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> item</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   list</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">head </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> item</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">list</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">tail </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      list</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">tail </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> item</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   list</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> list</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">count </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> item</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SLPDOutgoingHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> fdcount</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SLPD_fdset </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> fdset</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   SLPDSocket </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> sock</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   sock </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SLPDSocket </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> G_OutgoingSocketList</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">head</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>SLPSocket链表插入是头插法，使用时从头部开始获取。</p>
<p>假设一共有30个SLPSocket连接，第十五号SLPSocket连接被修改，产生了断链，1号-14号连接就无法被搜寻到。很不幸的是，SLP连接的监听描述符是8，一旦断链，就无法再被寻找到，新连接也就无法接入。需要人为进行伪造，恢复功能，在设计利用时需要特别注意这一点。</p>
<p><strong>布局任意写</strong></p>
<p>CVE-2019-5544的任意写手法与彭博士介绍的手法稍有不同，该CVE的触发路径上有大量堆块的申请操作，其中包含一些大堆块的申请，要想再次保证目标堆块在unsorted bin中，需新创建大量连接进行布局。</p>
<p><img loading="lazy" src="/assets/images/8b200b24-dda8-4d32-ae89-bb6e92d68e3a-692db6eab034a82733c4895b0bfebec2.png" width="780" height="342" class="img_ev3q"></p>
<p>彭博士的手法更倾向实战，构造一个永久性的任意写，能多次使用。但理论上不考虑其他因素的话，只复现，拿shell，进行一次任意写即可完成。故笔者转变思路，使用堆溢出修改RecvBuf的start、curpos、end指向目标内存</p>
<p><img loading="lazy" src="data:image/png;base64,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" width="330" height="277" class="img_ev3q"></p>
<p>然后通过堆溢出修改该RecvBuf的SLPSocket，使其转为&quot;STREAM_READ&quot;状态，也就是等待用户的数据输入。此时用户往连接中发送payload即可在目标内存里修改。</p>
<p>最后通过SLP连接，构造一个带有shellcode的堆，将其释放即可完成利用。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="五总结">五、总结<a href="#五总结" class="hash-link" aria-label="五、总结的直接链接" title="五、总结的直接链接">​</a></h2>
<p>本文解析了CVE-2021-21974和CVE-2019-5544，并尝试在低版本ESXi上进行漏洞利用，利用本身并不复杂。在之后的版本中，VMware将ESXi中的SLP设置为默认关闭，使得SLP不再是一个研究优先度高的攻击面。</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/v-mware">VMware</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/es-xi">ESXi</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/slp">SLP</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/TianGongLab/poc_docs/tree/main/blog/2024-01-03-esxi-slp/index.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="博文分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/tiangongarticle014"><div class="pagination-nav__sublabel">较新一篇</div><div class="pagination-nav__label">破壳分析：Linksys设备多个0-day漏洞</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/tiangongarticle012"><div class="pagination-nav__sublabel">较旧一篇</div><div class="pagination-nav__label">从传统到 AI 探讨 Webshell 检测攻防对抗</div></a></nav><div style="margin-top:20px"></div></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#一前言" class="table-of-contents__link toc-highlight">一、前言</a></li><li><a href="#二slp历史漏洞" class="table-of-contents__link toc-highlight">二、SLP历史漏洞</a></li><li><a href="#三cve-2021-21974漏洞利用" class="table-of-contents__link toc-highlight">三、CVE-2021-21974漏洞利用</a><ul><li><a href="#31-漏洞分析" class="table-of-contents__link toc-highlight">3.1 漏洞分析</a></li><li><a href="#32-悲剧的诞生" class="table-of-contents__link toc-highlight">3.2 悲剧的诞生</a></li></ul></li><li><a href="#四cve-2019-5544漏洞利用" class="table-of-contents__link toc-highlight">四、CVE-2019-5544漏洞利用</a><ul><li><a href="#41-漏洞分析" class="table-of-contents__link toc-highlight">4.1 漏洞分析</a></li><li><a href="#42-漏洞利用" class="table-of-contents__link toc-highlight">4.2 漏洞利用</a></li></ul></li><li><a href="#五总结" class="table-of-contents__link toc-highlight">五、总结</a></li></ul></div></div></div></div></div></div>
</body>
</html>