<!doctype html>
<html lang="zh-Hans" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.1">
<title data-rh="true">人与代码的桥梁-聊聊SAST | 破壳漏洞挖掘平台</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://poc.qianxin.com/img/poc-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://poc.qianxin.com/img/poc-social-card.jpg"><meta data-rh="true" property="og:url" content="https://poc.qianxin.com/blog/tiangongarticle011"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="人与代码的桥梁-聊聊SAST | 破壳漏洞挖掘平台"><meta data-rh="true" name="description" content="0x00 前言"><meta data-rh="true" property="og:description" content="0x00 前言"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-12-20T00:00:00.000Z"><meta data-rh="true" property="article:tag" content="SAST"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://poc.qianxin.com/blog/tiangongarticle011"><link data-rh="true" rel="alternate" href="https://poc.qianxin.com/blog/tiangongarticle011" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://poc.qianxin.com/blog/tiangongarticle011" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://M80RFF4T9F-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="破壳漏洞挖掘平台 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="破壳漏洞挖掘平台 Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="破壳漏洞挖掘平台" href="/opensearch.xml">
<script src="https://www.clarity.ms/tag/k257lj4y58"></script>
<script src="https://hm.baidu.com/hm.js?bd805f6d9db85a795e91b7f0e7038239" async></script><link rel="stylesheet" href="/assets/css/styles.5ed708aa.css">
<script src="/assets/js/runtime~main.c3998473.js" defer="defer"></script>
<script src="/assets/js/main.4b03e371.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://poc.qianxin.com" target="_blank" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/img/logo.svg" alt="破壳文档" class="nav-logo-class themedComponent_mlkZ themedComponent--light_NVdE" height="20" width="100"><img src="/img/logo.svg" alt="破壳文档" class="nav-logo-class themedComponent_mlkZ themedComponent--dark_xIcU" height="20" width="100"></div><b class="navbar__title text--truncate"></b></a><a class="navbar__item navbar__link tutorialClass" href="/">文档</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">博客</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/blog/tags">标签</a><a class="navbar__item navbar__link" href="/blog/archive">归档</a><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div><a href="https://poc.qianxin.com/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">破壳官网<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">所有文章</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle017">Terrapin 攻击分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle016">常见 PHP 源码保护与还原</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle015">Server as Client 漏洞模型</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle014">破壳分析：Linksys设备多个0-day漏洞</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle013">ESXi SLP漏洞复现</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle012">从传统到 AI 探讨 Webshell 检测攻防对抗</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/tiangongarticle011">人与代码的桥梁-聊聊SAST</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle010">BMC 漏洞实例分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle009">CodeDom 漏洞模式与 SharePoint RCE</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle008">Datacon 2023 漏洞分析赛道赛题二官方题解</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle007">IoT 设备中的认证绕过漏洞分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle006">Exchange Server(CVE-2023-36439)远程代码执行漏洞分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle005">WAF防护绕过技巧分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle004">伪随机数问题浅析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle003">Windows内核竞态条件漏洞研究</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle002">Microsoft Hyper-V 虚拟 TPM 设备漏洞分析</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/tiangongarticle001">CVE-2023-0179 Linux内核提权</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="https://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="0x00 前言"><header><h1 class="title_f1Hy" itemprop="headline">人与代码的桥梁-聊聊SAST</h1><div class="container_mt6G margin-vert--md"><time datetime="2023-12-20T00:00:00.000Z" itemprop="datePublished">2023年12月20日</time> · <!-- -->阅读需 23 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><img class="avatar__photo" src="https://github.com/LoRexxar.png" alt="LoRexxar" itemprop="image"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">LoRexxar</span></div><small class="avatar__subtitle" itemprop="description">Vidar-Team，KunLun-M 作者</small></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="0x00-前言">0x00 前言<a href="#0x00-前言" class="hash-link" aria-label="0x00 前言的直接链接" title="0x00 前言的直接链接">​</a></h2>
<p>自从人类发明了工具开始，人类就在不断为探索如何更方便快捷的做任何事情，在科技发展的过程中，人类不断地试错，不断地思考，于是才有了现代伟大的科技时代。</p>
<p>在安全领域里，每个安全研究人员在研究的过程中，也同样的不断地探索着如何能够自动化的解决各个领域的安全问题。其中自动化代码审计就是安全自动化绕不过去的坎。</p>
<p>而SAST作为自动化代码分析的一种，有着其特有的定位以及作用，这篇文章我们就来聊聊静态分析的一些发展历程和思路。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>信息</div><div class="admonitionContent_BuS1"><p>SAST是什么？</p><p>ChatGPT：SAST是Static Application Security Testing（静态应用程序安全测试）的缩写。它是一种用于检测软件应用程序中潜在安全漏洞和代码缺陷的自动化安全测试方法。</p></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="0x01-静态代码分析工具">0x01 静态代码分析工具<a href="#0x01-静态代码分析工具" class="hash-link" aria-label="0x01 静态代码分析工具的直接链接" title="0x01 静态代码分析工具的直接链接">​</a></h2>
<p>静态代码分析我们可以理解为在不执行代码的情况下，通过静态的手段进行分析代码，并挖掘相应的漏洞/Bug.</p>
<p>再过去的十几年里，静态代码分析工具经历了长期的发展与演变过程，下面我们就一起回顾一下（下面的每个时期主要代表的相对的发展期，并不是比较绝对的诞生前后）：</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="上古时期---关键字匹配">上古时期 - 关键字匹配<a href="#上古时期---关键字匹配" class="hash-link" aria-label="上古时期 - 关键字匹配的直接链接" title="上古时期 - 关键字匹配的直接链接">​</a></h3>
<p>如果我问你“如果让你设计一个自动化代码审计工具，你会怎么设计？”，我相信，你一定会回答我，可以尝试通过匹配关键字。紧接着你也会迅速意识到通过关键字匹配的问题。</p>
<p>这里我们拿PHP做个简单的例子。</p>
<p><img loading="lazy" alt="img" src="/assets/images/1701679774214-526b064c-c7ac-4194-a52f-b6e2fe7d2242-5de5afb52e8dce347fde2ccbc20ea68a.png" width="1248" height="630" class="img_ev3q"></p>
<p>虽然我们匹配到了这个简单的漏洞，但是很快发现，事情并没有那么简单。</p>
<p><img loading="lazy" alt="img" src="/assets/images/1701679773906-d9338409-77b6-47e6-959a-aa2ea85081fd-36d45ce5052e9638e07ba54c68d79b71.png" width="1276" height="571" class="img_ev3q"></p>
<p>也许你说你可以通过简单的关键字重新匹配到这个问题</p>
<div class="language-plain codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plain codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">\beval\(\$</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>但是可惜的是，作为安全研究员，你永远没办法知道开发人员是怎么写代码的。于是选择用关键字匹配的你面临着两种选择：</p>
<ul>
<li><strong>高覆盖性 – 宁错杀不放过</strong></li>
</ul>
<p>这类工具最经典的就是Seay，通过简单的关键字来匹配经可能多的目标，之后使用者可以通过人工审计的方式进一步确认。</p>
<div class="language-plain codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plain codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">\beval\b\(</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li><strong>高可用性 – 宁放过不错杀</strong></li>
</ul>
<p>这类工具最经典的是Rips免费版</p>
<div class="language-plain codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plain codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">\beval\b\(\$_(GET|POST)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>用更多的正则来约束，用更多的规则来覆盖多种情况。这也是早期静态自动化代码审计工具普遍的实现方法。</p>
<p>但问题显而易见，高覆盖性和高可用性是这种实现方法永远无法解决的硬伤，不但维护成本巨大，而且误报率和漏报率也是居高不下。所以被时代所淘汰也是历史的必然。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="近代时期---基于ast的代码分析">近代时期 - 基于AST的代码分析<a href="#近代时期---基于ast的代码分析" class="hash-link" aria-label="近代时期 - 基于AST的代码分析的直接链接" title="近代时期 - 基于AST的代码分析的直接链接">​</a></h3>
<p>有人忽略问题，也有人解决问题。关键字匹配最大的问题是  在于你永远没办法保证开发人员的习惯，你也就没办法通过任何制式的匹配来确认漏洞，那么基于AST的代码分析方式就诞生了，开发人员是不同的，但编译器是相同的。</p>
<p>在分享这种原理之前，我们首先可以复习一下编译原理。拿PHP代码举例子：</p>
<p><img loading="lazy" alt="img" src="/assets/images/1701679774212-62a2e36c-cc3c-45b2-8b91-633229ccba57-2b1ef3c27c7e936c33e2fafd28791d36.png" width="1377" height="651" class="img_ev3q"></p>
<p>随着PHP7的诞生，AST也作为PHP解释执行的中间层出现在了编译过程的一环。</p>
<p><img loading="lazy" alt="img" src="/assets/images/1701679774217-c5e3596f-953f-4fc0-b05e-270dc382ca88-8dcc5ad3c533d00ddf8f8ea34620a3f7.png" width="1342" height="400" class="img_ev3q"></p>
<p>通过词法分析和语法分析，我们可以将任意一份代码转化为AST语法树。PHP常见的语义分析库可以参考：</p>
<ul>
<li><a href="https://github.com/nikic/PHP-Parser" target="_blank" rel="noopener noreferrer">PHP-Parser</a></li>
<li><a href="https://github.com/viraptor/phply" target="_blank" rel="noopener noreferrer">phply</a></li>
</ul>
<p>当我们得到了一份AST语法树之后，我们就解决了前面提到的关键字匹配最大的问题，至少我们现在对于不同的代码，都有了统一的AST语法树。如何对AST语法树做分析也就成了这类工具最大的问题。</p>
<p>在理解如何分析AST语法树之前，我们首先要明白<strong>infomation flow、source、sink</strong>三个概念，</p>
<ul>
<li><strong>source：</strong> 我们可以简单的称之为输入，也就是infomation flow的起点</li>
<li><strong>sink：</strong> 我们可以称之为输出，也就是infomation flow的终点</li>
<li><strong>infomation flow</strong>，则是指数据流动的过程。</li>
</ul>
<p>把这个概念放在PHP代码审计过程中，Source就是指用户可控的输入，比如$_GET、$_POST等，而Sink就是指我们要找到的敏感函 数，比如echo、eval，如果某一个Source到Sink存在一个完整的流，那么我们就可以认为存在一个可控的漏洞，这也就是基于infomation flow的代码审计原理。</p>
<p>在明白了基础原理的基础上，我举几个简单的例子：</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;?php</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$a = $_GET[‘a’];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eval($a);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这段代码对应的AST为：</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function maybe-class-name" style="color:#d73a49">Assignment</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function maybe-class-name" style="color:#d73a49">Variable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;$a&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token function maybe-class-name" style="color:#d73a49">ArrayOffset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function maybe-class-name" style="color:#d73a49">Variable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;$_GET&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;a&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token maybe-class-name">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function maybe-class-name" style="color:#d73a49">Eval</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function maybe-class-name" style="color:#d73a49">Variable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;$a&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>1、Eval函数</p>
<p>2、参数Variable(‘$a’)</p>
<p>3、Assignment函数</p>
<p>4、ArrayOffset</p>
<p>5、判断左值是不是Variable(‘$_GET’)</p>
<p>6、漏洞存在</p>
<p>在上面的分析过程中，Sink就是eval函数，Source就是<code>$_GET</code>，通过回溯Sink的来源，我们成功找到了一条流向Source的infomation flow，也就成功发现了这个漏洞。</p>
<p>在分析infomation flow的过程中，明确作用域是基础中的基础. 这也是分析infomation flow的关键，我们可以一起看看一段简单的代码</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;?php</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Function get($p){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> echo $p;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> return “echo 2333”;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$a = get($_GET[‘a’]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eval($a);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果我们很简单的跟踪赋值关系去回溯，而没有考虑到函数定义的话，我们很容易将流定义为：</p>
<p><img loading="lazy" src="data:image/png;base64,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" width="556" height="196" class="img_ev3q"></p>
<p>这样我们就错误的把这段代码定义成了存在漏洞，但很显然并不是，而正确的分析流程应该是这样的:</p>
<p><img loading="lazy" src="/assets/images/3be40dd8-5bbb-4218-b338-f03a32eb3024-c717e53514dfd3c2eb90625ee1761315.png" width="609" height="251" class="img_ev3q"></p>
<p>在这段代码中，从主语法树的作用域跟到Get函数的作用域，如何控制这个作用域的变动，就是基于AST语法树分析的一大难点，当我们在代码中不可避免的使用递归来控制作用域时，在多层递归中的统一标准也就成了分析的基础核心问题。</p>
<p>事实上，即便你做好了这个最简单的基础核心问题，你也会遇到层出不穷的问题。这里我举两个简单的例子</p>
<p><strong>(1) 新函数封装</strong></p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">?</span><span class="token plain">php</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$a </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> $_GET</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;a&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ee</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">$p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">eval</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">$p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ee</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">$a</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这是一段很经典的代码，敏感函数被封装成了新的敏感函数，参数是被二次传递的。为了解决，这样infomation flow的方向从逆向-&gt;正向的问题。</p>
<p>1、找到eval函数</p>
<p>2、获取当前语句所在作 用域</p>
<p>3、当前作用域为ee函数，并存在参数传递</p>
<p>4、ee被标记为新的敏感函数</p>
<p><strong>(2) 多重调用链</strong></p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> obj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">url</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token dom variable" style="color:#36acaa">location</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">hash</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">split</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;#&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">fruit</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">loc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">url</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">fruit</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> loc</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">eval</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">fruit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这是一段有漏洞的JS代码，人工的话很容易看出来问题。但是如果通过自动化的方式回溯参数的话就会发现整个流程中涉及到了多种流向。</p>
<p><img loading="lazy" src="/assets/images/8be0acc4-92d3-4b29-86fe-5ff5ebd6feaf-a5f5a8cce4b0923d780c01ab93030803.png" width="490" height="224" class="img_ev3q"></p>
<p>这里我用红色和黄色代表了流的两种流向。要解决这个问题只能通过针对类/字典变量的特殊回溯才能解决。</p>
<p>如果说，前面的两  个问题是可以被解决的话，还有很多问题是没办法被解决的，这里举一个简单的例子。</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;?php</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$_GET[&#x27;a&#x27;] = htmlspecialchars($_GET[&#x27;a&#x27;]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo $_GET[&#x27;a&#x27;];</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这是一个典型的全局过滤，人工审计可以很容易看出这里被过滤了。但是如果在自动化分析过程中，当回溯到Source为<code>$_GET[&#x27;a&#x27;]</code>时，已经满足了从Source到sink的infomation flow，已经被识别为漏洞。一个典型的误报就出现了。</p>
<p>而基于AST的自动化代码审计工具也正是在与这样的问题做博弈，对于基于AST的代码分析来说，最大的挑战在于没人能保证自己完美的处理所有的AST结构，再加上基于单向流的分析方式，无法应对100%的场景。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="基于ircfg的代码分析">基于IR/CFG的代码分析<a href="#基于ircfg的代码分析" class="hash-link" aria-label="基于IR/CFG的代码分析的直接链接" title="基于IR/CFG的代码分析的直接链接">​</a></h3>
<p>如果深度了解过基于AST的代码分析原理的话，不难发现许多弊端。首先AST是编译原理中IR/CFG的更上层，其AST中保存的内容更接近源代码。</p>
<p>也就是说，分析AST更接近分析代码，换句话就是说基于AST的分析得到的流，更接近脑子里对代码执行里的流程，忽略了大多数的分支、跳转、循环这类影响执行过程顺序的条件，这也是基于AST的代码分析的普遍解决方案，当然，从结果论上很难辨别忽略带来的后果。而基于IR/CFG这类带有控制流的解决方案，则是另一种解决思路。</p>
<p>首先我们得知道什么是IR/CFG。</p>
<ul>
<li><strong>IR：是一种</strong>类似于汇编语言的线性代码，其中各个指令按照顺序执行。其中现在主流的IR是三地址码（四元组）</li>
<li><strong>CFG: （Control flow graph）控制流图</strong>，在程序中最简单的控制流单位是一个基本块，在CFG中，每一个节点代表一个基本块，每一个边代表一个可控的控制转移，整个CFG代表了整个代码的的控制流程图。</li>
</ul>
<p>一般来说，我们需要遍历IR来生成CFG，当然，你也可以用AST来生成CFG，毕竟AST是比较高的层级。</p>
<p>而基于CFG的代码分析思路优势在于，对于一份代码来说，你首先有了一份控制流图（或者说是执行顺序），然后才到漏洞挖掘这一步。比起基于AST的代码分析来说，你只需要专注于从Source到Sink的过程即可。</p>
<p>但其实无论是基于哪种底层，后续的分析流程与AST其实别无太大的差别，挑战的核心  仍然维持在如何控制流，维持作用域，处理程序逻辑的分支过程，确认Source与Sink。但其实无论是基于哪种底层，后续的分析流程与AST其实别无太大的差别，挑战的核心仍然维持在如何控制流，维持作用域，处理程序逻辑的分支过程，确认Source与Sink。上文中提到的是静态分析当中比较常见的一种作用域数据流回溯分析的思路，其实正向的污点分析，亦或者后来被人提到比较多的指针分析，核心思路大同小异。</p>
<p>而代码分析的基础方面，既然存在基于AST的代码分析，又存在基于CFG的代码分析，自然也存在其他的种类。比如现在市场上主流的<u><a href="https://www.microfocus.com/zh-cn/cyberres/application-security/static-code-analyzer" target="_blank" rel="noopener noreferrer">fortify</a></u>，<u><a href="https://checkmarx.com/" target="_blank" rel="noopener noreferrer">Checkmarx</a></u>，<u><a href="https://scan.coverity.com/" target="_blank" rel="noopener noreferrer">Coverity</a></u>包括最新的<u><a href="https://www.sonarsource.com/" target="_blank" rel="noopener noreferrer">Rips</a></u>都使用了自己构造的语言的某一个中间部分，比如fortify和Coverity就需要对源码编译的某一个中间语言进行分析，又比如<u><a href="https://www.sourcebrella.com/" target="_blank" rel="noopener noreferrer">源伞</a></u>实现了多种语言生成统一的IR，Joern使用了基于AST生成的CPG图结构进行分析。</p>
<p>事实上，无论是基于某种基础结构的代码分析，技术手段本身只有适应场景的不同，对于技术选型这件事情本身来说更重要的是你想要构建一个什么样的代码分析工具。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="未来---通用化代码分析框架">未来 - 通用化代码分析框架<a href="#未来---通用化代码分析框架" class="hash-link" aria-label="未来 - 通用化代码分析框架的直接链接" title="未 来 - 通用化代码分析框架的直接链接">​</a></h3>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="基于ql概念的框架---codeql">基于QL概念的框架 - CodeQL<a href="#基于ql概念的框架---codeql" class="hash-link" aria-label="基于QL概念的框架 - CodeQL的直接链接" title="基于QL概念的框架 - CodeQL的直接链接">​</a></h4>
<p>QL指的是一种面向对象的查询语言，用于从关系数据库中查询数据的语言。我们常见的SQL就属于一种QL，一般用于查询存储在数据库中的数据。</p>
<p>而在代码分析领域，Semmle QL是最早诞生的QL语言，他最早被应用于LGTM，并被用于Github内置的安全扫描为大众免费提供。紧接着，CodeQL也被开发出来，作为稳定的代码分析框架在github社区化。</p>
<ul>
<li><a href="https://securitylab.github.com/tools/codeql" target="_blank" rel="noopener noreferrer">https://securitylab.github.com/tools/codeql</a></li>
<li><a href="https://semmle.com/codeql" target="_blank" rel="noopener noreferrer">https://semmle.com/codeql</a></li>
</ul>
<p>那么什么是QL呢？QL又和代码分析有什么关系呢？</p>
<p>首先我们回顾一下基于AST、CFG这类代码分析最大的特点是什么？无论是基于哪种中间件建立的代码分析流程，都离不开3个概念，流、Source、Sink，这类代码分析的原理无论是正向还是逆向，都是通过在Source和Sink中寻找一条流。而这条流的建立围绕的是代码执行的流程，就好像编译器编译运行一样，程序总是流式运行的。这种分析的方式就是数据流分析（Data Flow）。</p>
<p>而QL就是把这个流的每一个环节具象化，把每个节点的操作具像成状态的变化，并且储存到数据库中。</p>
<p>这样一来，通过构造QL语言，我们就能找到满足条件的节点，并构造成流。下面我举一个简单的例子来说：</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;?php</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$a = $_GET[&#x27;a&#x27;];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$b = htmlspecialchars($a);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo $b;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们简单的把前面的流写成一个表达式</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">echo =&gt; $_GET.is_filterxss</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这里is_filterxss被认为是输入$_GET的一个标记，在分析这类漏洞的时候，我们就可以直接用QL表达</p>
<div class="language-php codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-php codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">select * where {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Source : $_GET,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Sink : echo,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    is_filterxss : False,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>通过构造满足条件的语句，我们就可以找到这个漏洞（上面的代码仅为伪代码），从这样的一个例子我们不难发现，QL其实更接近一个概念，他鼓励将信息流具象化，这样我们就可以用更通用的方式去写规则筛选。</p>
<p>CodeQL类的工具(包括<u><a href="https://checkmarx.com/" target="_blank" rel="noopener noreferrer">CheckMarx</a></u>等等)其实就是类似的一个基础理念，通过封装底层的代码处理逻辑，并提供一个非常易用的上层平台给用户，用户可以不用了解复杂的编译原理就可以编写漏洞的规则。</p>
<p>但其实说到底这只是一个理念，并不是结果，以CodeQL为例子，其构建的一套语法规则并不能算是一套门槛很低的东西，反而其黑盒的底层阻止了安全研究人员进一步研究和使用CodeQL。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="基于工具化的框架---joern">基于工具化的框架 - Joern<a href="#基于工具化的框架---joern" class="hash-link" aria-label="基于工具化的框架 - Joern的直接链接" title="基于工具化的框架 - Joern的直接链接">​</a></h4>
<p>如果说CodeQL类的工具是探索做一个通用化的代码分析框架，来解决代码分析的场景。那<u><a href="https://joern.io/" target="_blank" rel="noopener noreferrer">Joern</a></u>就走了另一条路，就是工具化。</p>
<p>Joern的底层原理是一套基于AST生成的通用CPG(Code Property Graph)图，在图的上层实现了一套基于OverflowDb的查询语言以供使用者可以在不需要知晓底层原理的基础上查询分析。</p>
<p><img loading="lazy" alt="img" src="/assets/images/1701760495040-d55ffbee-7443-4be9-859a-b5e3879db2ab-cd824d8502b5c4e9aeaac9e9c40df3dd.png" width="2000" height="1125" class="img_ev3q"></p>
<p>但我们这里想讨论的并不是Joern的原理，而是理念。Joern把自己定位成了安全研究员用于代码分析的一个工具，而不是执着于用一个按钮一个规则扫描漏洞，而是提供了人和代码的桥梁。</p>
<p>在Joern里，我用的比较多，也是比较常见的一个场景就是寻找某个方法的调用关系。在Joern shell当中，你可以用非常简单的方法获取某个函数的调用位置，已经调用了该函数的函数。</p>
<p><img loading="lazy" alt="img" src="/assets/images/1701760918672-1bfe08ae-c728-41b6-bb60-d33d82a0ec83-6e54ea4ee22623f92c427e5054c7808b.png" width="2465" height="1336" class="img_ev3q"></p>
<p>所以在Joern当中，你可以忽略数据流分析，而是用一些非常简单的交互式命令来辅助，在Joern你可以非常简单的获取&quot;调用了A方法的路由入口&quot;，而更实际的利用链完全可以有人来判定，省去为了上下文分析花去的力气。</p>
<p>当然，Joern在某些方面是成也工具化败也工具化，cpg本身强调调用关系和引用关系，Joern shell后端引用scala易用性有余实用性不足，你几乎很难在Joern的上层做数据流分析层面的分析。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="0x02-总结">0x02 总结<a href="#0x02-总结" class="hash-link" aria-label="0x02 总结的直接链接" title="0x02 总结的直接链接">​</a></h2>
<p>其实相较第一版本的内容来说，我没有对文章内容做太多的更改，因为对于静态分析的底层原理来说用什么技术已经没什么很大的意义了，说到底原理都是差不多的。</p>
<p>商业代码分析的软件包括Checkmarx、Fortify等等，再到后来的CodeQL说到底其实都是技术长期积累的技术壁垒，很多问题也不是学术上的什么难点攻破。</p>
<p>而近几年越来越多的相关东西也如雨后春笋冒了出来，开源社区比较火的<a href="https://joern.io/" target="_blank" rel="noopener noreferrer">Joern</a>、<a href="https://github.com/wh1t3p1g/tabby" target="_blank" rel="noopener noreferrer">tabby</a>、<a href="https://github.com/pascal-lab/Tai-e" target="_blank" rel="noopener noreferrer">tai-e</a>，其实技术原理上的东西大同小异，说到底就是还没有足够好用的产品出来，大多代码分析的软件还停留在某个底层技术的应用上。</p>
<p>而代码分析工具本身的易用性和场景化遇到的问题在我看来问题更大，即便是商业化程度非常高的Checkmarx这种软件也没法非常简单直白的接入到devsecops流程当中，很多工具甚至都解决不了高误报率和扫描效率低的问题，更谈不上实用了。在我看来，一款实用的好的代码分析软件还有很长的路要走~</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="0x03-参考链接">0x03 参考链接<a href="#0x03-参考链接" class="hash-link" aria-label="0x03 参考链接的直接链接" title="0x03 参考链接的直接链接">​</a></h2>
<p>1、<a href="https://checkmarx.com/" target="_blank" rel="noopener noreferrer">checkmarx</a></p>
<p>2、<a href="https://joern.io/" target="_blank" rel="noopener noreferrer">joern</a></p>
<p>3、<a href="https://www.microfocus.com/zh-cn/cyberres/application-security/static-code-analyzer" target="_blank" rel="noopener noreferrer">https://www.microfocus.com/zh-cn/cyberres/application-security/static-code-analyzer</a></p>
<p>4、<a href="https://github.com/wh1t3p1g/tabby" target="_blank" rel="noopener noreferrer">tabby</a></p>
<p>5、<a href="https://github.com/pascal-lab/Tai-e" target="_blank" rel="noopener noreferrer">Tai-e</a></p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/sast">SAST</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/TianGongLab/poc_docs/tree/main/blog/2023-12-20-sast/index.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="博文分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/tiangongarticle012"><div class="pagination-nav__sublabel">较新一篇</div><div class="pagination-nav__label">从传统到 AI 探讨 Webshell 检测攻防对抗</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/tiangongarticle010"><div class="pagination-nav__sublabel">较旧一篇</div><div class="pagination-nav__label">BMC 漏洞实例分析</div></a></nav><div style="margin-top:20px"></div></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#0x00-前言" class="table-of-contents__link toc-highlight">0x00 前言</a></li><li><a href="#0x01-静态代码分析工具" class="table-of-contents__link toc-highlight">0x01 静态代码分析工具</a><ul><li><a href="#上古时期---关键字匹配" class="table-of-contents__link toc-highlight">上古时期 - 关键字匹配</a></li><li><a href="#近代时期---基于ast的代码分析" class="table-of-contents__link toc-highlight">近代时期 - 基于AST的代码分析</a></li><li><a href="#基于ircfg的代码分析" class="table-of-contents__link toc-highlight">基于IR/CFG的代码分析</a></li><li><a href="#未来---通用化代码分析框架" class="table-of-contents__link toc-highlight">未来 - 通用化代码分析框架</a></li></ul></li><li><a href="#0x02-总结" class="table-of-contents__link toc-highlight">0x02 总结</a></li><li><a href="#0x03-参考链接" class="table-of-contents__link toc-highlight">0x03 参考链接</a></li></ul></div></div></div></div></div></div>
</body>
</html>